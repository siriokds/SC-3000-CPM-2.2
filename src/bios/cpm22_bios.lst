ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 1.
Hexadecimal [16-Bits]



                              1 ; ==================================================
                              2 ; MEMORY
                              3 ; ------
                     0000     4 RESET	= 0x0000	; Reset entry point
                     0005     5 BDOS	= 0x0005	; BDOS entry point
                     005C     6 FCB	= 0x005C	; Default FCB
                              7 
                     0003     8 IOBYTE	= 0x0003
                     D300     9 CCP	= 0xD300	; 0xD300 = CCP start 	(0xD300 - 0xDB06)	2054 bytes	= 18 sectors
                     DC00    10 BDOS0	= 0xDC00	; 0xDC00 = BDOS start	(0xDC00 - 0xEA00)	3584 bytes	= 28 sectors
                     EA00    11 BIOS	= 0xEA00	; 0xEA00 = BIOS start	(0xEA00 - 0xFC00)	4096 bytes
                             12 
                     8FFF    13 STACK 	= 0x8FFF
                             14 
                             15 
                             16 ; I/O
                             17 ; ---
                     0000    18 STATUS	=	0x00		; 6850 status register
                     0000    19 CONTROL	=	0x00		; 6850 control register
                     0001    20 DATA	=	0x01		; 6850 data register
                             21 
                             22 
                             23 
                             24 ; BIOS JUMP TABLE
                             25 ; ===============
   0000 C3 A5 00      [10]   26 BOOT:	JP	JBOOT
   0003 C3 EC 00      [10]   27 WBOOT:	JP	JWBOOT
   0006 C3 13 01      [10]   28 CONST:	JP	JCONST
   0009 C3 1C 01      [10]   29 CONIN:	JP	JCONIN
   000C C3 20 01      [10]   30 CONOUT:	JP	JCONOUT
   000F C3 2C 01      [10]   31 LIST:	JP	JLST
   0012 C3 2C 01      [10]   32 PUNCH:	JP	JPUNCH
   0015 C3 26 01      [10]   33 READER:	JP	JREADER
                             34 
   0018 C3 19 0F      [10]   35 TRACK0: JP	FDC_HOME
                             36 
   001B C3 2E 01      [10]   37 SELDSK:	JP	JSELDSK
                             38 
   001E C3 1C 0F      [10]   39 SETTRK:	JP	FDC_SETTRK
   0021 C3 21 0F      [10]   40 SETSEC:	JP	FDC_SETSEC
   0024 C3 26 0F      [10]   41 SETDMA:	JP	FDC_SETDMA
   0027 C3 2B 0F      [10]   42 READ:	JP	FDC_READ
   002A C3 33 0F      [10]   43 WRITE:	JP	FDC_WRITE
                             44 
   002D C3 2C 01      [10]   45 PRSTAT:	JP	JPRSTAT
   0030 C3 29 01      [10]   46 SECTRN:	JP	JSECTRN
                             47 
                             48 ; INITIAL ZERO-PAGE CONTENTS
                             49 ; --------------------------
   0033                      50 BASE:	
   0033 C3 03 00      [10]   51 	JP	WBOOT		; Jump to BIOS to Warm Boot			(3 bytes)		0-1-2
   0036 00 00                52 	.dw	0x0000		; IOBYTE, DRIVE					(2 bytes)		3-4
   0038 C3 06 DC      [10]   53 	JP	BDOS0+6		; BDOS function call entry			(3 bytes)		5-6-7
                             54 
                             55 ;---------------------------------------------   8 bytes
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 2.
Hexadecimal [16-Bits]



   003B                      56 OS_INFO:  
   003B 0C                   57 	.db	0x0C	;ctrl L -> CLS
                             58 	;        0123456789012345678901234567890123456789
                             59 	;       |                                        |
   003C 53 45 47 41 20 53    60         .ascii	"SEGA SC-3000 CP/M-80 (P2DOS 2.3)\r\n"
        43 2D 33 30 30 30
        20 43 50 2F 4D 2D
        38 30 20 28 50 32
        44 4F 53 20 32 2E
        33 29 0D 0A
   005E 43 6F 70 79 72 69    61         .ascii  "Copyright (c) by Digital Research\r\n\r\n"
        67 68 74 20 28 63
        29 20 62 79 20 44
        69 67 69 74 61 6C
        20 52 65 73 65 61
        72 63 68 0D 0A 0D
        0A
   0083 00                   62 	.db	0
                             63 
                             64 
                             65 
   0084                      66 BDOS_LOADED:
   0084 20 42 44 4F 53 20    67 	.ascii " BDOS Loaded."
        4C 6F 61 64 65 64
        2E
   0091 00                   68 	.db	0
                             69 
   0092                      70 CCP_LOADED:
   0092 0D 0A 2A 20 43 43    71 	.ascii "\r\n* CCP  Loaded.\r\n"
        50 20 20 4C 6F 61
        64 65 64 2E 0D 0A
   00A4 00                   72 	.db	0
                             73 
                             74 
                             75 ; COLD BOOT - Entered on hard reset
                             76 ; ---------------------------------
   00A5                      77 JBOOT:	
   00A5 F3            [ 4]   78 	di
   00A6 ED 56         [ 8]   79 	im	1
   00A8 31 FF 8F      [10]   80 	ld	sp, #STACK
                             81 
   00AB 11 8B 0F      [10]   82 	ld	de, #BIOS_END
   00AE 21 FF FF      [10]   83 	ld	hl, #0xFFFF
   00B1 AF            [ 4]   84 	xor	a
   00B2 CD A0 01      [17]   85 	call	fill_mem
                             86 
   00B5 21 33 00      [10]   87 	LD	HL,#BASE
   00B8 11 00 00      [10]   88 	LD	DE,#0x0000
   00BB 01 08 00      [10]   89 	LD	BC,#8
   00BE ED B0         [21]   90 	LDIR
                             91 
   00C0 3E C9         [ 7]   92 	ld	a, #0xC9
   00C2 32 66 00      [13]   93 	ld	(0x0066), a
                             94 
   00C5 CD 7D 01      [17]   95 	call	BIOS_INIT
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 3.
Hexadecimal [16-Bits]



                             96 	
                             97 
   00C8 3E 0C         [ 7]   98 	ld	a, #ASC_CLS
   00CA CD AA 07      [17]   99 	call	conio_write_char
                            100 
                            101 	;ld	hl, #BIOS_INFO
   00CD 21 3B 00      [10]  102 	ld	hl, #OS_INFO
   00D0 CD 93 07      [17]  103 	call	conio_write_text
                            104 
                            105 	
                            106 ;=========================================================
   00D3 3E 3E         [ 7]  107 	ld	a, #">"
   00D5 CD AA 07      [17]  108 	call	conio_write_char
                            109 
   00D8 11 80 DB      [10]  110 	ld	de, #BDOS0-128		; dest = 0xDC00
                            111 	;ld	bc, #0x0200		; START SEC|TRK
   00DB 01 00 01      [10]  112 	ld	bc, #0x0100		; START SEC|TRK
   00DE 2E 0E         [ 7]  113 	ld	l, #14			; 3584 / 256
   00E0 CD 2C 0D      [17]  114 	call	fdc_readsectors
                            115 
   00E3 CD 03 0E      [17]  116 	call	fdc_motor_req_on	; FORCE MOTOR TO STAY ON
                            117 
                            118 
   00E6 21 84 00      [10]  119 	ld	hl, #BDOS_LOADED
   00E9 CD 93 07      [17]  120 	call	conio_write_text
                            121 
                            122 ;	ld	hl, #CCP_LOADED
                            123 ;	call	conio_write_text
                            124 ;	call	fdc_stop_disk
                            125 
                            126 ;	jp	0
                            127   
                            128   
                            129 ; WARM BOOT - soft reset
                            130 ; ---------------------------------
   00EC                     131 JWBOOT:
   00EC 31 EF FE      [10]  132 	ld	sp, #top_of_stack
   00EF CD F3 0E      [17]  133   	call	FDC_RESET
                            134 
                            135 
   00F2 11 00 D3      [10]  136 	ld	de, #CCP		; dest = 0xD300
   00F5 01 02 01      [10]  137 	ld	bc, #0x0102		; START SEC|TRK
                            138 ;	ld	bc, #0x0F01		; START SEC|TRK
   00F8 2E 08         [ 7]  139 	ld	l, #8
   00FA CD 2C 0D      [17]  140 	call	fdc_readsectors
                            141 
                            142 
                            143 	;LD	bc, #0x0080		; Default DMA address 
   00FD 01 00 FD      [10]  144 	ld	bc, #DIRBF
   0100 CD 26 0F      [17]  145 	call	FDC_SETDMA
                            146 
                            147 	
   0103 21 92 00      [10]  148 	ld	hl, #CCP_LOADED
   0106 CD 93 07      [17]  149 	call	conio_write_text
                            150 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 4.
Hexadecimal [16-Bits]



   0109 FB            [ 4]  151 	ei
   010A CD 37 0A      [17]  152 	call	psg_beep_1
                            153 
   010D AF            [ 4]  154 	xor	a
   010E 4F            [ 4]  155 	ld	c, a			; C = uuuudddd (u = user, d = drive no)
   010F 47            [ 4]  156 	ld	b, a
   0110 C3 00 D3      [10]  157 	JP	CCP			; Start CP/M by jumping to the CCP.
                            158 		
                            159 
                            160 
                            161 ; CONSOLE I/O VIA A 6850 SERIAL ACIA
                            162 ; ==================================
   0113                     163 JCONST:	
   0113 CD 16 0C      [17]  164 	call	KEYB_BUFTEST
   0116 3E FF         [ 7]  165 	ld	a, #0xFF
   0118 20 01         [12]  166 	jr	nz, j_nokey
   011A AF            [ 4]  167 	xor	a
   011B                     168 j_nokey:
   011B C9            [10]  169 	ret
                            170 
                            171 
   011C                     172 JCONIN:
   011C CD 74 0C      [17]  173 	call	KEYB_WAITFORCHAR
   011F C9            [10]  174 	ret
                            175 
   0120                     176 JCONOUT:
                            177 	;out (0xd2), a
   0120 F3            [ 4]  178 	di
   0121 CD AA 07      [17]  179 	call	conio_write_char
   0124 FB            [ 4]  180 	ei
   0125 C9            [10]  181 	ret
                            182 		
   0126                     183 JREADER:
   0126 3E 1A         [ 7]  184 	LD	a,#0x1a				; EOF and RETurn.
   0128 C9            [10]  185 	ret
   0129                     186 JSECTRN:
   0129 60            [ 4]  187 	ld  	h, b				; pass the logical
   012A 69            [ 4]  188 	ld	l, c       			; sector to HL
   012B 23            [ 6]  189 	inc	hl				; convert to phisical
   012C                     190 JLST:   
   012C                     191 JPUNCH: 
   012C                     192 JPRSTAT:
   012C AF            [ 4]  193 	xor	a
   012D C9            [10]  194 	ret
                            195 
                            196 
                            197 ; DISK ACCESS
                            198 ; ===========
   012E                     199 JSELDSK:
   012E CD EE 0E      [17]  200 	call	FDC_RESET_AND_SPIN
   0131 21 35 01      [10]  201 	ld	hl,#DPH				; Return same DPH
   0134 C9            [10]  202 	ret
                            203 
   0135                     204 DPH:	
   0135 00 00               205 	.dw 0x0000
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 5.
Hexadecimal [16-Bits]



   0137 00 00               206 	.dw 0x0000
   0139 00 00               207 	.dw 0x0000
   013B 00 00               208 	.dw 0x0000
   013D 00 FD               209 	.dw DIRBF		; 128-byte buffer
   013F 45 01               210 	.dw B_DPB
   0141 80 FD               211 	.dw B_CSV
   0143 90 FD               212 	.dw B_ALV
                            213 
   0145                     214 B_DPB:	
                            215 ; http://www.sharpmz.org/dpb.htm
                            216 ; 256 bytes/sector, 16 sectors/track, 40 tracks, 1 heads
   0145 20 00               217 	.dw 32      ; (SPT) LSECTORS PER TRACK (32 logical-sectors * 128 bytes = 4096 bytes/track)
                            218 	
   0147 03                  219 	.DB 3       ; (BSH) BLOCK SHIFT FACTOR; block size => 1024
   0148 07                  220 	.DB 7       ; (BLM) BLOCK MASK
                            221 	
   0149 00                  222 	.DB 0       ; (EXM) NULL MASK
   014A 9F 00               223 	.dw 159     ; (DSM) DISK SIZE-1					Total bytes / block size = 160
   014C 3F 00               224 	.dw 63      ; (DRM) DIRECTORY MASK = DIR ENTRIES - 1
                            225 
   014E C0                  226 	.DB 0xC0    ; (AL0) ALLOC 0
   014F 00                  227 	.DB 0x00    ; (AL1) ALLOC 1		; 0xC000 => 1100 0000 0000 0000 (first 2 bit => first 2 block reserved for dir => 2048)
   0150 10 00               228 	.dw 16      ; (CKS) CHECK AREA SIZE	; Number of directory entries to check for disk change
   0152 03 00               229 	.dw 3       ; (OFF) TRACK OFFSET	; Number of system reserved tracks at the beginning of the ( logical ) disk
                            230 
                            231 ;DIRBF:	.ds	128	; 128-byte buffer
                            232 ;B_CSV:	.ds	16	; CKS bytes...
                            233 ;B_ALV:	.ds	40	; Allocation vector = 2 * ((DSM / 8) + 1) 
                            234 
                            235 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 6.
Hexadecimal [16-Bits]



                            236 .include "sc3k_bios.s"
                              1 ;.area	_CODE
                              2 ; ==================================================
                              3 
                              4 ; BIOS JUMP TABLE
                              5 ; ===============
   0154                       6 BIOS_BOOT:	
                              7 ;	JP	COLDBOOT
                              8 ;	JP	COLDBOOT
                              9 ;	JP	COLDBOOT
                             10 ;	JP	COLDBOOT
                             11 ;	JP	COLDBOOT
                             12 ;	JP	COLDBOOT
                             13 ;	JP	COLDBOOT
                             14 ;	JP	COLDBOOT
                             15 
                             16 		
                             17 ;BIOS_INFO:		
                             18 ;	.ascii "* SEGA SC-3000 CP/M BIOS 1.0\r\n"
                             19 ;	.ascii "  Copyright (c) SiRioKD 2012\r\n\r\n"
                             20 ;	.db	0
                             21 
                             22 ; COLD BOOT - Entered on hard reset
                             23 ; ---------------------------------
   0154                      24 COLDBOOT:
   0154 F3            [ 4]   25 	di
   0155 ED 56         [ 8]   26 	im	1
   0157 31 00 06      [10]   27 	ld	sp, #0x0600					; Initial stack 
                             28 
   015A 11 8B 0F      [10]   29 	ld	de, #BIOS_END
   015D 21 FF FF      [10]   30 	ld	hl, #0xFFFF
   0160 AF            [ 4]   31 	xor	a
   0161 CD A0 01      [17]   32 	call	fill_mem
                             33 
   0164 31 EF FE      [10]   34 	ld	sp, #top_of_stack				; Final stack 
                             35 
   0167 CD 7D 01      [17]   36 	call	BIOS_INIT
                             37 
   016A FB            [ 4]   38 	ei
                             39 
   016B 3E 0C         [ 7]   40 	ld	a, #ASC_CLS
   016D CD AA 07      [17]   41 	call	conio_write_char
                             42 
                             43 ;	ld	hl, #BIOS_INFO
                             44 ;	call	conio_write_text
                             45 	
   0170 3E 3E         [ 7]   46 	ld	a, #">"
   0172 CD AA 07      [17]   47 	call	conio_write_char
                             48 
                             49 	;ld	a, #0xFF
                             50 	;call	TEXT_INSERT_MODE
                             51 
                             52 ;=========================================================
                             53 
   0175                      54 el:	
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 7.
Hexadecimal [16-Bits]



   0175 CD 74 0C      [17]   55 	call	KEYB_WAITFORCHAR
   0178 CD AA 07      [17]   56 	call	conio_write_char
   017B 18 F8         [12]   57 	jr	el
                             58 
                             59 
                             60 
   017D                      61 BIOS_INIT::
   017D CD 18 0A      [17]   62 	call	psg_reset
   0180 CD 6D 02      [17]   63 	call  	vdp_videomode_text40
   0183 CD 68 0A      [17]   64 	call	ppi_init
                             65 
u  0186 CD 00 00      [17]   66 	call	fdc_reset_and_spin
   0189 CD FC 0B      [17]   67 	call	kbd_reset
   018C CD 8F 07      [17]   68 	call	conio_reset
                             69 
   018F 3E C3         [ 7]   70 	ld	a,#0xC3          			; put a JP opcode
   0191 32 38 00      [13]   71 	ld	(0x0038),a       			; and the opcode again
   0194 21 B4 01      [10]   72 	ld	hl, #Int38h     			; int handling routine address
   0197 22 39 00      [16]   73 	ld	(0x0039),hl      			; put it as a JP argument
                             74 
   019A 3E 00         [ 7]   75 	ld	a, #0x00
   019C CD 4A 09      [17]   76 	call	TEXT_INSERT_MODE
   019F C9            [10]   77 	ret
                             78 
                             79 
                             80 
                             81 ; =============================================================
   01A0                      82 fill_mem:
                             83 ; =============================================================
   01A0 F5            [11]   84 	push	af
   01A1 C5            [11]   85 	push	bc
   01A2 D5            [11]   86 	push	de
   01A3 E5            [11]   87 	push	hl
                             88 
   01A4 B7            [ 4]   89 	or	a		; clear CF
   01A5 ED 52         [15]   90 	sbc	hl, de		; HL -= DE
   01A7 44            [ 4]   91 	ld	b, h
   01A8 4D            [ 4]   92 	ld	c, l		; BC = HL - DE
                             93 	
   01A9 62            [ 4]   94 	ld	h, d
   01AA 6B            [ 4]   95 	ld	l, e
   01AB 13            [ 6]   96 	inc	de
                             97 	
   01AC 77            [ 7]   98 	ld	(hl), a
   01AD ED B0         [21]   99 	ldir
                            100 
   01AF E1            [10]  101 	pop	hl
   01B0 D1            [10]  102 	pop	de
   01B1 C1            [10]  103 	pop	bc
   01B2 F1            [10]  104 	pop	af
   01B3 C9            [10]  105 	ret
                            106 
                            107 
                            108 ; =============================================================
   01B4                     109 Int38h:
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 8.
Hexadecimal [16-Bits]



                            110 ; =============================================================
   01B4 F5            [11]  111 	push    af
   01B5 C5            [11]  112 	push    bc
   01B6 D5            [11]  113 	push    de
   01B7 E5            [11]  114 	push    hl
   01B8 DD E5         [15]  115 	push    ix
   01BA FD E5         [15]  116 	push    iy
                            117 	
   01BC D9            [ 4]  118 	exx
   01BD 08            [ 4]  119 	ex      af,af'
                            120 	
   01BE F5            [11]  121 	push    af
   01BF C5            [11]  122 	push    bc
   01C0 D5            [11]  123 	push    de
   01C1 E5            [11]  124 	push    hl
   01C2 DD E5         [15]  125 	push    ix
   01C4 FD E5         [15]  126 	push    iy
                            127 
   01C6 CD E7 02      [17]  128 	call	vdp_int_hack
                            129 
                            130 
   01C9 2A F0 FE      [16]  131 	LD      HL,(FRAMES1)	; Fetch the first two bytes at FRAMES1.
   01CC 23            [ 6]  132         INC     HL		; Increment lowest two bytes of counter.
   01CD 22 F0 FE      [16]  133         LD      (FRAMES1),HL	; Place back in FRAMES1.
   01D0 7C            [ 4]  134         LD      A,H		; Test if the result was zero.
   01D1 B5            [ 4]  135         OR      L		;            
   01D2 20 04         [12]  136         JR      NZ, NOINC3	; Forward, if not, to KEY-INT
                            137 
   01D4 21 F2 FE      [10]  138 	LD	HL, #FRAMES3
   01D7 34            [11]  139         INC     (HL)		; otherwise increment FRAMES3 the third byte.
   01D8                     140 NOINC3:
                            141 
                            142 
   01D8 CD D9 0E      [17]  143 	call	FDC_INTERRUPT
   01DB CD 2B 0C      [17]  144 	call	keyboard_interrupt
                            145 
   01DE                     146 int_end:
   01DE FD E1         [14]  147 	pop     iy
   01E0 DD E1         [14]  148 	pop     ix
   01E2 E1            [10]  149 	pop     hl
   01E3 D1            [10]  150 	pop     de
   01E4 C1            [10]  151 	pop     bc
   01E5 F1            [10]  152 	pop     af
                            153 	
   01E6 08            [ 4]  154 	ex      af,af'
   01E7 D9            [ 4]  155 	exx
                            156 	
   01E8 FD E1         [14]  157 	pop     iy
   01EA DD E1         [14]  158 	pop     ix
   01EC E1            [10]  159 	pop     hl
   01ED D1            [10]  160 	pop     de
   01EE C1            [10]  161 	pop     bc
   01EF F1            [10]  162 	pop     af
   01F0 FB            [ 4]  163 	ei
   01F1 ED 4D         [14]  164 	reti
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 9.
Hexadecimal [16-Bits]



                            165 
                            166 
                            167 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 10.
Hexadecimal [16-Bits]



                            168 .include "sc3k_bios_bitbuster.inc"
                              1 ;############################################################à
                              2 ; Bitbuster by Team Bomba
                              3 ;############################################################à
                              4 ; In: HL = source
                              5 ;     DE = destination
                              6 ;
   01F3                       7 unPack_1::
   01F3 D9            [ 4]    8       exx
   01F4 01 80 00      [10]    9       ld			bc, #128        ; b' = 0 (register loading optimize)
                             10               								; c' = bits from bitstream
   01F7 D9            [ 4]   11       exx
                             12 
   01F8                      13 unPack_loop_1:
   01F8 D9            [ 4]   14       exx
   01F9 CD 49 02      [17]   15       call    getBit_1
   01FC D9            [ 4]   16       exx
   01FD 38 04         [12]   17       jr      c,unPack_outCompress_1  ; if set, we got LZ77 compression
                             18 
   01FF                      19 unPack_outLiteral_1:
   01FF ED A0         [16]   20       ldi                     ; copy byte from compressed data to destination
   0201 18 F5         [12]   21       jr      unPack_loop_1   ; handle more compressed data
                             22 
   0203                      23 unPack_outCompress_1:
   0203 7E            [ 7]   24       ld      a,(hl)          ; get lowest 7 bits of offset, plus the offset
                             25                               ; extension bit
   0204 23            [ 6]   26       inc     hl
                             27 
   0205 B7            [ 4]   28       or      a
   0206 28 30         [12]   29       jr      z,unPack_outRle_1       ; offset = 0, RLE compression used
                             30 
   0208                      31 unPack_outMatch_1:
   0208 D9            [ 4]   32       exx
   0209 5F            [ 4]   33       ld      e,a
   020A 50            [ 4]   34       ld      d,b             ; b' should be always clear when entering this part
   020B 07            [ 4]   35       rlca                    ; offset extension bit set?
   020C 30 16         [12]   36       jr      nc,unPack_outMatch1_1   ; no need to get extra bits if carry not set
                             37 
   020E CD 49 02      [17]   38       call    getBit_1        ; get offset bit 10
   0211 CB 12         [ 8]   39       rl      d
   0213 CD 49 02      [17]   40       call    getBit_1        ; get offset bit 9
   0216 CB 12         [ 8]   41       rl      d
   0218 CD 49 02      [17]   42       call    getBit_1        ; get offset bit 8
   021B CB 12         [ 8]   43       rl      d
   021D CD 49 02      [17]   44       call    getBit_1        ; get offset bit 7
                             45 
   0220 38 02         [12]   46       jr      c,unPack_outMatch1_1    ; since extension mark already makes bit 7 set
   0222 CB BB         [ 8]   47       res     7,e             ; only clear it if the bit should be cleared
   0224                      48 unPack_outMatch1_1:
   0224 13            [ 6]   49       inc     de
   0225 CD 56 02      [17]   50       call    getGammaValue_0_1       ; get the match length
                             51                               ; HL' = length
                             52 
   0228 E5            [11]   53       push    hl              ; save compressed data pointer
   0229 D9            [ 4]   54       exx
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 11.
Hexadecimal [16-Bits]



   022A E5            [11]   55       push    hl              ; save match length
   022B D5            [11]   56       push    de              ; save match offset
   022C D9            [ 4]   57       exx
                             58 
   022D 62            [ 4]   59       ld      h,d             ; destination in HL
   022E 6B            [ 4]   60       ld      l,e
   022F C1            [10]   61       pop     bc              ; load match offset length
   0230 ED 42         [15]   62       sbc     hl,bc           ; calculate source address
   0232 C1            [10]   63       pop     bc              ; load match length
   0233 ED B0         [21]   64       ldir
                             65 
   0235 E1            [10]   66       pop     hl              ; load compressed data pointer
   0236 18 C0         [12]   67       jr      unPack_loop_1
                             68 
   0238                      69 unPack_outRle_1:
   0238 CD 55 02      [17]   70       call    getGammaValue_1
   023B D8            [11]   71       ret     c               ; HL' = repeat length
                             72 
   023C E5            [11]   73       push    hl              ; save compressed data pointer
   023D D9            [ 4]   74       exx
   023E E5            [11]   75       push    hl              ; save repeat length
   023F D9            [ 4]   76       exx
   0240 C1            [10]   77       pop     bc              ; load repeat length
                             78 
   0241 62            [ 4]   79       ld      h,d             ; source = destination - 1
   0242 6B            [ 4]   80       ld      l,e
   0243 2B            [ 6]   81       dec     hl
   0244 ED B0         [21]   82       ldir
                             83 
   0246 E1            [10]   84       pop     hl              								; load compressed data pointer
   0247 18 AF         [12]   85       jr      unPack_loop_1
                             86 
   0249                      87 getBit_1:
   0249 CB 21         [ 8]   88       sla     c               								; shift out new bit
   024B C0            [11]   89       ret     nz              								; if remaining value != 0, we're done
                             90 
   024C D9            [ 4]   91       exx
   024D 7E            [ 7]   92       ld      a,(hl)          								; get 8 bits from the compressed stream
   024E 23            [ 6]   93       inc     hl
   024F D9            [ 4]   94       exx
                             95 
   0250 4F            [ 4]   96       ld      c,a             								; 8 bits in C'
   0251 CB 21         [ 8]   97       sla     c               								; shift out new bit
   0253 0C            [ 4]   98       inc     c               								; set bit 0 so C' will be zero after shifting 8 times
   0254 C9            [10]   99       ret
                            100 
   0255                     101 getGammaValue_1:
   0255 D9            [ 4]  102       exx                     								; get number of bits used to encode value
   0256                     103 getGammaValue_0_1:
   0256 21 01 00      [10]  104       ld      hl,#1            								; initial length
   0259 06 01         [ 7]  105       ld      b,#1             								; bitcount
                            106 
   025B                     107 getGammaValue_size_1:
   025B CD 49 02      [17]  108       call    getBit_1        								; get more bits
   025E 30 08         [12]  109       jr      nc,getGammaValue_sizeEnd_1      ; if bit is not set, bit length is known
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 12.
Hexadecimal [16-Bits]



   0260 04            [ 4]  110       inc     b               								; increase bitcount
   0261 18 F8         [12]  111       jr      getGammaValue_size_1
                            112 
   0263                     113 getGammaValue_bits_1:
   0263 CD 49 02      [17]  114       call    getBit_1        								; get next bit of value from the compressed stream
   0266 ED 6A         [15]  115       adc     hl,hl           								; insert new bit in HL
   0268                     116 getGammaValue_sizeEnd_1:
   0268 10 F9         [13]  117       djnz    getGammaValue_bits_1            ; repeat if more bits to go
                            118 
   026A                     119 getGammaValue_end_1:
   026A 23            [ 6]  120       inc     hl              								; correct HL (was stored as length - 2)
   026B D9            [ 4]  121       exx
   026C C9            [10]  122       ret
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 13.
Hexadecimal [16-Bits]



                            169 .include "sc3k_bios_vdp.inc"
                     00BE     1 vdp_data      		= 0xbe
                     00BF     2 vdp_control				= 0xbf
                     0800     3 vdp_tilemap_addr	= 0x0800
                              4 
                     001E     5 fore_back_colors	= 0x1E   	;0xF4
                              6 
                     1000     7 font_temp_area		= 0x1000	; 1792 bytes
                              8 
                              9 
                             10 .area	_CODE
                             11 ; ==================================================
                             12 
                             13 ;-------------------------------------------------------
   026D                      14 vdp_videomode_text40::
                             15 ;-------------------------------------------------------
   026D 06 02         [ 7]   16     	ld     b, #0x02
                             17 
   026F                      18 setup_vdp_registers_2x:
   026F C5            [11]   19 	push   bc
   0270 CD E7 02      [17]   20 	call   read_vdp_status				; not sure why?
   0273 0E 00         [ 7]   21 	ld     c, #0x00
   0275 3E 00         [ 7]   22 	ld     a, #0b00000000				; reg 0: no line ints, turn off features
   0277 CD EA 02      [17]   23 	call   vdp_set_register
   027A 0C            [ 4]   24 	inc    c
   027B 3E D0         [ 7]   25 	ld     a, #0b11010000				; reg 1: display enable, mode 1
   027D CD EA 02      [17]   26 	call   vdp_set_register
   0280 0C            [ 4]   27 	inc    c
   0281 3E 02         [ 7]   28 	ld     a, #(vdp_tilemap_addr) >> 10		; reg 2: tilemap address
   0283 CD EA 02      [17]   29 	call   vdp_set_register
   0286 0C            [ 4]   30 	inc    c
   0287 3E 00         [ 7]   31 	ld     a, #0x00					; reg 3: colour table address
   0289 CD EA 02      [17]   32 	call   vdp_set_register
   028C 0C            [ 4]   33 	inc    c
   028D 3E 03         [ 7]   34 	ld     a, #0x03					; reg 4: pattern generator address
   028F CD EA 02      [17]   35 	call   vdp_set_register
   0292 0C            [ 4]   36 	inc    c
   0293 3E 00         [ 7]   37 	ld     a, #0x00					; reg 5: sprite table address
   0295 CD EA 02      [17]   38 	call   vdp_set_register
   0298 0C            [ 4]   39 	inc    c
   0299 3E 00         [ 7]   40 	ld     a, #0x00					; reg 6: sprite tile number modifier (?)
   029B CD EA 02      [17]   41 	call   vdp_set_register
   029E 0C            [ 4]   42 	inc    c
   029F 3E 1E         [ 7]   43 	ld     a, #fore_back_colors			; reg 7: backdrop color (1)
   02A1 CD EA 02      [17]   44 	call   vdp_set_register
                             45 	
   02A4 21 00 18      [10]   46 	ld     hl, #0x1800
   02A7 CD 0A 03      [17]   47 	call   set_vram_write_address_to_hl
                             48 
                             49 ;------------------------------------------------------      
   02AA AF            [ 4]   50 	xor    a
   02AB 47            [ 4]   51 	ld     b,a
   02AC                      52 setup_vdp_regs_zero256:    
   02AC CD 17 03      [17]   53 	call   wait_and_output_a_to_vdp
   02AF 10 FB         [13]   54 	djnz   setup_vdp_regs_zero256              ; output 256 zero bytes at VRAM 0x1800
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 14.
Hexadecimal [16-Bits]



                             55 ;------------------------------------------------------      
                             56 
   02B1 21 24 04      [10]   57 	ld	hl, #font_data+4
   02B4 11 00 10      [10]   58 	ld	de, #font_temp_area
                             59 	
   02B7 CD F3 01      [17]   60 	call	unPack_1
                             61 	
   02BA 21 00 10      [10]   62 	ld	hl, #font_temp_area
   02BD 01 00 07      [10]   63 	ld	bc, #1792
                             64 	
                             65       ;ld     hl, #font_data                        ; output the font after that
                             66       ;ld     bc, #font_data_end - font_data
                             67 
   02C0                      68 setup_vdp_regs_font:    
   02C0 7E            [ 7]   69 	ld     a,(hl)
   02C1 CD 17 03      [17]   70 	call   wait_and_output_a_to_vdp
   02C4 23            [ 6]   71 	inc    hl
   02C5 0B            [ 6]   72 	dec    bc
   02C6 78            [ 4]   73 	ld     a,b
   02C7 B1            [ 4]   74 	or     c
   02C8 20 F6         [12]   75 	jr     nz, setup_vdp_regs_font
                             76 	
                             77 
   02CA 21 00 08      [10]   78 	ld     hl, #0x0800
   02CD 01 C0 03      [10]   79 	ld     bc, #960
   02D0 CD 0A 03      [17]   80 	call   set_vram_write_address_to_hl
   02D3                      81 setup_vdp_regs_names_0:    
   02D3 3E 20         [ 7]   82 	ld     a, #0x20                               ; set 960 bytes from VRAM 0x0800 to 0x20
   02D5 CD 17 03      [17]   83 	call   wait_and_output_a_to_vdp
   02D8 0B            [ 6]   84 	dec    bc
   02D9 78            [ 4]   85 	ld     a, b
   02DA B1            [ 4]   86 	or     c
   02DB 20 F6         [12]   87 	jr     nz, setup_vdp_regs_names_0
   02DD C1            [10]   88 	pop    bc
                             89 	
   02DE 10 8F         [13]   90 	djnz   setup_vdp_registers_2x                ; do the whole thing twice - why?!?
                             91 	
                             92 	
   02E0 0E 01         [ 7]   93 	ld     c, #0x01
   02E2 3E F0         [ 7]   94 	ld     a, #0b11110000                         ; reg 1
   02E4 CD EA 02      [17]   95 	call   vdp_set_register
                             96 	
                             97 
                             98 ;##############################################
   02E7                      99 vdp_int_hack::
   02E7                     100 read_vdp_status::
                            101 ;##############################################
   02E7 DB BF         [11]  102 	    in     a,(vdp_control)
   02E9 C9            [10]  103 	    ret
                            104 
                            105 
                            106 
                            107 ;##############################################
   02EA                     108 vdp_set_register::
                            109 ;##############################################
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 15.
Hexadecimal [16-Bits]



                            110 ; a = data
                            111 ; c = register
                            112 ; clobbers a
   02EA D3 BF         [11]  113 	out    (vdp_control),a
   02EC 79            [ 4]  114 	ld     a,c
   02ED E6 07         [ 7]  115 	and    #0x07
   02EF F6 80         [ 7]  116 	or     #0x80
   02F1 D3 BF         [11]  117 	out    (vdp_control),a
   02F3 C9            [10]  118 	ret
                            119 
                            120 
                            121 ;##############################################
   02F4                     122 set_vram_read_address_to_hl::
                            123 ;##############################################
   02F4 F5            [11]  124 	push   af
   02F5 7D            [ 4]  125 	ld     a,l
   02F6 D3 BF         [11]  126 	out    (vdp_control),a
   02F8 7C            [ 4]  127 	ld     a,h
   02F9 E6 3F         [ 7]  128 	and    #0x3f
   02FB D3 BF         [11]  129 	out    (vdp_control),a
   02FD F1            [10]  130 	pop    af
   02FE C9            [10]  131 	ret
                            132 
   02FF                     133 wait_and_read_from_vdp::
   02FF 00            [ 4]  134 	    nop
   0300 00            [ 4]  135 	    nop
   0301 00            [ 4]  136 	    nop
   0302 00            [ 4]  137 	    nop
   0303 00            [ 4]  138 	    nop
   0304 DB BE         [11]  139 	    in     a, (vdp_data)
   0306 C9            [10]  140 	    ret
                            141 
                            142 
   0307                     143 set_vram_write_address_to_home::
   0307 21 00 08      [10]  144       ld     hl, #vdp_tilemap_addr
                            145 
   030A                     146 set_vram_write_address_to_hl::
   030A F5            [11]  147 	    push   af
   030B 7D            [ 4]  148       ld     a,l
   030C D3 BF         [11]  149       out    (vdp_control),a
   030E 7C            [ 4]  150       ld     a,h
   030F E6 3F         [ 7]  151       and    #0x3f
   0311 F6 40         [ 7]  152       or     #0x40                                 ; make it a write address
   0313 D3 BF         [11]  153       out    (vdp_control),a
   0315 F1            [10]  154 	    pop    af
   0316 C9            [10]  155 	    ret
                            156 
   0317                     157 wait_and_output_a_to_vdp::
   0317 00            [ 4]  158 	    nop
   0318 00            [ 4]  159 	    nop
   0319 00            [ 4]  160 	    nop
   031A 00            [ 4]  161 	    nop
   031B D3 BE         [11]  162 	    out    (vdp_data),a
   031D C9            [10]  163 	    ret
                            164 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 16.
Hexadecimal [16-Bits]



                            165 
                            166 
                            167 ; hl = src
                            168 ; iy = dst
                            169 ; bc = len
                            170 
   031E                     171 vdp_vram2ram:
   031E C5            [11]  172 			push	bc
   031F D5            [11]  173 			push	de
   0320 FD E5         [15]  174 			push	iy
                            175 			
   0322 CD F4 02      [17]  176 			call	set_vram_read_address_to_hl
   0325 DD E3         [23]  177 			ex	(sp),ix
   0327 DD E3         [23]  178 			ex	(sp),ix
                            179 
   0329                     180 vdp_vram2ram_loop:
   0329 DB BE         [11]  181 	    in    a, (vdp_data)
   032B FD 77 00      [19]  182       ld		(iy), a
   032E FD 23         [10]  183       inc		iy
   0330 0B            [ 6]  184 			dec		bc
   0331 79            [ 4]  185 			ld		a,c
   0332 B0            [ 4]  186 			or		b
   0333 20 F4         [12]  187       jr		nz, vdp_vram2ram_loop
                            188       
   0335 FD E1         [14]  189       pop		iy
   0337 D1            [10]  190       pop		de
   0338 C1            [10]  191       pop		bc
   0339 C9            [10]  192 			ret
                            193 
                            194 
                            195 
                            196 
                            197 ; iy = src
                            198 ; hl = dst
                            199 ; bc = len
                            200 
   033A                     201 vdp_ram2vram:
   033A C5            [11]  202 	push	bc
   033B D5            [11]  203 	push	de
   033C FD E5         [15]  204 	push	iy
                            205 	
   033E CD 0A 03      [17]  206 	call	set_vram_write_address_to_hl
   0341 DD E3         [23]  207 	ex	(sp),ix
   0343 DD E3         [23]  208 	ex	(sp),ix
                            209 
   0345                     210 vdp_ram2vram_loop:
   0345 FD 7E 00      [19]  211 	ld	a, (iy)
   0348 D3 BE         [11]  212 	out	(vdp_data),a
   034A FD 23         [10]  213 	inc	iy
   034C 0B            [ 6]  214 	dec	bc
   034D 79            [ 4]  215 	ld	a,c
   034E B0            [ 4]  216 	or	b
   034F 20 F4         [12]  217 	jr	nz, vdp_ram2vram_loop
                            218 	
   0351 FD E1         [14]  219 	pop	iy
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 17.
Hexadecimal [16-Bits]



   0353 D1            [10]  220 	pop	de
   0354 C1            [10]  221 	pop	bc
   0355 C9            [10]  222 	ret
                            223 
                            224 
                            225 
                            226 ; hl = dst
                            227 ; bc = len
                            228 ;  a = byte filler
                            229 
   0356                     230 vdp_fill2vram:
   0356 C5            [11]  231 	push	bc
   0357 D5            [11]  232 	push	de
                            233 	
   0358 F5            [11]  234 	push	af
   0359 CD 0A 03      [17]  235 	call	set_vram_write_address_to_hl
   035C E1            [10]  236 	pop	hl					; L = A
                            237 	
   035D DD E3         [23]  238 	ex	(sp),ix
   035F DD E3         [23]  239 	ex	(sp),ix
                            240 
   0361                     241 vdp_fill2vram_loop:
   0361 7D            [ 4]  242 	ld	a, l
   0362 D3 BE         [11]  243 	out	(vdp_data),a
   0364 0B            [ 6]  244 	dec	bc
   0365 79            [ 4]  245 	ld	a,c
   0366 B0            [ 4]  246 	or	b
   0367 20 F8         [12]  247 	jr	nz, vdp_fill2vram_loop
                            248 	
   0369 D1            [10]  249 	pop	de
   036A C1            [10]  250 	pop	bc
   036B C9            [10]  251 	ret
                            252 
                            253 
                            254 ; ix = vdp src address
                            255 ; iy = vdp dst address
                            256 ; bc = area len
   036C                     257 vdp_vramShiftForward:
   036C C5            [11]  258 	push	bc
   036D D5            [11]  259 	push	de
   036E DD E5         [15]  260 	push	ix
   0370 FD E5         [15]  261 	push	iy
                            262 
   0372 78            [ 4]  263 	ld		a, b
   0373 B7            [ 4]  264 	or		a
   0374 28 2F         [12]  265 	jr		z, cpSX2					
                            266 
   0376 DD 09         [15]  267 	add		ix, bc
   0378 FD 09         [15]  268 	add		iy, bc
   037A 11 00 FF      [10]  269 	ld		de, #0xFF00				; BLOCK256 INCREMENTER	-256
                            270 
   037D                     271 cpSB2:
   037D C5            [11]  272 	push	bc
                            273 
   037E DD 19         [15]  274 	add		ix, de
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 18.
Hexadecimal [16-Bits]



   0380 FD 19         [15]  275 	add		iy, de
                            276 
   0382 01 00 01      [10]  277 	ld		bc, #0x0100
                            278 
   0385 FD E5         [15]  279 	push	iy
                            280 
   0387 FD E5         [15]  281 	push	iy
   0389 FD 21 00 FC   [14]  282 	ld		iy, #vram_copy_buffer
   038D DD E5         [15]  283 	push	ix
   038F E1            [10]  284 	pop		hl
   0390 CD 1E 03      [17]  285 	call	vdp_vram2ram
   0393 FD E1         [14]  286 	pop		iy
                            287 
   0395 FD E5         [15]  288 	push	iy
   0397 E1            [10]  289 	pop		hl
   0398 FD 21 00 FC   [14]  290 	ld		iy, #vram_copy_buffer
   039C CD 3A 03      [17]  291 	call	vdp_ram2vram
                            292 
   039F FD E1         [14]  293 	pop		iy
                            294 
   03A1 C1            [10]  295 	pop		bc
                            296 
                            297 
   03A2 05            [ 4]  298 	dec		b
   03A3 20 D8         [12]  299 	jr		nz, cpSB2
                            300 
                            301 
   03A5                     302 cpSX2:
   03A5 79            [ 4]  303 	ld		a, c
   03A6 B7            [ 4]  304 	or		a
   03A7 28 0C         [12]  305 	jr		z, cpSXX2
                            306 
   03A9 AF            [ 4]  307 	xor		a
   03AA 91            [ 4]  308 	sub		c
   03AB 4F            [ 4]  309 	ld		c, a
   03AC 06 FF         [ 7]  310 	ld		b, #0xFF
   03AE DD 09         [15]  311 	add		ix, bc
   03B0 FD 09         [15]  312 	add		iy, bc
                            313 	
   03B2 CD E5 03      [17]  314 	call	vdp_vram2vram
                            315 
   03B5                     316 cpSXX2:			
   03B5 FD E1         [14]  317 	pop		iy
   03B7 DD E1         [14]  318 	pop		ix
   03B9 D1            [10]  319 	pop		de
   03BA C1            [10]  320 	pop		bc
   03BB C9            [10]  321 	ret
                            322 
                            323 
                            324 
                            325 
                            326 ; ix = vdp src address
                            327 ; iy = vdp dst address
                            328 ; bc = area len
   03BC                     329 vdp_vramShiftBack:
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 19.
Hexadecimal [16-Bits]



   03BC C5            [11]  330 			push	bc
   03BD D5            [11]  331 			push	de
   03BE DD E5         [15]  332 			push	ix
   03C0 FD E5         [15]  333 			push	iy
                            334 
   03C2 11 00 01      [10]  335 			ld		de, #0x0100				; BLOCK256 INCREMENTER
   03C5                     336 cpSB1:
   03C5 78            [ 4]  337 			ld		a, b
   03C6 B7            [ 4]  338 			or		a
   03C7 28 12         [12]  339 			jr		z, cpSX1					; STILL 256 BLOCKS?
                            340 			
   03C9 C5            [11]  341 			push	bc
   03CA 0E 00         [ 7]  342 			ld		c, #0
   03CC CD E5 03      [17]  343 			call	vdp_vram2vram
   03CF C1            [10]  344 			pop		bc
                            345 
   03D0 05            [ 4]  346 			dec		b
   03D1 DD 19         [15]  347 			add		ix, de
   03D3 FD 19         [15]  348 			add		iy, de
                            349 
   03D5 18 EE         [12]  350 			jr		cpSB1
                            351 
   03D7 79            [ 4]  352 			ld		a, c
   03D8 B7            [ 4]  353 			or		a
   03D9 28 03         [12]  354 			jr		z, cpSXX1
                            355 
   03DB                     356 cpSX1:
   03DB CD E5 03      [17]  357 			call	vdp_vram2vram
                            358 			
   03DE                     359 cpSXX1:
   03DE FD E1         [14]  360 			pop		iy
   03E0 DD E1         [14]  361 			pop		ix
   03E2 D1            [10]  362 			pop		de
   03E3 C1            [10]  363 			pop		bc
   03E4 C9            [10]  364 			ret
                            365 
                            366 
                            367 
                            368 ; ix = src
                            369 ; iy = dst
                            370 ;  c = len
   03E5                     371 vdp_vram2vram:
   03E5 C5            [11]  372 			push	bc
   03E6 D5            [11]  373 			push	de
   03E7 E5            [11]  374 			push	hl
   03E8 DD E5         [15]  375 			push	ix
   03EA FD E5         [15]  376 			push	iy
                            377 
   03EC C5            [11]  378 			push	bc
   03ED DD E5         [15]  379 			push	ix
   03EF E1            [10]  380 			pop		hl
   03F0 CD F4 02      [17]  381 			call	set_vram_read_address_to_hl
   03F3 11 00 FC      [10]  382 			ld		de, #vram_copy_buffer
   03F6 DD E3         [23]  383 			ex		(sp),ix
   03F8 DD E3         [23]  384 			ex		(sp),ix
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 20.
Hexadecimal [16-Bits]



   03FA                     385 v2v_loop1:
   03FA DB BE         [11]  386 	    in    a, (vdp_data)
   03FC 12            [ 7]  387       ld		(de), a
   03FD 13            [ 6]  388       inc		de
   03FE 0D            [ 4]  389 			dec		c
   03FF 20 F9         [12]  390       jr		nz, v2v_loop1
   0401 C1            [10]  391 			pop		bc
                            392 
   0402 C5            [11]  393 			push	bc
   0403 FD E5         [15]  394 			push	iy
   0405 E1            [10]  395 			pop		hl
   0406 CD 0A 03      [17]  396 			call	set_vram_write_address_to_hl
   0409 11 00 FC      [10]  397 			ld		de, #vram_copy_buffer
   040C DD E3         [23]  398 			ex		(sp),ix
   040E DD E3         [23]  399 			ex		(sp),ix
   0410                     400 v2v_loop2:
   0410 1A            [ 7]  401       ld		a, (de)
   0411 D3 BE         [11]  402 	    out   (vdp_data),a
   0413 13            [ 6]  403       inc		de
   0414 0D            [ 4]  404 			dec		c
   0415 20 F9         [12]  405       jr		nz, v2v_loop2
   0417 C1            [10]  406 			pop		bc
                            407 
   0418 FD E1         [14]  408 			pop 	iy
   041A DD E1         [14]  409 			pop 	ix
   041C E1            [10]  410 			pop 	hl
   041D D1            [10]  411 			pop 	de
   041E C1            [10]  412 			pop		bc
   041F C9            [10]  413 			ret
                            414 
                            415 
                            416 
                            417 
                            418 
   0420                     419 font_data::
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 21.
Hexadecimal [16-Bits]



                            420 	.include "sc3k_bios_vdp_font_pck.inc"
                              1 
   0420 00 07 00 00 74 00     2 .db 0x00, 0x07, 0x00, 0x00, 0x74, 0x00, 0x00, 0x20, 0xD4, 0x00, 0x00, 0x01, 0x50, 0xB8, 0x00, 0x0F
        00 20 D4 00 00 01
        50 B8 00 0F
   0430 98 06 F8 01 50 81     3 .db 0x98, 0x06, 0xF8, 0x01, 0x50, 0x81, 0x11, 0x78, 0xA0, 0x70, 0x28, 0xF0, 0x17, 0x00, 0xC8, 0xC8
        11 78 A0 70 28 F0
        17 00 C8 C8
   0440 10 20 40 98 98 00     4 .db 0x10, 0x20, 0x40, 0x98, 0x98, 0x00, 0x00, 0x40, 0xA0, 0xA0, 0x40, 0xA8, 0x90, 0x68, 0xC7, 0x2F
        00 40 A0 A0 40 A8
        90 68 C7 2F
   0450 40 27 19 15 00 14     5 .db 0x40, 0x27, 0x19, 0x15, 0x00, 0x14, 0x20, 0x10, 0x17, 0x03, 0x10, 0xC8, 0x0B, 0x17, 0xA8, 0x70
        20 10 17 03 10 C8
        0B 17 A8 70
   0460 0D 20 70 A8 20 50     6 .db 0x0D, 0x20, 0x70, 0xA8, 0x20, 0x50, 0x67, 0xF8, 0x50, 0x00, 0x0B, 0x30, 0x18, 0x06, 0x5D, 0x78
        67 F8 50 00 0B 30
        18 06 5D 78
   0470 6B C9 10 30 03 08     7 .db 0x6B, 0xC9, 0x10, 0x30, 0x03, 0x08, 0x2D, 0x8C, 0x80, 0x0A, 0x6C, 0x48, 0x00, 0x0F, 0x20, 0x46
        2D 8C 80 0A 6C 48
        00 0F 20 46
   0480 60 80 86 70 00 70     8 .db 0x60, 0x80, 0x86, 0x70, 0x00, 0x70, 0x88, 0x18, 0xB4, 0xF8, 0x07, 0x30, 0x08, 0x20, 0x88, 0x70
        88 18 B4 F8 07 30
        08 20 88 70
   0490 1F 50 90 90 F8 41     9 .db 0x1F, 0x50, 0x90, 0x90, 0xF8, 0x41, 0x10, 0x5F, 0xF8, 0x80, 0xF0, 0x08, 0x0F, 0xA4, 0x70, 0x80
        10 5F F8 80 F0 08
        0F A4 70 80
   04A0 08 88 C6 07 F8 27    10 .db 0x08, 0x88, 0xC6, 0x07, 0xF8, 0x27, 0xE4, 0x60, 0x27, 0x88, 0xDD, 0x02, 0x07, 0x4E, 0x78, 0x11
        E4 60 27 88 DD 02
        07 4E 78 11
   04B0 60 5B 37 5E 07 8C    11 .db 0x60, 0x5B, 0x37, 0x5E, 0x07, 0x8C, 0x77, 0xD8, 0x4D, 0x9A, 0x9C, 0x08, 0x7E, 0x46, 0x80, 0xEC
        77 D8 4D 9A 9C 08
        7E 46 80 EC
   04C0 0C A7 6E 2F 63 1D    12 .db 0x0C, 0xA7, 0x6E, 0x2F, 0x63, 0x1D, 0x20, 0x67, 0x48, 0x48, 0xA8, 0xB3, 0xA4, 0x09, 0x50, 0x10
        20 67 48 48 A8 B3
        A4 09 50 10
   04D0 F8 88 02 00 F0 8C    13 .db 0xF8, 0x88, 0x02, 0x00, 0xF0, 0x8C, 0x93, 0x70, 0x02, 0xF0, 0x17, 0x26, 0x68, 0x80, 0x57, 0x63
        93 70 02 F0 17 26
        68 80 57 63
   04E0 0F 48 0F 6A 7F 77    14 .db 0x0F, 0x48, 0x0F, 0x6A, 0x7F, 0x77, 0x02, 0x74, 0xF8, 0x07, 0x80, 0xD6, 0x1F, 0xB8, 0x77, 0xDB
        02 74 F8 07 80 D6
        1F B8 77 DB
   04F0 03 36 37 45 F5 BF    15 .db 0x03, 0x36, 0x37, 0x45, 0xF5, 0xBF, 0x1C, 0xB3, 0x08, 0x00, 0x17, 0x80, 0x90, 0xA0, 0xC0, 0xA0
        1C B3 08 00 17 80
        90 A0 C0 A0
   0500 4E 90 17 80 00 12    16 .db 0x4E, 0x90, 0x17, 0x80, 0x00, 0x12, 0xF8, 0x0F, 0xD8, 0x65, 0xD0, 0x27, 0x88, 0xC8, 0xA8, 0x98
        F8 0F D8 65 D0 27
        88 C8 A8 98
   0510 DD 07 34 CA 3A 5F    17 .db 0xDD, 0x07, 0x34, 0xCA, 0x3A, 0x5F, 0x04, 0xEA, 0x4F, 0x00, 0x95, 0xD7, 0xDD, 0x0F, 0x37, 0xC4
        04 EA 4F 00 95 D7
        DD 0F 37 C4
   0520 5F 70 EF 6C C4 A4    18 .db 0x5F, 0x70, 0xEF, 0x6C, 0xC4, 0xA4, 0x99, 0xF1, 0x2E, 0xC7, 0x6F, 0x33, 0x00, 0x50, 0x0F, 0x9A
        99 F1 2E C7 6F 33
        00 50 0F 9A
   0530 51 9F 6D 0C 8C BA    19 .db 0x51, 0x9F, 0x6D, 0x0C, 0x8C, 0xBA, 0xE3, 0x07, 0x27, 0x52, 0xF8, 0xD7, 0xC4, 0x57, 0x38, 0xE1
        E3 07 27 52 F8 D7
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 22.
Hexadecimal [16-Bits]



        C4 57 38 E1
   0540 36 38 17 53 16 90    20 .db 0x36, 0x38, 0x17, 0x53, 0x16, 0x90, 0x91, 0xE7, 0x8D, 0x10, 0x00, 0x8E, 0xE7, 0x27, 0x84, 0xA1
        91 E7 8D 10 00 8E
        E7 27 84 A1
   0550 08 F0 50 DB 24 8F    21 .db 0x08, 0xF0, 0x50, 0xDB, 0x24, 0x8F, 0xAF, 0x0F, 0x4B, 0x70, 0x1D, 0x7F, 0x22, 0x8A, 0x22, 0xB0
        AF 0F 4B 70 1D 7F
        22 8A 22 B0
   0560 C8 A3 6A B0 0F 88    22 .db 0xC8, 0xA3, 0x6A, 0xB0, 0x0F, 0x88, 0xFF, 0x36, 0xCD, 0x24, 0x68, 0xAF, 0x4B, 0x98, 0x17, 0x0F
        FF 36 CD 24 68 AF
        4B 98 17 0F
   0570 62 FB 93 0F 18 D7    23 .db 0x62, 0xFB, 0x93, 0x0F, 0x18, 0xD7, 0xC4, 0xCF, 0xEE, 0x17, 0x48, 0xF1, 0x70, 0xE3, 0x2F, 0x7F
        C4 CF EE 17 48 F1
        70 E3 2F 7F
   0580 29 11 C0 DA 1F 4D    24 .db 0x29, 0x11, 0xC0, 0xDA, 0x1F, 0x4D, 0x61, 0x30, 0x67, 0x90, 0x60, 0xBC, 0x29, 0x81, 0x21, 0xD0
        61 30 67 90 60 BC
        29 81 21 D0
   0590 88 15 C6 17 C6 00    25 .db 0x88, 0x15, 0xC6, 0x17, 0xC6, 0x00, 0xD0, 0xA8, 0x00, 0x67, 0x07, 0x2F, 0x3B, 0x4F, 0xCF, 0x1B
        D0 A8 00 67 07 2F
        3B 4F CF 1B
   05A0 07 92 F1 94 C2 49    26 .db 0x07, 0x92, 0xF1, 0x94, 0xC2, 0x49, 0x07, 0x38, 0x07, 0x38, 0x6D, 0x6C, 0x1F, 0x8F, 0xAC, 0xAF
        07 38 07 38 6D 6C
        1F 8F AC AF
   05B0 E4 80 A4 F7 9C 6E    27 .db 0xE4, 0x80, 0xA4, 0xF7, 0x9C, 0x6E, 0xB3, 0x18, 0x0F, 0x2E, 0x23, 0x87, 0x88, 0xFF, 0xE7, 0x07
        B3 18 0F 2E 23 87
        88 FF E7 07
   05C0 32 4E AB B6 80 58    28 .db 0x32, 0x4E, 0xAB, 0xB6, 0x80, 0x58, 0xE2, 0x17, 0x1E, 0x8A, 0x8F, 0x07, 0x53, 0xF8, 0xBF, 0x0A
        E2 17 1E 8A 8F 07
        53 F8 BF 0A
   05D0 18 A0 CD 37 AE D5    29 .db 0x18, 0xA0, 0xCD, 0x37, 0xAE, 0xD5, 0x31, 0x03, 0xC0, 0x03, 0x52, 0xAF, 0x29, 0xC0, 0x81, 0x51
        31 03 C0 03 52 AF
        29 C0 81 51
   05E0 A8 F1 DD F7 78 47    30 .db 0xA8, 0xF1, 0xDD, 0xF7, 0x78, 0x47, 0xD0, 0x2E, 0xFC, 0x0F, 0xB8, 0x07, 0xDE, 0x0F, 0x1A, 0x9D
        D0 2E FC 0F B8 07
        DE 0F 1A 9D
   05F0 E0 07 3A 3C 27 77    31 .db 0xE0, 0x07, 0x3A, 0x3C, 0x27, 0x77, 0x3C, 0x0F, 0x27, 0xD3, 0xE0, 0x27, 0xBE, 0x0F, 0x95, 0x0C
        3C 0F 27 D3 E0 27
        BE 0F 95 0C
   0600 98 B8 6E 0C E8 0F    32 .db 0x98, 0xB8, 0x6E, 0x0C, 0xE8, 0x0F, 0x80, 0x40, 0xE2, 0x0F, 0xED, 0xB7, 0x5F, 0x2D, 0x9C, 0x38
        80 40 E2 0F ED B7
        5F 2D 9C 38
   0610 46 8C A4 A3 17 06    33 .db 0x46, 0x8C, 0xA4, 0xA3, 0x17, 0x06, 0xA8, 0x54, 0x01, 0x94, 0x84, 0xC6, 0x55, 0xB1, 0x0D, 0x28
        A8 54 01 94 84 C6
        55 B1 0D 28
   0620 44 84 7F D4 20 04    34 .db 0x44, 0x84, 0x7F, 0xD4, 0x20, 0x04, 0xC7, 0xCD, 0x10, 0x33, 0xD8, 0x3C, 0x09, 0x08, 0x04, 0x00
        C7 CD 10 33 D8 3C
        09 08 04 00
   0630 04 0C 1C 1C 3C 3C    35 .db 0x04, 0x0C, 0x1C, 0x1C, 0x3C, 0x3C, 0x7C, 0xFC, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8
        7C FC 00 80 C0 E0
        E0 F0 F0 F8
   0640 FC 28 FC 7C 0D 11    36 .db 0xFC, 0x28, 0xFC, 0x7C, 0x0D, 0x11, 0x0C, 0x04, 0x28, 0xFC, 0xF8, 0x0D, 0x11, 0xC0, 0x80, 0x8E
        0C 04 28 FC F8 0D
        11 C0 80 8E
   0650 B3 FA 06 73 FC 05    37 .db 0xB3, 0xFA, 0x06, 0x73, 0xFC, 0x05, 0x00, 0xCF, 0x11, 0x8F, 0x20, 0x85, 0x97, 0x75, 0x00, 0x49
        00 CF 11 8F 20 85
        97 75 00 49
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 23.
Hexadecimal [16-Bits]



   0660 BB D8 3B BF 24 D2    38 .db 0xBB, 0xD8, 0x3B, 0xBF, 0x24, 0xD2, 0xA7, 0x07, 0x0E, 0x18, 0x07, 0x9D, 0xC0, 0x07, 0x3A, 0x00
        A7 07 0E 18 07 9D
        C0 07 3A 00
   0670 1F 9C 27 20 07 1D    39 .db 0x1F, 0x9C, 0x27, 0x20, 0x07, 0x1D, 0x48, 0xB0, 0x17, 0x39, 0x70, 0x07, 0x61, 0x10, 0x9C, 0x90
        48 B0 17 39 70 07
        61 10 9C 90
   0680 69 A7 30 28 10 E0    40 .db 0x69, 0xA7, 0x30, 0x28, 0x10, 0xE0, 0xE2, 0x07, 0x2E, 0xE5, 0x0F, 0x70, 0x07, 0xD4, 0xC6, 0x5C
        E2 07 2E E5 0F 70
        07 D4 C6 5C
   0690 07 C5 C7 07 CE 3F    41 .db 0x07, 0xC5, 0xC7, 0x07, 0xCE, 0x3F, 0x5A, 0x81, 0xDE, 0xF7, 0x73, 0x07, 0x37, 0x49, 0xBF, 0xFD
        5A 81 DE F7 73 07
        37 49 BF FD
   06A0 33 E0 1F 28 80 89    42 .db 0x33, 0xE0, 0x1F, 0x28, 0x80, 0x89, 0xE7, 0x38, 0x2F, 0x9C, 0x0F, 0xED, 0x77, 0xCF, 0x30, 0x28
        E7 38 2F 9C 0F ED
        77 CF 30 28
   06B0 E9 0F 70 0F CC AF    43 .db 0xE9, 0x0F, 0x70, 0x0F, 0xCC, 0xAF, 0x71, 0xB7, 0x49, 0xE1, 0x47, 0x07, 0x34, 0xC5, 0xC5, 0xCF
        71 B7 49 E1 47 07
        34 C5 C5 CF
   06C0 E6 37 71 0F 47 9C    44 .db 0xE6, 0x37, 0x71, 0x0F, 0x47, 0x9C, 0x07, 0x3A, 0x00, 0x27, 0x8E, 0xAF, 0x1C, 0x88, 0x47, 0x53
        07 3A 00 27 8E AF
        1C 88 47 53
   06D0 EF 16 BA CE 0F 74    45 .db 0xEF, 0x16, 0xBA, 0xCE, 0x0F, 0x74, 0x07, 0x40, 0xEB, 0x07, 0x2F, 0x39, 0x07, 0x74, 0x70, 0x07
        07 40 EB 07 2F 39
        07 74 70 07
   06E0 68 0A B0 90 B0 E8    46 .db 0x68, 0x0A, 0xB0, 0x90, 0xB0, 0xE8, 0x9E, 0xE2, 0xA0, 0xB2, 0x44, 0x64, 0x60, 0x86, 0xF0, 0x64
        9E E2 A0 B2 44 64
        60 86 F0 64
   06F0 90 74 68 18 15 28    47 .db 0x90, 0x74, 0x68, 0x18, 0x15, 0x28, 0x48, 0xC8, 0xA6, 0x8C, 0x48, 0x15, 0x95, 0xF5, 0xA2, 0x15
        48 C8 A6 8C 48 15
        95 F5 A2 15
   0700 9E A0 1A 4F 70 98    48 .db 0x9E, 0xA0, 0x1A, 0x4F, 0x70, 0x98, 0xA8, 0xC8, 0xAA, 0xC7, 0xD7, 0xB9, 0x2D, 0x50, 0xD8, 0xBD
        A8 C8 AA C7 D7 B9
        2D 50 D8 BD
   0710 9D 8F 5C D9 CD 4F    49 .db 0x9D, 0x8F, 0x5C, 0xD9, 0xCD, 0x4F, 0x6B, 0x20, 0xE1, 0x53, 0xD7, 0x13, 0x08, 0x1C, 0xD8, 0x98
        6B 20 E1 53 D7 13
        08 1C D8 98
   0720 7F 70 9A 18 A0 92    50 .db 0x7F, 0x70, 0x9A, 0x18, 0xA0, 0x92, 0xE3, 0x00, 0xFD, 0xBB, 0xC0, 0x00, 0xA7, 0xE0, 0x00, 0x4E
        E3 00 FD BB C0 00
        A7 E0 00 4E
   0730 1C 00 9D 0C 00 3A    51 .db 0x1C, 0x00, 0x9D, 0x0C, 0x00, 0x3A, 0x04, 0x00, 0xA6, 0xCB, 0xDD, 0x70, 0x00, 0x53, 0xDD, 0x15
        04 00 A6 CB DD 70
        00 53 DD 15
   0740 CF AE 50 01 6B C9    52 .db 0xCF, 0xAE, 0x50, 0x01, 0x6B, 0xC9, 0x8C, 0x0F, 0xDD, 0x3B, 0x47, 0xBF, 0xDE, 0x15, 0xF8, 0x00
        8C 0F DD 3B 47 BF
        DE 15 F8 00
   0750 07 BF 00 BC 20 D9    53 .db 0x07, 0xBF, 0x00, 0xBC, 0x20, 0xD9, 0x47, 0xFF, 0xCE, 0x94, 0xB6, 0x4F, 0xCD, 0x56, 0x10, 0x6E
        47 FF CE 94 B6 4F
        CD 56 10 6E
   0760 70 FF D8 CF F8 60    54 .db 0x70, 0xFF, 0xD8, 0xCF, 0xF8, 0x60, 0xA8, 0x17, 0x78, 0xFC, 0xB4, 0x0B, 0xB4, 0xFC, 0xCC, 0x78
        A8 17 78 FC B4 0B
        B4 FC CC 78
   0770 E0 63 B7 AC 8D 4C    55 .db 0xE0, 0x63, 0xB7, 0xAC, 0x8D, 0x4C, 0x15, 0x56, 0xA8, 0xA7, 0x81, 0xDC, 0x48, 0x78, 0x48, 0xDC
        15 56 A8 A7 81 DC
        48 78 48 DC
   0780 00 27 98 C8 B9 18    56 .db 0x00, 0x27, 0x98, 0xC8, 0xB9, 0x18, 0xA2, 0xA9, 0x03, 0x9E, 0x00, 0x1F, 0x00, 0xFF, 0xF0
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 24.
Hexadecimal [16-Bits]



        A2 A9 03 9E 00 1F
        00 FF F0
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 25.
Hexadecimal [16-Bits]



   078F                     421 font_data_end::
                            422 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 26.
Hexadecimal [16-Bits]



                            170 .include "sc3k_bios_conio.inc"
                              1 ; ASCII
                     0008     2 ASC_BS   = 0x08
                     000C     3 ASC_FF   = 0x0C
                     000D     4 ASC_CR   = 0x0D
                     000A     5 ASC_LF 	 = 0x0A
                     000B     6 ASC_HOME = 0x0B
                     000C     7 ASC_CLS  = 0x0C
                     0020     8 ASC_SP   = 0x20
                              9 
                     0800    10 vdp_tilemap_addr	= 0x0800
                     03C0    11 vdp_tilemap_size	= (screen_columns * screen_rows)
                             12 
                     1800    13 vdp_tiledat_addr = 0x1800
                     0800    14 vdp_tiledat_size = 2048
                             15 
                     0000    16 cursor_x_home		= 0
                     0028    17 screen_columns	= 40
                             18 
                     0000    19 cursor_y_home		= 0
                     0018    20 screen_rows     = 24
                             21 
                     0090    22 CURSOR_ASCII		= 144
                             23 ;CURSOR_ASCII		= 153
                             24 .globl	write_char_value, cursor_x, cursor_y, vram_copy_buffer
                             25 .globl	cursor_enabled, cursor_visible_ff, cursor_visible_cnt, cursor_char_saved
                             26 .globl	vdp_vram2ram, vdp_vram2vram, vdp_vramShiftBack
                             27 
                             28 
                             29 ;.area	_CODE
                             30 ; ==================================================
                             31 
   078F                      32 conio_reset::
   078F CD 9B 09      [17]   33 		call	TEXT_CURSOR_RESET
   0792 C9            [10]   34 		ret
                             35 
                             36 
   0793                      37 conio_write_text::
   0793 CD AE 09      [17]   38 		call	TEXT_CURSOR_OFF
   0796 D5            [11]   39 		push	de
   0797 E5            [11]   40 		push	hl
                             41 
   0798                      42 write_text:
   0798 7E            [ 7]   43 		ld	a, (hl)
   0799 23            [ 6]   44 		inc	hl
   079A B7            [ 4]   45 		or	a
   079B 28 07         [12]   46 		jr	z, write_text_exit
                             47 
   079D E5            [11]   48 		push	hl
   079E CD 06 08      [17]   49 		call	conio_write_char_inner
   07A1 E1            [10]   50 		pop	hl
                             51 		
   07A2 18 F4         [12]   52 		jr	write_text
                             53 
   07A4                      54 write_text_exit:
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 27.
Hexadecimal [16-Bits]



                             55 
   07A4 E1            [10]   56 		pop	hl
   07A5 D1            [10]   57 		pop	de
   07A6 CD 5A 09      [17]   58 		call	TEXT_CURSOR_ON
   07A9 C9            [10]   59 		ret
                             60 
                             61 
   07AA                      62 conio_write_char::
   07AA B7            [ 4]   63 		or	a
   07AB C8            [11]   64 		ret	z
   07AC CD AE 09      [17]   65 		call	TEXT_CURSOR_OFF
   07AF CD 06 08      [17]   66 		call	conio_write_char_inner
   07B2 CD 5A 09      [17]   67 		call	TEXT_CURSOR_ON
   07B5 C9            [10]   68 		ret
                             69 
                             70 
                             71 
                             72 		
                             73 
                             74 
                             75 
                             76 
                             77 ;       process the 40 col control codes
                             78 ;conio_control_codes:
                             79 ;				cp			#0x07									; BELL
                             80 ;				jp			z, conio_ctrl_end
                             81 ;				cp			#0x08									; BACKSPACE
                             82 ;				jp			z, conio_ctrl_end
                             83 ;				cp			#0x09									; TAB
                             84 ;				jp			z, conio_ctrl_end
                             85 ;				cp			#0x0D									; ENTER
                             86 ;				jp			z, conio_ctrl_end
                             87 ;				cp			#0x1B									; ESC
                             88 ;				jp			z, conio_ctrl_end
                             89 ;conio_ctrl_end:
                             90 ;				ret
                             91 
                             92 
                             93 
                             94 
                             95 ;#######################################
                             96 ; Write char
                             97 ;#######################################
                             98 ; writes char in a
                             99 
   07B6                     100 cursor_incX_wrap:
   07B6 CD C0 07      [17]  101 			call	cursor_incX
   07B9 C0            [11]  102 			ret		nz
   07BA 3E 00         [ 7]  103 			ld    a, #cursor_x_home													; wrap cursor to position 2 on next line
   07BC 32 45 FB      [13]  104       ld    (cursor_x),a
   07BF C9            [10]  105 			ret
                            106 
   07C0                     107 cursor_incX:
   07C0 3A 45 FB      [13]  108       ld		a,(cursor_x)
   07C3 3C            [ 4]  109       inc		a
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 28.
Hexadecimal [16-Bits]



   07C4 32 45 FB      [13]  110       ld		(cursor_x),a
   07C7 FE 28         [ 7]  111       cp		#cursor_x_home + screen_columns
   07C9 C9            [10]  112 			ret
                            113 
                            114 
   07CA                     115 cursor_decX_wrap:
   07CA CD D4 07      [17]  116 			call	cursor_decX
   07CD C0            [11]  117 			ret		nz
   07CE 3E 27         [ 7]  118       ld    a, #cursor_x_home + screen_columns - 1                ; cursor x = end of line
   07D0 32 45 FB      [13]  119       ld    (cursor_x),a
   07D3 C9            [10]  120 			ret
                            121 
   07D4                     122 cursor_decX:
   07D4 3A 45 FB      [13]  123       ld		a,(cursor_x)
   07D7 3D            [ 4]  124       dec		a
   07D8 32 45 FB      [13]  125       ld		(cursor_x),a
   07DB FE FF         [ 7]  126       cp		#cursor_x_home-1
   07DD C9            [10]  127 			ret
                            128 
                            129 
                            130 
                            131 
                            132 
   07DE                     133 cursor_incY_wrap:
   07DE CD E8 07      [17]  134 			call	cursor_incY
   07E1 C0            [11]  135 			ret		nz
   07E2 3E 00         [ 7]  136 			ld    a, #cursor_y_home													; wrap cursor to position 2 on next line
   07E4 32 46 FB      [13]  137       ld    (cursor_y),a
   07E7 C9            [10]  138 			ret
                            139 
   07E8                     140 cursor_incY:
   07E8 3A 46 FB      [13]  141       ld		a,(cursor_y)
   07EB 3C            [ 4]  142       inc		a
   07EC 32 46 FB      [13]  143       ld		(cursor_y),a
   07EF FE 18         [ 7]  144       cp		#cursor_y_home + screen_rows
   07F1 C9            [10]  145 			ret
                            146 
                            147 
   07F2                     148 cursor_decY_wrap:
   07F2 CD FC 07      [17]  149 			call	cursor_decY
   07F5 C0            [11]  150 			ret		nz
   07F6 3E 17         [ 7]  151       ld    a, #cursor_y_home + screen_rows - 1                ; cursor x = end of line
   07F8 32 46 FB      [13]  152       ld    (cursor_y),a
   07FB C9            [10]  153 			ret
                            154 
   07FC                     155 cursor_decY:
   07FC 3A 46 FB      [13]  156       ld		a,(cursor_y)
   07FF 3D            [ 4]  157       dec		a
   0800 32 46 FB      [13]  158       ld		(cursor_y),a
   0803 FE FF         [ 7]  159       cp		#cursor_y_home-1
   0805 C9            [10]  160 			ret
                            161 
                            162 
                            163 
                            164 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 29.
Hexadecimal [16-Bits]



                            165 ;-------------------------------------------------------
   0806                     166 conio_write_char_inner::
                            167 ;-------------------------------------------------------
   0806 F5            [11]  168 	    push   af
   0807 C5            [11]  169 	    push   bc
   0808 D5            [11]  170 	    push   de
   0809 E5            [11]  171 	    push   hl
   080A DD E5         [15]  172 	    push   ix
                            173 
   080C 32 42 FB      [13]  174       ld     (write_char_value),a
                            175 
   080F FE 1F         [ 7]  176 	cp     #0x1F
   0811 D2 4E 08      [10]  177 	jp     nc, VALID_CHAR                  ; do nothing for rest
                            178 
                            179 
                            180 ;      cp     #ASC_LF                                ; handle control codes
                            181 ;      jp     z, write_newline
                            182 
   0814 FE 0D         [ 7]  183       cp     #ASC_CR                                ; handle control codes
   0816 CA 6F 08      [10]  184       jp     z, write_CR
   0819 FE 0A         [ 7]  185       cp     #ASC_LF                                ; handle control codes
   081B CA 7C 08      [10]  186       jp     z, write_LF
                            187 
                            188 
                            189  
   081E FE 0C         [ 7]  190       cp     #ASC_FF
   0820 CA 8D 08      [10]  191       jp     z, write_formfeed
                            192  
   0823 FE 08         [ 7]  193       cp     #ASC_BS
   0825 CA B2 08      [10]  194       jp     z, write_backspace
                            195 	
   0828 FE 0B         [ 7]  196 	cp	#ASC_HOME
   082A CA BF 09      [10]  197 	jp	z, TEXT_CURSOR_HOME
                            198   
   082D FE 0C         [ 7]  199       cp     #ASC_CLS
   082F CA 8D 08      [10]  200       jp     z, write_formfeed
                            201 
   0832 FE 1C         [ 7]  202 	cp	#0x1C									; CURSOR RIGHT
   0834 CA A0 08      [10]  203 	jp	z, write_cursor_right
                            204 	
   0837 FE 1D         [ 7]  205 	cp	#0x1D									; CURSOR LEFT
   0839 CA 96 08      [10]  206 	jp	z, write_cursor_left
                            207 	
   083C FE 1E         [ 7]  208 	cp	#0x1E									; CURSOR UP
   083E CA 9B 08      [10]  209 	jp	z, write_cursor_up
                            210 	
   0841 FE 1F         [ 7]  211 	cp	#0x1F									; CURSOR DOWN
   0843 CA A6 08      [10]  212 	jp	z, write_cursor_down
                            213 
   0846 FE 20         [ 7]  214 	cp     #SP                                 ; make sure char is in ASCII range (32<=n<128)
   0848 DA D7 08      [10]  215 	jp     c, write_char_exit
                            216 	
                            217 ;	cp     #0x80
                            218 ;	jp     nc, write_char_exit                  ; do nothing for rest
                            219 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 30.
Hexadecimal [16-Bits]



                            220 
   084B C3 D7 08      [10]  221 	jp     write_char_exit                  ; do nothing for rest
                            222 
   084E                     223 VALID_CHAR:
   084E CD 3E 09      [17]  224 	call   calc_cursor_address
   0851 CD 0A 03      [17]  225 	call   set_vram_write_address_to_hl
                            226 			
   0854 3A 36 FB      [13]  227 	ld	a, (cursor_insert_mode)
   0857 B7            [ 4]  228 	or	a
   0858 28 09         [12]  229 	jr	z, no_insert_mode
                            230 	
   085A 11 A0 00      [10]  231 	ld	de, #160
   085D CD DE 08      [17]  232 	call	insert_at_curr_address
                            233 			
   0860 CD 0A 03      [17]  234       	call   set_vram_write_address_to_hl
   0863                     235 no_insert_mode:
                            236 
   0863 3A 42 FB      [13]  237 	ld	a,(write_char_value)                ; write value
   0866 CD 17 03      [17]  238 	call	wait_and_output_a_to_vdp
                            239 
   0869 CD B6 07      [17]  240 	call	cursor_incX_wrap
   086C C2 D7 08      [10]  241 	jp	nz, write_char_exit
                            242 
                            243 
                            244 ;-------------------------------------------------------
   086F                     245 write_CR:
                            246 ;-------------------------------------------------------
   086F 3E 00         [ 7]  247 	ld	a, #cursor_x_home
   0871 32 45 FB      [13]  248       	ld	(cursor_x),a
   0874 C3 D7 08      [10]  249 	jp	write_char_exit
                            250 
                            251 
                            252 ;-------------------------------------------------------
   0877                     253 write_newline: 																	
                            254 ;-------------------------------------------------------
   0877 3E 00         [ 7]  255 	ld	a, #cursor_x_home																			; wrap cursor to position 2 on next line
   0879 32 45 FB      [13]  256       	ld	(cursor_x),a
                            257 
                            258 ;-------------------------------------------------------
   087C                     259 write_LF:
                            260 ;-------------------------------------------------------
   087C CD E8 07      [17]  261 	call	cursor_incY
   087F C2 D7 08      [10]  262 	jp	nz, write_char_exit
                            263 
   0882                     264 write_newline_scroll_screen:
   0882 CD 1D 09      [17]  265 	call	screen_scroll_up
   0885 3E 17         [ 7]  266 	ld	a, #cursor_y_home+screen_rows-1		; put cursor at row 23
   0887 32 46 FB      [13]  267 	ld	(cursor_y),a
   088A C3 D7 08      [10]  268 	jp	write_char_exit
                            269 
   088D                     270 write_formfeed: ; clear screen, reset cursor
   088D CD BF 09      [17]  271 	call	TEXT_CURSOR_HOME
   0890 CD CB 09      [17]  272 	call	TEXT_CLEAR_SCREEN
   0893 C3 D7 08      [10]  273 	jp	write_char_exit
                            274 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 31.
Hexadecimal [16-Bits]



                            275 
   0896                     276 write_cursor_left:
   0896 CD CA 07      [17]  277 			call	 cursor_decX_wrap
   0899 20 3C         [12]  278       jr		 nz, write_char_exit
                            279 
   089B                     280 write_cursor_up:
   089B CD F2 07      [17]  281 			call	 cursor_decY_wrap
   089E 18 37         [12]  282 			jr		 write_char_exit
                            283 
   08A0                     284 write_cursor_right:
   08A0 CD B6 07      [17]  285 			call	 cursor_incX_wrap
   08A3 C2 D7 08      [10]  286 			jp		 nz, write_char_exit
                            287 
   08A6                     288 write_cursor_down:
   08A6 CD DE 07      [17]  289 			call	 cursor_incY_wrap
   08A9 20 2C         [12]  290 			jr		 nz, write_char_exit
                            291 
   08AB 3E 00         [ 7]  292 			ld		 a, #0
   08AD 32 46 FB      [13]  293 			ld     (cursor_y),a
                            294 
   08B0 18 25         [12]  295 			jr		 write_char_exit
                            296 
                            297 
                            298 
   08B2                     299 write_backspace:
   08B2 CD D4 07      [17]  300 			call	 cursor_decX
   08B5 20 15         [12]  301       jr		 nz, delete_char_from_tilemap
                            302 
   08B7                     303 write_backspace_wrap_to_previous_line:
   08B7 3A 46 FB      [13]  304       ld     a,(cursor_y)                        ; move cursor to end of prevous line
   08BA 3D            [ 4]  305       dec    a
   08BB 32 46 FB      [13]  306       ld     (cursor_y),a
   08BE FE FF         [ 7]  307       cp     #-1                                  ; check if its -1
   08C0 3E 27         [ 7]  308       ld     a, #screen_columns-1                  ; cursor x = end of line
   08C2 32 45 FB      [13]  309       ld     (cursor_x),a
   08C5 20 05         [12]  310       jr     nz, delete_char_from_tilemap         ; if it wasnt -1 then were done
                            311       
   08C7                     312 write_backspace_reached_top_left:
   08C7 CD BF 09      [17]  313 			call		TEXT_CURSOR_HOME
   08CA 18 0B         [12]  314       jr     	write_char_exit                     ; nothing to delete
                            315 
   08CC                     316 delete_char_from_tilemap:
   08CC CD 3E 09      [17]  317 			call	 calc_cursor_address
   08CF CD 0A 03      [17]  318       call   set_vram_write_address_to_hl
   08D2 3E 20         [ 7]  319       ld     a, #SP                               ; write space = blank
   08D4 CD 17 03      [17]  320       call   wait_and_output_a_to_vdp
                            321 
   08D7                     322 write_char_exit:
   08D7 DD E1         [14]  323 	    pop    ix
   08D9 E1            [10]  324 	    pop    hl
   08DA D1            [10]  325 	    pop    de
   08DB C1            [10]  326 	    pop    bc
   08DC F1            [10]  327 	    pop    af
   08DD C9            [10]  328 	    ret
                            329 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 32.
Hexadecimal [16-Bits]



                            330 
                            331 ; hl = vram address
                            332 ; de = len of area to move
                            333 ;-------------------------------------------------------
   08DE                     334 insert_at_curr_address:
                            335 ;-------------------------------------------------------
   08DE C5            [11]  336 			push		bc
   08DF D5            [11]  337 			push		de
   08E0 E5            [11]  338 			push		hl
   08E1 DD E5         [15]  339 			push		ix
   08E3 FD E5         [15]  340 			push		iy
                            341 			
   08E5 E5            [11]  342 			push		hl
   08E6 E5            [11]  343 			push		hl
   08E7 DD E1         [14]  344 			pop			ix						; IX = VRAM PTR
   08E9 FD E1         [14]  345 			pop			iy
   08EB FD 23         [10]  346 			inc			iy						; IY = VRAM PTR + 1
                            347 
                            348 
   08ED 19            [11]  349 			add			hl, de
   08EE EB            [ 4]  350 			ex			de, hl
   08EF 21 C0 0B      [10]  351 			ld			hl, #vdp_tilemap_addr + vdp_tilemap_size
   08F2 B7            [ 4]  352 			or			a
   08F3 ED 52         [15]  353 			sbc			hl, de																					; HL = VRAMEND - (CURSPTR+160)
   08F5 F2 11 09      [10]  354 			jp			p, noAddRow
                            355 			
   08F8 CD FC 07      [17]  356 			call		cursor_decY																			; if (CURSPTR+160 > VRAM END) { CURSY--; SCRY-- VSRC-=160; VDST-=160; }
   08FB DD E5         [15]  357 			push		ix
   08FD FD E5         [15]  358 			push		iy
   08FF CD 1D 09      [17]  359 			call	 	screen_scroll_up
   0902 FD E1         [14]  360 			pop			iy
   0904 DD E1         [14]  361 			pop			ix
                            362 
                            363 
   0906 21 00 00      [10]  364 			ld			hl, #0
   0909 AF            [ 4]  365 			xor			a
   090A ED 52         [15]  366 			sbc			hl, de																					; HL = -DE
   090C EB            [ 4]  367 			ex			de, hl
                            368 
   090D DD 19         [15]  369 			add			ix, de
   090F FD 19         [15]  370 			add			iy, de
   0911                     371 noAddRow:
   0911 4B            [ 4]  372 			ld			c, e
   0912 CD E5 03      [17]  373 			call		vdp_vram2vram																		; *VDST = *VSRC
                            374 
   0915 FD E1         [14]  375 			pop			iy
   0917 DD E1         [14]  376 			pop			ix
   0919 E1            [10]  377 			pop			hl
   091A D1            [10]  378 			pop			de
   091B C1            [10]  379 			pop			bc
   091C C9            [10]  380 			ret
                            381 
                            382 
                            383 
   091D                     384 screen_scroll_up:
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 33.
Hexadecimal [16-Bits]



   091D DD 21 28 08   [14]  385       ld     	ix, #vdp_tilemap_addr + screen_columns  	; from second row
   0921 FD 21 00 08   [14]  386       ld     	iy, #vdp_tilemap_addr                   	; copy to start of tilemap
   0925 01 98 03      [10]  387 			ld			bc, #screen_columns * (screen_rows - 1)		; 40*23 rows back 1 row
   0928 CD BC 03      [17]  388 			call		vdp_vramShiftBack
                            389 
                            390 ;-------------------------------------------------------
   092B                     391 clear_line_at_current_address:
                            392 ;-------------------------------------------------------
   092B 06 0A         [ 7]  393       ld     b,#10                                			; loop 10 times (unrolled by 4)
   092D 3E 20         [ 7]  394       ld     a,#SP                               				; write a space
   092F                     395 clr_line_loop:    
   092F CD 17 03      [17]  396 			call   wait_and_output_a_to_vdp
   0932 CD 17 03      [17]  397       call   wait_and_output_a_to_vdp
   0935 CD 17 03      [17]  398       call   wait_and_output_a_to_vdp
   0938 CD 17 03      [17]  399       call   wait_and_output_a_to_vdp
   093B 10 F2         [13]  400       djnz   clr_line_loop
   093D C9            [10]  401 			ret
                            402 
                            403 
                            404 
                            405 
                            406 
                            407 ;-------------------------------------------------------
   093E                     408 calc_cursor_address:
                            409 ;-------------------------------------------------------
   093E 21 45 FB      [10]  410 	ld	hl, #cursor_x
   0941 CD EE 09      [17]  411 	call	TEXT_COORDS_TO_PTR
   0944 C9            [10]  412 	ret
                            413 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 34.
Hexadecimal [16-Bits]



                            171 .include "sc3k_bios_text.inc"
                              1 
                              2 ;-------------------------------------------------------
   0945                       3 TEXT_INSERT_ON::
                              4 ;-------------------------------------------------------
   0945 3E FF         [ 7]    5 		ld		a, #0xFF
   0947 18 01         [12]    6 		jr		TEXT_INSERT_MODE
                              7 ;-------------------------------------------------------
   0949                       8 TEXT_INSERT_OFF::
                              9 ;-------------------------------------------------------
   0949 AF            [ 4]   10 		xor		a
                             11 ;-------------------------------------------------------
   094A                      12 TEXT_INSERT_MODE::
                             13 ;-------------------------------------------------------
   094A 32 36 FB      [13]   14 		ld		(cursor_insert_mode), a
   094D C9            [10]   15 		ret
                             16 
                             17 
                             18 
   094E                      19 TEXT_PUTCH::
   094E F5            [11]   20 	push	af
   094F CD 3E 09      [17]   21 	call	calc_cursor_address						; 1) Calc VRAM address
   0952 CD 0A 03      [17]   22 	call	set_vram_write_address_to_hl		; 2) Set WRITE address
   0955 F1            [10]   23 	pop	af
   0956 CD 17 03      [17]   24 	call   	wait_and_output_a_to_vdp				; 3) Write it
   0959 C9            [10]   25 	ret
                             26 
                             27 
                             28 ;-------------------------------------------------------
   095A                      29 TEXT_CURSOR_ON::
                             30 ;-------------------------------------------------------
   095A F5            [11]   31 	push	af
                             32 	
   095B CD EB 09      [17]   33 	call	TEXT_CURSOR_PTR									; 1) Calc VRAM address
   095E E5            [11]   34 	push	hl
                             35 	
                             36 	
   095F CD F4 02      [17]   37 	call	set_vram_read_address_to_hl			; 2) Set READ address
   0962 CD FF 02      [17]   38 	call	wait_and_read_from_vdp					; 3) Read char value from Screen
   0965 32 39 FB      [13]   39 	ld	(cursor_char_saved), a					; 4) Save it
                             40 	
   0968 26 00         [ 7]   41 	ld	h, #0
   096A 6F            [ 4]   42 	ld	l, a
   096B 29            [11]   43 	add	hl, hl													; * 2
   096C 29            [11]   44 	add	hl, hl													; * 4
   096D 29            [11]   45 	add	hl, hl													; * 8
                             46 	
   096E 11 00 18      [10]   47 	ld	de, #vdp_tiledat_addr
   0971 19            [11]   48 	add	hl, de													; HL = vdp_tiledat_addr + (CHAR * 8)
                             49 	
   0972 FD 21 3A FB   [14]   50 	ld	iy, #cursor_char_data_saved
   0976 01 08 00      [10]   51 	ld	bc, #8
   0979 CD 1E 03      [17]   52 	call	vdp_vram2ram										; save char data
                             53 	
                             54 	
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 35.
Hexadecimal [16-Bits]



                             55 	; Copy saved char DATA to CharCODE 255
   097C 21 F8 1F      [10]   56 	ld		hl, #vdp_tiledat_addr + vdp_tiledat_size - 8			; Point to charcode 255
   097F CD 0A 03      [17]   57 	call	set_vram_write_address_to_hl
                             58 	
   0982 21 3A FB      [10]   59 	ld		hl, #cursor_char_data_saved
   0985 06 08         [ 7]   60 	ld		b, #8
   0987                      61 invert_loop:
   0987 7E            [ 7]   62 	ld		a, (hl)
   0988 2F            [ 4]   63 	cpl
   0989 23            [ 6]   64 	inc		hl
   098A CD 17 03      [17]   65 	call  wait_and_output_a_to_vdp
   098D 05            [ 4]   66 	dec		b
   098E 20 F7         [12]   67 	jr		nz, invert_loop
                             68 	
                             69 	
                             70 	;ld		 a, #CURSOR_ASCII								; 5) Set <CURSOR_ASCII> char as cursor
   0990 3E FF         [ 7]   71 	ld		 a, #0xFF												; 5) Set 255 char as cursor
   0992 E1            [10]   72 	pop		hl															
   0993 CD 0A 03      [17]   73 	call   set_vram_write_address_to_hl		; 6) Set WRITE address
   0996 CD 17 03      [17]   74 	call   wait_and_output_a_to_vdp				; 7) Write it
                             75 	
   0999 F1            [10]   76 	pop		af
   099A C9            [10]   77 	ret
                             78 	
                             79 
                             80 ;-------------------------------------------------------
   099B                      81 TEXT_CURSOR_RESET:
                             82 ;-------------------------------------------------------
   099B 3E 20         [ 7]   83 			ld		a, #SP
   099D 32 39 FB      [13]   84 			ld		(cursor_char_saved), a
   09A0 AF            [ 4]   85 			xor		a
   09A1 32 38 FB      [13]   86 			ld		(cursor_visible_ff), a
                             87 			
   09A4 CD BF 09      [17]   88 			call	TEXT_CURSOR_HOME
   09A7 CD 45 09      [17]   89 			call	TEXT_INSERT_ON
   09AA CD 5A 09      [17]   90 			call	TEXT_CURSOR_ON
   09AD C9            [10]   91 			ret
                             92 
                             93 ;-------------------------------------------------------
   09AE                      94 TEXT_CURSOR_OFF::
                             95 ;-------------------------------------------------------
   09AE F5            [11]   96 	push	af
   09AF E5            [11]   97 	push	hl
                             98 			
   09B0                      99 TEXT_CURSOR_OFF_IN:
   09B0 CD 3E 09      [17]  100 	call	calc_cursor_address			; 1) Calc VRAM address
                            101 
   09B3 CD 0A 03      [17]  102 	call	set_vram_write_address_to_hl		; 2) Set WRITE address
   09B6 3A 39 FB      [13]  103 	ld	a, (cursor_char_saved)			; 3) Set <cursor_char_saved> as cursor
   09B9 CD 17 03      [17]  104 	call	wait_and_output_a_to_vdp		; 4) Write it
                            105 
   09BC E1            [10]  106 	pop	hl
   09BD F1            [10]  107 	pop	af
   09BE C9            [10]  108 	ret
                            109 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 36.
Hexadecimal [16-Bits]



                            110 
                            111 
                            112 ;-------------------------------------------------------
   09BF                     113 TEXT_CURSOR_HOME::
                            114 ;-------------------------------------------------------
   09BF F5            [11]  115 			push	af
                            116 
   09C0 AF            [ 4]  117 			xor		a
   09C1 32 46 FB      [13]  118 	    ld    (cursor_y),a
                            119 
   09C4 3E 00         [ 7]  120 	    ld    a, #cursor_x_home
   09C6 32 45 FB      [13]  121 	    ld    (cursor_x),a
   09C9 F1            [10]  122 			pop		af
                            123 
   09CA C9            [10]  124 			ret
                            125 
                            126 ;-------------------------------------------------------
   09CB                     127 TEXT_CLEAR_SCREEN:
                            128 ;-------------------------------------------------------
   09CB F5            [11]  129       push		af
   09CC C5            [11]  130       push		bc
   09CD E5            [11]  131       push		hl
                            132 
   09CE CD 07 03      [17]  133       call   	set_vram_write_address_to_home
                            134 
   09D1 01 F0 00      [10]  135       ld     	bc, #(screen_columns * screen_rows) / 4                ; fill tilemap with spaces
   09D4                     136 clear_screen_loop:
                            137 
   09D4 3E 20         [ 7]  138 			ld     	a, #SP
   09D6 CD 17 03      [17]  139       call   	wait_and_output_a_to_vdp
   09D9 CD 17 03      [17]  140       call   	wait_and_output_a_to_vdp
   09DC CD 17 03      [17]  141       call   	wait_and_output_a_to_vdp
   09DF CD 17 03      [17]  142       call   	wait_and_output_a_to_vdp
   09E2 0B            [ 6]  143       dec    	bc
   09E3 78            [ 4]  144       ld     	a,b
   09E4 B1            [ 4]  145       or     	c
   09E5 20 ED         [12]  146       jr     	nz,clear_screen_loop
                            147 
   09E7 E1            [10]  148 			pop			hl
   09E8 C1            [10]  149 			pop			bc
   09E9 F1            [10]  150 			pop			af
   09EA C9            [10]  151 			ret
                            152 
                            153 
                            154 
                            155 ; OUT: HL = VRAM PTR
                            156 ;-------------------------------------------------------
   09EB                     157 TEXT_CURSOR_PTR:
   09EB 21 45 FB      [10]  158 			ld		hl, #cursor_x
                            159 			; FALL DOWN...		
                            160 
                            161 ;  IN: HL = COORDS (YX)
                            162 ; OUT: HL = VRAM PTR
                            163 ;-------------------------------------------------------
   09EE                     164 TEXT_COORDS_TO_PTR:
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 37.
Hexadecimal [16-Bits]



                            165 ;-------------------------------------------------------
                            166       ; calculate tilemap address of cursor and write a space there
                            167       ; address = cursor_y * 40 + cursor_x + tilemap_address
                            168 
   09EE F5            [11]  169 	push		af
   09EF C5            [11]  170 	push		bc
   09F0 D5            [11]  171 	push		de
   09F1 DD E5         [15]  172 	push		ix
                            173 	
   09F3 E5            [11]  174 	push		hl
   09F4 DD E1         [14]  175 	pop		ix
                            176 
   09F6 21 00 00      [10]  177 	ld     	hl,#0
   09F9 11 28 00      [10]  178 	ld     	de, #screen_columns
   09FC DD 7E 01      [19]  179 	ld     	a, 1(IX)													; Y
   09FF 47            [ 4]  180 	ld     	b, a
   0A00 04            [ 4]  181 	inc    	b
   0A01                     182 calc_coords_address_loop:
   0A01 05            [ 4]  183 	dec    	b
   0A02 28 03         [12]  184 	jr     	z, calc_coords_address_exit
   0A04 19            [11]  185 	add    	hl, de
   0A05 18 FA         [12]  186 	jr     	calc_coords_address_loop
                            187 
   0A07                     188 calc_coords_address_exit:    
   0A07 DD 7E 00      [19]  189 	ld     	a, 0(IX)
   0A0A 16 00         [ 7]  190 	ld     	d, #0x00
   0A0C 5F            [ 4]  191 	ld     	e, a
   0A0D 19            [11]  192 	add    	hl, de
   0A0E 11 00 08      [10]  193 	ld     	de, #vdp_tilemap_addr
   0A11 19            [11]  194 	add    	hl, de
                            195       
   0A12 DD E1         [14]  196       pop			ix
   0A14 D1            [10]  197       pop    	de
   0A15 C1            [10]  198       pop			bc
   0A16 F1            [10]  199       pop			af
   0A17 C9            [10]  200 			ret		 
                            201 
                            202 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 38.
Hexadecimal [16-Bits]



                            172 .include "sc3k_bios_psg.inc"
                     007F     1 psg_port  = 0x7F
                              2 
                              3 .area	_CODE
                              4 ; ==================================================
                              5 
   0A18                       6 psg_reset::
   0A18 01 F4 01      [10]    7 	ld     bc, #500                               	; repeat count
                              8 	
   0A1B                       9 	psg_reset_once: 
                             10 ;---------------------------
   0A1B 3E FF         [ 7]   11 	ld     a, #0xff                                 ; pause: 4082 cycles = 1.14ms
   0A1D                      12 pause_1ms_inner:
   0A1D 3D            [ 4]   13 	dec   	a
   0A1E 20 FD         [12]   14 	jr      nz, pause_1ms_inner
                             15 ;---------------------------
   0A20 3E 9F         [ 7]   16 	ld     a, #0x9f                                 ; PSG: silence all channels
   0A22 D3 7F         [11]   17 	out    (psg_port),a
   0A24 3E BF         [ 7]   18 	ld     a, #0xbf
   0A26 D3 7F         [11]   19 	out    (psg_port),a
   0A28 3E DF         [ 7]   20 	ld     a, #0xdf
   0A2A D3 7F         [11]   21 	out    (psg_port),a
   0A2C 3E FF         [ 7]   22 	ld     a, #0xff
   0A2E D3 7F         [11]   23 	out    (psg_port),a
                             24 ;---------------------------
   0A30 AF            [ 4]   25 	xor    a
   0A31 0B            [ 6]   26 	dec    bc
   0A32 78            [ 4]   27 	ld     a,b
   0A33 B1            [ 4]   28 	or     c
   0A34 20 E5         [12]   29 	jr     nz, psg_reset_once                      ; repeat 1000 times - maybe to make it audible on error?
   0A36 C9            [10]   30 	ret
                             31 
                             32 
                             33 
                             34 ;---------------------------
   0A37                      35 psg_beep_1:
                             36 ;---------------------------
   0A37 3E 01         [ 7]   37     ld     a, #0x01
   0A39 18 06         [12]   38     jr     psg_beep
                             39 
                             40 ;---------------------------
   0A3B                      41 psg_beep_2:
                             42 ;---------------------------
   0A3B 3E 02         [ 7]   43     ld     a, #0x02
   0A3D 18 02         [12]   44     jr     psg_beep
                             45 
                             46 ;---------------------------
   0A3F                      47 psg_beep_3:
                             48 ;---------------------------
   0A3F 3E 03         [ 7]   49     ld     a, #0x03
                             50     ; fall through
                             51 
                             52 ;-------------------------------------------------------------------------------------------
                             53 ; inputs: e = beep count
                             54 ; never returns
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 39.
Hexadecimal [16-Bits]



                             55 ; beeps are of the approximate form (eg. e=2)
                             56 ; -__-__________________-__-__________________-__-___________
                             57 ; 0s            1s            2s             3s            4s
                             58 ; where 1 char is ~70ms, the beep section is variable length but the long pauses arent
                             59 ;-------------------------------------------------------------------------------------------
   0A41                      60 psg_beep:
                             61 ;-------------------------------------------------------------------------------------------
   0A41 57            [ 4]   62 	ld     d,a                                   ; e -> d
                             63 
   0A42                      64 psg_beep_loop:
   0A42 3E 8F         [ 7]   65 	ld	a, #0b10001111				; PSG: ch 0 frequency = %0000111111 = 1775.57Hz
   0A44 D3 7F         [11]   66 	out	(psg_port),a
   0A46 3E 03         [ 7]   67 	ld	a, #0b00000011
   0A48 D3 7F         [11]   68 	out	(psg_port),a                            ; PSG: ch 0 volume = 0 = full
   0A4A 3E 90         [ 7]   69 	ld	a, #0b10010000
   0A4C D3 7F         [11]   70 	out	(psg_port),a
                             71 
   0A4E 21 FB 1E      [10]   72 	ld	hl, #0x1efb
   0A51 CD 62 0A      [17]   73 	call	psg_beep_pause
                             74 
   0A54 3E 9F         [ 7]   75 	ld	a, #0b10011111
   0A56 D3 7F         [11]   76 	out	(psg_port),a
                             77 
   0A58 21 FB 3D      [10]   78 	ld	hl, #0x3dfb
   0A5B CD 62 0A      [17]   79 	call	psg_beep_pause
                             80 
   0A5E 15            [ 4]   81 	dec    d                                     ; repeat d times
   0A5F 20 E1         [12]   82 	jr     nz, psg_beep_loop
   0A61 C9            [10]   83 	ret
                             84 
   0A62                      85 psg_beep_pause:
   0A62 2B            [ 6]   86 	dec    hl
   0A63 7C            [ 4]   87 	ld     a,h
   0A64 B5            [ 4]   88 	or     l
   0A65 20 FB         [12]   89 	jr     nz, psg_beep_pause
   0A67 C9            [10]   90 	ret
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 40.
Hexadecimal [16-Bits]



                            173 .include "sc3k_bios_ppi.inc"
                              1 
                     00DC     2 sc_ppi_a                      = 0xdc
                     00DD     3 sc_ppi_b                      = 0xdd
                     00DE     4 sc_ppi_c                      = 0xde
                     00DF     5 sc_ppi_control                = 0xdf
                              6 
                     00E4     7 sf7_ppi_a                     = 0xe4       ; (FDC, printer) status (input)
                     00E5     8 sf7_ppi_b                     = 0xe5       ; Printer port output - unused
                     00E6     9 sf7_ppi_c                     = 0xe6       ; (FDD, FDC, ROM mapping, printer) control (output)
                     00E7    10 sf7_ppi_control               = 0xe7
                             11 
                             12 
                             13 
                             14 .area	_CODE
                             15 ; ==================================================
                             16 
                             17 
                             18 ; SC-3000
                             19 ;===============================================================
                             20 ; PORT           DIR     DEVICE          DESCR
                             21 ;===============================================================
                             22 ; PortA(7..0) = (Input)  KEYBOARD        DataIn
                             23 
                             24 ; PortB(7)		= (Input)  TAPE            DataIn
                             25 ; PortB(6)		= (Input)  PRINTER         BUSY 
                             26 ; PortB(5)		= (Input)  PRINTER         FAULT  (serial printer SP-400) 
                             27 ; PortB(4)		= (Input)                  /CONT  (to the external terminal B-11) 
                             28 ; PortB(3..0) = (Input)  KEYBOARD        DataIn
                             29 
                             30 ; PortC(7)		= (Output) PRINTER         /FEED  (serial printer SP-400)
                             31 ; PortC(6)		= (Output) PRINTER         /RESET (serial printer SP-400) 
                             32 ; PortC(5)		= (Output) PRINTER         Data 
                             33 ; PortC(4)		= (Output) TAPE            DataOut 
                             34 ; PortC(3)		= (Output) ...             Not Connected
                             35 
                             36 ; PortC(2..0) = (Output) KEYBOARD        Row Select
                             37 
                             38 
                             39 ; SF-7000
                             40 ;===============================================================
                             41 ; PORT           DIR     DEVICE          DESCR
                             42 ;===============================================================
                             43 ; PortA(7..3) = (Input)  ...             Not Connected
                             44 ; PortA(2)		= (Input)  FDC765          Pin 17 of the FDC ?
                             45 ; PortA(1)		= (Input)  CENTRONICS PRN  BUSY
                             46 ; PortA(0)		= (Input)  FDC             INT signal from input from FDC 
                             47 
                             48 ; PortB(7..0)	= (Output) CENTRONICS PRN  DataOut
                             49 
                             50 ; PortC(0)		= (Output) FDC             /INUSE signal to FDD 
                             51 ; PortC(1)		= (Output) FDC             /MOTOR ON signal to FDD 
                             52 ; PortC(2)		= (Output) FDC             TC signal to FDD 
                             53 ; PortC(3)		= (Output) FDC             RESET signal to FDC 
                             54 ; PortC(4)		= (Output) ...             Not Connected
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 41.
Hexadecimal [16-Bits]



                             55 ; PortC(5)		= (Output) ...             Not Connected
                             56 ; PortC(6)		= (Output) ROM             /ROMSEL: Switching between IPL ROM(0) and RAM(1)
                             57 ; PortC(7)		= (Output) CENTRONICS PRN  /STROBE
                             58 
                             59 
   0A68                      60 ppi_init:
   0A68 CD 80 0A      [17]   61 	call	sc3000_ppi_init
   0A6B 18 34         [12]   62 	jr	sf7000_ppi_init
                             63 	;call	sf7000_ppi_init
                             64 	;ret
                             65 
                             66 		
   0A6D                      67 PPI_PAUSE:  
   0A6D C5            [11]   68 	push    bc
   0A6E                      69 ppi_p1_lp:  
   0A6E 0D            [ 4]   70 	dec     c
   0A6F C2 6E 0A      [10]   71         jp      nz, ppi_p1_lp
   0A72 00            [ 4]   72         nop     
   0A73 C1            [10]   73         pop     bc
   0A74 C9            [10]   74         ret     
                             75 
                             76 ; de = cycles
   0A75                      77 PPI_LONG_PAUSE:  
   0A75 0E FF         [ 7]   78 				ld      c, #0xFF
   0A77 CD 6D 0A      [17]   79         call    PPI_PAUSE
   0A7A 1B            [ 6]   80         dec     de
   0A7B 7A            [ 4]   81         ld      a,d
   0A7C B3            [ 4]   82         or      e
   0A7D 20 F6         [12]   83         jr      nz, PPI_LONG_PAUSE
   0A7F C9            [10]   84         ret
                             85 
                             86 ;-------------------------------------
   0A80                      87 sc3000_ppi_init:
                             88 ;-------------------------------------
                             89 
                             90 	; * SC3000 PPI PORT SET
                             91 	; ---------------------------------------
   0A80 3E 92         [ 7]   92 	ld     a, #0b10010010                           				; 0x92; initialise SC PPI: set I/O to mode 0, A+B in, C out
                             93 	;            ||/||||`---- PortCL Dir   = CL   Output
                             94 	;            || |||`----- PortB  Dir   = B    Input
                             95 	;            || ||`------ PortB/PortCL = B/CL Mode 0
                             96 	;            || |`------- PortCH Dir   = CH   Output
                             97 	;						 || `-------- PortA Dir    = A    Input
                             98 	;            |`---------- PortA/PortCH = A/CH Mode 0
                             99 	;            `----------- 8255 CONFIG(1)
   0A82 D3 DF         [11]  100 	out    (sc_ppi_control),a
                            101 
                            102 		
                            103 	; * SC3000 PPI INIT
                            104 	; ---------------------------------------
   0A84 3E 0C         [ 7]  105         ld      a,#0x0C			; X000 1100  =>  bit(00110) => PortC(6) = 0		; Printer /RESET (ON)
   0A86 D3 DF         [11]  106         out     (sc_ppi_control),a		
                            107         
   0A88 3E 0F         [ 7]  108         ld      a,#0x0F			; X000 1111  =>  bit(00111) => PortC(7) = 1		; Printer /FEED (OFF)
   0A8A D3 DF         [11]  109         out     (sc_ppi_control),a
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 42.
Hexadecimal [16-Bits]



                            110         
   0A8C 3E 0A         [ 7]  111         ld      a,#0x0A			; X000 1010  =>  bit(00101) => PortC(5) = 0		; Printer DATA (ZERO)
   0A8E D3 DF         [11]  112         out     (sc_ppi_control),a
                            113 
                            114 
   0A90 11 64 00      [10]  115         ld      de, #0x0064
   0A93 CD 75 0A      [17]  116         call	PPI_LONG_PAUSE
                            117 
   0A96 3E 0D         [ 7]  118         ld      a,#0x0D			; X000 1101  =>  bit(00110) => PortC(6) = 1		; Printer /RESET (OFF)
   0A98 D3 DF         [11]  119         out     (sc_ppi_control),a
                            120 
   0A9A 11 2C 01      [10]  121         ld      de,#0x012C
   0A9D CD 75 0A      [17]  122         call	PPI_LONG_PAUSE
   0AA0 C9            [10]  123 		ret
                            124 
                            125 ;-------------------------------------
   0AA1                     126 sf7000_ppi_init:
                            127 ;-------------------------------------
                            128 
                            129 	; * SF7000 PPI PORT SET
                            130 	; ---------------------------------------
   0AA1 3E 90         [ 7]  131 	ld     a, #0b10010000                           				; 0x90; initialise SF PPI: set I/O to mode 0, A in, B+C out
                            132 	;            ||/||||`---- PortCL Dir   = CL   Output
                            133 	;            || |||`----- PortB  Dir   = B    Output
                            134 	;            || ||`------ PortB/PortCL = B/CL Mode 0
                            135 	;            || |`------- PortCH Dir   = CH   Output
                            136 	;	     || `-------- PortA Dir    = A    Input
                            137 	;            |`---------- PortA/PortCH = A/CH Mode 0
                            138 	;            `----------- 8255A CONFIG(1)
   0AA3 D3 E7         [11]  139 	out    (sf7_ppi_control),a
                            140 		
                            141 
                            142 	; * SF7000 PPI INIT
                            143 	; ---------------------------------------
   0AA5 3E 4B         [ 7]  144 	ld     a, #0b01001011                           	; 0x4B; reset FDC, FDD turned off, ROM OFF
                            145 	;            ||  |||`---- FDD /INUSE
                            146 	;            ||  ||`----- FDD /MOTOR ON
                            147 	;            ||  |`------ FDD TC
                            148 	;            ||  `------- FDC RESET
                            149 	;            |`---------- /ROM SEL
                            150 	;            `----------- printer /STROBE
   0AA7 D3 E6         [11]  151 	out    (sf7_ppi_c),a
   0AA9 00            [ 4]  152 	nop                                          		; wait
   0AAA 00            [ 4]  153 	nop
   0AAB 00            [ 4]  154 	nop
   0AAC 00            [ 4]  155 	nop
   0AAD 3E 43         [ 7]  156 	ld     a, #0b01000011                           	; 0x43; let FDC start up, FDD still off, ROM OFF
                            157 	;            ||  |||`---- FDD /INUSE
                            158 	;            ||  ||`----- FDD /MOTOR ON
                            159 	;            ||  |`------ FDD TC
                            160 	;            ||  `------- FDC RESET
                            161 	;            |`---------- /ROM SEL
                            162 	;            `----------- printer /STROBE
   0AAF D3 E6         [11]  163 	out    (sf7_ppi_c),a
   0AB1 C9            [10]  164 	ret
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 43.
Hexadecimal [16-Bits]



                            165 
                            166 
                            167 
                            168 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 44.
Hexadecimal [16-Bits]



                            174 .include "sc3k_bios_kbd.inc"
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 45.
Hexadecimal [16-Bits]



                              1 .include	"sc3k_bios_kbd.HAL.inc"			; // KEYB_READ_MATRIX, KEYB_READ_RAWDATA
                     00DC     1 sc_ppi_a		= 0xDC
                     00DD     2 sc_ppi_b		= 0xDD
                     00DE     3 sc_ppi_c		= 0xDE
                              4 
                              5 
                              6 ;      Columns
                              7 ;      PPI Port A                      PPI Port B
                              8 ; Rows D0  D1  D2  D3  D4  D5  D6  D7  D0  D1  D2  D3
                              9 ;  -   ------------------------------- ---------------
                             10 ;  0   '1' 'Q' 'A' 'Z' ED  ',' 'K' 'I' '8' --- --- ---
                             11 ;  1   '2' 'W' 'S' 'X' SPC '.' 'L' 'O' '9' --- --- ---
                             12 ;  2   '3' 'E' 'D' 'C' HC  '/' ';' 'P' '0' --- --- ---
                             13 ;  3   '4' 'R' 'F' 'V' ID  PI  ':' '@' '-' --- --- ---
                             14 ;  4   '5' 'T' 'G' 'B' --- DA  ']' '[' '^' --- --- ---
                             15 ;  5   '6' 'Y' 'H' 'N' --- LA  CR  --- YEN --- --- FNC
                             16 ;  6   '7' 'U' 'J' 'M' --- RA  UA  --- BRK GRP CTL SHF
                             17 ;  7   1U  1D  1L  1R  1TL 1TR 2U  2D  2L  2R  2TL 2TR
                             18 
                             19 ; ED  = "ENG DIER'S", SPC = (Spacebar), HC  = "HOME CLR", ID  = "INS DEL", PI  = (PI symbol)
                             20 ; DA  = (Down arrow on keypad), LA  = (Left arrow on keypad), RA  = (Right arrow on keypad), CR  = "CR" (Enter), UA  = (Up arrow on keypad)
                             21 ; YEN = (Yen symbol), BRK = "BREAK", GRP = "GRAPH", CTL = "CTRL", FNC = "FUNC", SHF = "SHIFT"
                             22 ; 1U  = Joystick #1 up, 1D  = Joystick #1 down, 1L  = Joystick #1 left, 1R  = Joystick #1 right, 1TL = Joystick #1 left trigger, 1TR = Joystick #1 right trigger
                             23 ; 2U  = Joystick #2 up, 2D  = Joystick #2 down, 2L  = Joystick #2 left, 2R  = Joystick #2 right, 2TL = Joystick #2 left trigger, 2TR = Joystick #2 right trigger
                             24 
                             25 ; Typematic Rate Setting	Enabled
                             26 ; Typematic Rate (Chars/Sec)	30						
                             27 ; Typematic Delay (Msec) 	250
                             28 
                             29 
                             30 
                             31 ; Every keyboard row is 12 bit long and are splitted in 2 ports.
                             32 ; In order to make the access more friendly, this function transform a 12x7 data matrix (joyst not used) into a 8x9 one. 
                             33 ; LAST ROW (8) CONTAINS ONLY MODIFIER KEYS.
                             34 
                             35 
                             36 ; address                    bits
                             37 ;                            7      6      5      4      3      2      1      0
                             38 ; keyboard_input_buffer+0    I      K      ,  (eng dier) Z      A      Q      1
                             39 ; keyboard_input_buffer+1    O      L      .    (space)  X      S      W      2
                             40 ; keyboard_input_buffer+2    P      ;      /  (home/clr) C      D      E      3
                             41 ; keyboard_input_buffer+3    @      :     (pi) (ins/del) V      F      R      4
                             42 
                             43 ; keyboard_input_buffer+4    [      ]    (down)          B      G      T      5
                             44 ; keyboard_input_buffer+5          (CR)  (left)          N      H      Y      6
                             45 ; keyboard_input_buffer+6          (up)  (rite)          M      J      U      7
                             46 ; keyboard_input_buffer+7    8      9      0      -      ^     (yen) (graph)(break)
                             47 
                             48 ; keyboard_input_buffer+8                              (shift)(ctrl) (func)
                             49 ; blanks should be ignored.
                             50 
                             51 
                             52 ;#######################################
                             53 ; Read key buffer
                             54 ;#######################################
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 46.
Hexadecimal [16-Bits]



                             55 ; fills 9 bytes from keyboard_input_buffer
                             56 ; with key state information
                             57 
   0AB2                      58 KEYB_READ_MATRIX::
   0AB2 DB DE         [11]   59 	in     a,(sc_ppi_c)                     ; set keyboard raster to 0
   0AB4 E6 F8         [ 7]   60 	and    #0b11111000
   0AB6 4F            [ 4]   61 	ld     c,a
                             62 	
   0AB7 06 06         [ 7]   63 	ld     b, #6                            ; counter: first 6 rasters only
   0AB9 21 24 FB      [10]   64 	ld     hl, #keyboard_input_buffer
                             65 
   0ABC                      66 KEYB_READ_MATRIX_loop:    
   0ABC CD E4 0A      [17]   67 	call   KEYB_READ_RAWDATA
   0ABF 77            [ 7]   68 	ld     (hl),a                           ; save low 8 bits in RAM
   0AC0 CB 0B         [ 8]   69 	rrc    e                                ; CF = E & 1; BIT0 => CF;    save PB0 bits in d - PB1/2/3 are nothing for 1st 5 rasters
   0AC2 CB 12         [ 8]   70 	rl     d                                ; D = (D << 1) | CF;         high bits correspond to low rasters: ??890-^(yen)
   0AC4 0C            [ 4]   71 	inc    c                                ; move to next keyboard raster
   0AC5 23            [ 6]   72 	inc    hl
   0AC6 10 F4         [13]   73 	djnz   KEYB_READ_MATRIX_loop            ; repeat for all rasters
                             74 	
                             75 																								 ; D = 000 & "^-098"
   0AC8 43            [ 4]   76 	ld     b,e                              ; B = 00000 FUNC 00         bit 2 is FUNC, others are nothing
                             77 	
   0AC9 CD E4 0A      [17]   78 	call   KEYB_READ_RAWDATA           	; get last raster
   0ACC 77            [ 7]   79 	ld     (hl),a                           ; save in RAM
   0ACD CB 22         [ 8]   80 	sla    d                                ; move d (high bits) up by 2
   0ACF CB 22         [ 8]   81 	sla    d
                             82 																								 ; D = 0 & "890-^" & 00
   0AD1 7B            [ 4]   83 	ld     a,e                              ; and put GRAPH and BREAK in the gap
   0AD2 E6 03         [ 7]   84 	and    #0b00000011                      ; so its 890-^(yen)(graph)(break)
   0AD4 82            [ 4]   85 	add    a,d				; A = 0 & "890-^" & 00
                             86 	
   0AD5 23            [ 6]   87 	inc    hl                               ; stick the lot in the next slot in RAM
   0AD6 77            [ 7]   88 	ld     (hl),a
   0AD7 7B            [ 4]   89 	ld     a,e
                             90 	
   0AD8 E6 0C         [ 7]   91 	and    #0b00001100                      ; CTRL and SHIFT are still unsaved
   0ADA 5F            [ 4]   92 	ld     e,a                              ; put them in e
   0ADB 78            [ 4]   93 	ld     a,b                              ; get the FUNC key (?????(func)??)
   0ADC 0F            [ 4]   94 	rrca
   0ADD E6 02         [ 7]   95 	and    #0x02                            ; convert to 000000(func)0
   0ADF B3            [ 4]   96 	or     e                                ; merge with 0000(shift)(ctrl)00
                             97 
   0AE0 32 2C FB      [13]   98 	ld     (keyboard_input_buffer+8),a      ; save in the last byte of the buffer
   0AE3 C9            [10]   99 	ret
                            100 
                            101 
                            102 
                            103 ;#######################################
                            104 ; Read from keyboard
                            105 ;#######################################
                            106 ; Parameters:
                            107 ; c = SC3000 PPI C value
                            108 ; Returns:
                            109 ; ea = scan code (high bits are other SC3000 statuses)
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 47.
Hexadecimal [16-Bits]



   0AE4                     110 KEYB_READ_RAWDATA:
   0AE4 79            [ 4]  111 	ld     a,c                                   ; set keyboard raster with c
   0AE5 D3 DE         [11]  112 	out    (sc_ppi_c),a
   0AE7 CD F2 0A      [17]  113 	call   pause_for_ppi                         ; wait before reading back
   0AEA DB DD         [11]  114 	in     a,(sc_ppi_b)
   0AEC 2F            [ 4]  115 	cpl                                          ; read high bits into e, invert so they are active high
   0AED 5F            [ 4]  116 	ld     e,a
   0AEE DB DC         [11]  117 	in     a,(sc_ppi_a)                          ; similar for low bits
   0AF0 2F            [ 4]  118 	cpl
   0AF1 C9            [10]  119 	ret
                            120 
   0AF2                     121 pause_for_ppi:
   0AF2 00            [ 4]  122 	nop
   0AF3 00            [ 4]  123 	nop
   0AF4 C9            [10]  124 	ret
                            125 
                            126 
                            127 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 48.
Hexadecimal [16-Bits]



                              2 .include	"sc3k_bios_kbd.ASCII.inc"		; // KEYB_READ_ASCII
                              1 
                     0020     2 SP  = 0x20
                     0008     3 BS  = 0x08
                     000A     4 LF  = 0x0A
                     000C     5 FF  = 0x0C
                     000D     6 CR  = 0x0D
                              7 
                              8  
                              9 ;-------------------------------------------------------
   0AF5                      10 KEYB_READ_ASCII::
                             11 ;-------------------------------------------------------
   0AF5 01 00 08      [10]   12 	ld	bc, #0x0800
   0AF8 11 24 FB      [10]   13 	ld 	de, #keyboard_input_buffer
   0AFB                      14 r_key_loop:    
   0AFB 1A            [ 7]   15 	ld	a,(de)
   0AFC B7            [ 4]   16 	or	a
   0AFD 20 07         [12]   17 	jr	nz, r_key_found
   0AFF 13            [ 6]   18 	inc	de
   0B00 0C            [ 4]   19 	inc	c
   0B01 10 F8         [13]   20 	djnz	r_key_loop
                             21 	
   0B03 AF            [ 4]   22 	xor	a                               	; found nothing -> return
   0B04 18 29         [12]   23 	jr	r_key_end
                             24 
                             25 
   0B06                      26 r_key_found:
   0B06 26 00         [ 7]   27 	ld      h, #0x00				; else: c = offset of data found
   0B08 69            [ 4]   28 	ld      l, c
   0B09 29            [11]   29 	add     hl,hl
   0B0A 29            [11]   30 	add     hl,hl
   0B0B 29            [11]   31 	add     hl,hl                               	; multiply by 8
   0B0C 47            [ 4]   32 	ld      b, a
   0B0D 0E 00         [ 7]   33 	ld      c, #0x00
                             34 
   0B0F                      35 r_key_loop_2:    
   0B0F CB 08         [ 8]   36 	rrc	b                                   	; how many trailing zero bits there are in b, result in c
   0B11 38 03         [12]   37       	jr	c, r_key_add_res           	      	; eg. %01010000 = 4, 0b01010100 = 2
   0B13 0C            [ 4]   38       	inc	c
   0B14 18 F9         [12]   39       	jr     	r_key_loop_2
                             40 
   0B16                      41 r_key_add_res:    
   0B16 06 00         [ 7]   42 	ld     	b, #0x00				; add result to hl
   0B18 09            [11]   43       	add    	hl,bc
                             44 
   0B19 3A 2C FB      [13]   45       	ld	a,(keyboard_input_buffer+8)         	; check if shift/ctrl key was pressed
                             46 
   0B1C 01 3C 0B      [10]   47 	ld	bc, #table_ctrl_chars
   0B1F CB 57         [ 8]   48 	bit	2,a
   0B21 20 0A         [12]   49 	jr	nz, r_key_add_retval
                             50 
   0B23 CB 5F         [ 8]   51 	bit	3,a
   0B25 01 7C 0B      [10]   52 	ld	bc, #table_shifted_chars
   0B28 28 03         [12]   53 	jr	z, r_key_add_retval
   0B2A 01 BC 0B      [10]   54 	ld	bc, #table_unshifted_chars
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 49.
Hexadecimal [16-Bits]



                             55 
   0B2D                      56 r_key_add_retval:    
   0B2D 09            [11]   57 	add    hl,bc                               		; do the lookup and return the byte found
   0B2E 7E            [ 7]   58       	ld     a,(hl)
                             59 
                             60 
   0B2F                      61 r_key_end:
                             62 	; A = CHAR, HL = OLD | NEW
                             63 	
   0B2F 2A 30 FB      [16]   64 	ld	hl, (keyboard_last_char)
   0B32 65            [ 4]   65 	ld	h, l
   0B33 6F            [ 4]   66 	ld	l, a
   0B34 22 30 FB      [16]   67 	ld	(keyboard_last_char), hl
   0B37 94            [ 4]   68 	sub	h
   0B38 32 34 FB      [13]   69 	ld	(keyboard_diff_char), a
                             70 
   0B3B C9            [10]   71 	ret
                             72 
                             73 
                             74 
                             75 ; address                    bits
                             76 ;                            7      6      5      4      3      2      1      0
                             77 ; keyboard_input_buffer+0    I      K      ,  (eng dier) Z      A      Q      1
                             78 ; keyboard_input_buffer+1    O      L      .    (space)  X      S      W      2
                             79 ; keyboard_input_buffer+2    P      ;      /  (home/clr) C      D      E      3
                             80 ; keyboard_input_buffer+3    @      :     (pi) (ins/del) V      F      R      4
                             81 
                             82 ; keyboard_input_buffer+4    [      ]    (down)          B      G      T      5
                             83 ; keyboard_input_buffer+5          (CR)  (left)          N      H      Y      6
                             84 ; keyboard_input_buffer+6          (up)  (rite)          M      J      U      7
                             85 ; keyboard_input_buffer+7    8      9      0      -      ^     (yen) (graph)(break)
                             86 
                             87 ; keyboard_input_buffer+8                              (shift)(ctrl) (func)
                             88 ; blanks should be ignored.
                             89 
                             90 
                             91 
                             92 ; 0x0B, CTRL+K ???
                             93 
   0B3C                      94 table_ctrl_chars:
   0B3C 00 11 01 1A 00 00    95 .db   0x00, 0x11, 0x01, 0x1A,   0x00, 0x00, 0x0B, 0x09
        0B 09
   0B44 00 17 13 18 00 00    96 .db   0x00, 0x17, 0x13, 0x18,   0x00, 0x00, 0x0C, 0x0F
        0C 0F
   0B4C 00 05 04 03 00 00    97 .db   0x00, 0x05, 0x04, 0x03,   0x00, 0x00, 0x00, 0x10
        00 10
   0B54 00 12 06 16 00 00    98 .db   0x00, 0x12, 0x06, 0x16,   0x00, 0x00, 0x00, 0x00
        00 00
                             99 
   0B5C 00 14 07 02 00 00   100 .db   0x00, 0x14, 0x07, 0x02,   0x00, 0x00, 0x1D, 0x1B
        1D 1B
   0B64 00 19 08 0E 00 00   101 .db   0x00, 0x19, BS, 	0x0E,   0x00, 0x00, 0x00, 0x00
        00 00
   0B6C 00 05 0A 0D 00 00   102 .db   0x00, 0x05, LF,   CR,     0x00, 0x00, 0x00, 0x00
        00 00
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 50.
Hexadecimal [16-Bits]



   0B74 00 00 1C 1E 1F 00   103 .db   0x00, 0x00, 0x1C, 0x1E,   0x1F, 0x00, 0x00, 0x00
        00 00
                            104 
   0B7C                     105 table_shifted_chars:
   0B7C 31 51 41 5A 00 2C   106 .db "1", "Q", "A", "Z",  0 , ",", "K", "I"
        4B 49
   0B84 32 57 53 58 20 2E   107 .db "2", "W", "S", "X",  SP, ".", "L", "O"
        4C 4F
   0B8C 33 45 44 43 00 2F   108 .db "3", "E", "D", "C",  0 , "/", ";", "P"
        3B 50
   0B94 34 52 46 56 08 00   109 .db "4", "R", "F", "V",  BS,  0 , ":", "@"
        3A 40
                            110 
   0B9C 35 54 47 42 00 1F   111 .db "5", "T", "G", "B",  0 ,0x1F, "]", "["
        5D 5B
   0BA4 36 59 48 4E 00 1D   112 .db "6", "Y", "H", "N",  0 ,0x1D,  CR,  0
        0D 00
   0BAC 37 55 4A 4D 00 1C   113 .db "7", "U", "J", "M",  0 ,0x1C,0x1E,  0
        1E 00
   0BB4 00 00 5C 5E 2D 30   114 .db  0 ,  0 , '\', "^", "-", "0", "9", "8"
        39 38
                            115 
   0BBC                     116 table_unshifted_chars:
   0BBC 21 71 61 7A 00 3C   117 .db  "!", "q", "a", "z",  0 , "<", "k", "i"
        6B 69
   0BC4 5C 77 73 78 20 3E   118 .db "\"", "w", "s", "x",  SP, ">", "l", "o"
        6C 6F
   0BCC 23 65 64 63 00 3F   119 .db  "#", "e", "d", "c",  0 , "?", "+", "p"
        2B 70
   0BD4 24 72 66 76 08 5F   120 .db  "$", "r", "f", "v",  BS , "_", "*", "`"
        2A 60
                            121 
   0BDC 25 74 67 62 00 00   122 .db  "%", "t", "g", "b",  0 ,  0 , "}", "{"
        7D 7B
   0BE4 26 79 68 6E 00 00   123 .db  "&", "y", "h", "n",  0 ,  0 ,  CR,  0
        0D 00
   0BEC 27 75 6A 6D 00 00   124 .db  "'", "u", "j", "m",  0 ,  0 ,  0 ,  0
        00 00
   0BF4 00 00 7C 7E 3D 00   125 .db   0 ,  0 , "|", "~", "=",  0 , ")", "("
        29 28
                            126 
                            127 
                            128 
                            129 ;    Dec	Hex	ASCII										Key
                            130 ;  0	00	NUL (null)									ctrl @
                            131 ;  1	01	SOH (start of heading)			ctrl A
                            132 ;  2	02	STX (start of text)					ctrl B
                            133 ;  3	03	ETX (end of text)						ctrl C
                            134 ;  4	04	EOT (end of transmission)		ctrl D
                            135 ;  5	05	ENQ (enquiry)								ctrl E
                            136 ;  6	06	ACK (acknowledge)						ctrl F
                            137 ;  7	07	BEL (bell)									ctrl G
                            138 
                            139 ;  8	08	BS  (backspace)							ctrl H
                            140 ;  9	09	HT  (horizontal tab)				ctrl I
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 51.
Hexadecimal [16-Bits]



                            141 ; 10	0A	LF  (line feed)							ctrl J
                            142 ; 11	0B	VT  (vertical tab)					ctrl K
                            143 ; 12	0C	FF  (form feed)							ctrl L
                            144 ; 13	0D	CR  (carriage return)				ctrl M
                            145 ; 14	0E	SO  (shift out)							ctrl N
                            146 ; 15	0F	SI  (shift in)							ctrl O
                            147 
                            148 ; 16	10	DLE (data link escape)			ctrl P
                            149 ; 17	11	DC1 (device control 1)			ctrl Q
                            150 ; 18	12	DC2 (device control 2)			ctrl R
                            151 ; 19	13	DC3 (device control 3)			ctrl S
                            152 ; 20	14	DC4 (device control 4)			ctrl T
                            153 ; 21	15	NAK (negative acknowledge)	ctrl U
                            154 ; 22	16	SYN (synchronous idle)			ctrl V
                            155 ; 23	17	ETB (end of transm. block)	ctrl W
                            156 
                            157 ; 24	18	CAN (cancel)								ctrl X
                            158 ; 25	19	EM  (end of medium)					ctrl Y
                            159 ; 26	1A	SUB (substitute)						ctrl Z
                            160 ; 27	1B	ESC (escape)								ctrl [
                            161 ; 28	1C	FS  (file separator)				ctrl \
                            162 ; 29	1D	GS  (group separator)				ctrl ]
                            163 ; 30	1E	RS  (record separator)			ctrl ^
                            164 ; 31	1F	US  (unit separator)				ctrl _
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 52.
Hexadecimal [16-Bits]



                              3 
                              4 
                              5 .globl	keyboard_input_buffer, keyboard_last_char, keyboard_typematic_cnt
                              6 
                              7 ;#######################################
   0BFC                       8 kbd_reset::
                              9 ;#######################################
   0BFC F5            [11]   10 	push	af
   0BFD AF            [ 4]   11 	xor	a
   0BFE 32 30 FB      [13]   12 	ld	(keyboard_last_char), a
   0C01 32 31 FB      [13]   13 	ld	(keyboard_last_char+1), a
   0C04 32 35 FB      [13]   14 	ld	(keyboard_int_counter), a		
   0C07 3C            [ 4]   15 	inc	a
   0C08 32 32 FB      [13]   16 	ld	(keyboard_typematic_cnt), a
                             17 
   0C0B 21 00 FB      [10]   18 	ld	hl, #KEYBD_BUFFER
   0C0E 22 20 FB      [16]   19 	ld	(KEYBD_PUTPNT), hl
   0C11 22 22 FB      [16]   20 	ld	(KEYBD_GETPNT), hl
   0C14 F1            [10]   21 	pop	af
   0C15 C9            [10]   22 	ret
                             23 
                             24 
                             25 
                             26 
   0C16                      27 KEYB_BUFTEST:
   0C16 2A 20 FB      [16]   28 	ld	hl,(KEYBD_PUTPNT)
   0C19 ED 5B 22 FB   [20]   29 	ld	de,(KEYBD_GETPNT)
   0C1D                      30 CP_HLDE:
   0C1D 7C            [ 4]   31 	ld      a,h
   0C1E BA            [ 4]   32 	cp      d
   0C1F C0            [11]   33 	ret     nz
   0C20 7D            [ 4]   34 	ld      a,l
   0C21 BB            [ 4]   35 	cp      e
   0C22 C9            [10]   36 	ret
                             37 
                             38 
                             39 
   0C23                      40 KEYB_WRAP_PTR:
   0C23 7D            [ 4]   41         ld      a,l
   0C24 FE 20         [ 7]   42         cp      #32
   0C26 C0            [11]   43         ret     nz
   0C27 21 00 FB      [10]   44 	ld	hl, #KEYBD_BUFFER
   0C2A C9            [10]   45 	ret
                             46 
                             47 
                             48 ;===========================================================
                             49 ;===========================================================
   0C2B                      50 keyboard_interrupt::
                             51 ;===========================================================
                             52 ;===========================================================
                             53 ;	ld	a, (keyboard_int_counter)
                             54 ;	inc	a
                             55 ;	cp	#3
                             56 ;	jr	nz, keyb_int
                             57 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 53.
Hexadecimal [16-Bits]



                             58 ;	xor	a
                             59 ;	ld	(keyboard_int_counter), a
                             60 ;	ret
                             61 ;keyb_int:
                             62 	
   0C2B CD B2 0A      [17]   63 	call	KEYB_READ_MATRIX				; Update Matrix EVERY INT
   0C2E CD F5 0A      [17]   64 	call	KEYB_READ_ASCII					; Get ASCII Char
                             65 
                             66 
   0C31 21 32 FB      [10]   67 	ld	hl, #keyboard_typematic_cnt
                             68 
   0C34 3A 34 FB      [13]   69 	ld	a, (keyboard_diff_char)
   0C37 B7            [ 4]   70 	or	a
   0C38 28 02         [12]   71 	jr	z, noResetTypeMatic
   0C3A AF            [ 4]   72 	xor	a
   0C3B 77            [ 7]   73 	ld	(hl), a
   0C3C                      74 noResetTypeMatic:
   0C3C 7E            [ 7]   75 	ld	a, (hl)
   0C3D B7            [ 4]   76 	or	a
   0C3E 28 03         [12]   77 	jr	z, notypematic
   0C40 3D            [ 4]   78 	dec	a
   0C41 77            [ 7]   79 	ld	(hl), a
   0C42 C9            [10]   80 	ret
   0C43                      81 notypematic:
   0C43 CD 16 0C      [17]   82 	call	KEYB_BUFTEST
   0C46 C0            [11]   83 	ret	nz						; if HL != DE, buffer is NOT EMPTY, exit!
                             84 
                             85 
                             86 	
   0C47 3A 30 FB      [13]   87 	ld	a, (keyboard_last_char)
   0C4A B7            [ 4]   88 	or	a
   0C4B C8            [11]   89 	ret	z
                             90 
   0C4C CD 5E 0C      [17]   91 	call	KEYB_BUFFERPUTCHAR
                             92 
                             93 ; SET NEW TYPEMATIC VAL
   0C4F 06 03         [ 7]   94 	ld	b, #3
   0C51 3A 34 FB      [13]   95 	ld	a, (keyboard_diff_char)
   0C54 B7            [ 4]   96 	or	a
   0C55 28 02         [12]   97 	jr	z, tm_samechar
                             98 
   0C57 06 0F         [ 7]   99 	ld	b, #15
   0C59                     100 tm_samechar:
   0C59 78            [ 4]  101 	ld	a, b	
   0C5A 32 32 FB      [13]  102 	ld	(keyboard_typematic_cnt), a
                            103 
   0C5D C9            [10]  104 	ret
                            105 
                            106 
                            107 
                            108 ; IN: A = NEW CHAR
                            109 ;===============================================	
   0C5E                     110 KEYB_BUFFERPUTCHAR::
                            111 ;===============================================	
                            112 	
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 54.
Hexadecimal [16-Bits]



   0C5E 2A 20 FB      [16]  113         ld      hl,(KEYBD_PUTPNT)
   0C61 77            [ 7]  114         ld      (hl),a
   0C62 23            [ 6]  115         inc     hl
                            116 
   0C63 CD 23 0C      [17]  117 	call	KEYB_WRAP_PTR
                            118 
   0C66 D5            [11]  119         push    de
   0C67 ED 5B 22 FB   [20]  120         ld      de,(KEYBD_GETPNT)
   0C6B CD 1D 0C      [17]  121 	call	CP_HLDE	
   0C6E D1            [10]  122         pop     de
   0C6F C8            [11]  123         ret     z
                            124 
   0C70 22 20 FB      [16]  125         ld      (KEYBD_PUTPNT),hl
   0C73 C9            [10]  126         ret
                            127 
                            128 
                            129 
                            130 
                            131 ; OUT: A = NEW CHAR
                            132 
                            133 ;===============================================	
   0C74                     134 KEYB_WAITFORCHAR::
                            135 ;===============================================	
   0C74 CD 16 0C      [17]  136 	call	KEYB_BUFTEST		; Test buffer for a KEY
   0C77 20 04         [12]  137         jr      nz, newKeyInBuffer
   0C79 FB            [ 4]  138         ei				; Ensure INT is enabled
   0C7A 76            [ 4]  139         halt				; Stop CPU and wait for next INT
   0C7B 18 F7         [12]  140         jr      KEYB_WAITFORCHAR	; Retry test
                            141         
   0C7D                     142 newKeyInBuffer:
   0C7D 2A 22 FB      [16]  143         ld      hl, (KEYBD_GETPNT)
   0C80 54            [ 4]  144 	ld	d, h
   0C81 5D            [ 4]  145 	ld	e, l			; save old GET buffer pointer into DE
                            146 
   0C82 23            [ 6]  147         inc     hl			;\
   0C83 CD 23 0C      [17]  148 	call	KEYB_WRAP_PTR		; > Increment GET buffer pointer and wrap around buffer size
   0C86 22 22 FB      [16]  149         ld      (KEYBD_GETPNT),hl	;/
                            150 
   0C89 1A            [ 7]  151 	ld	a, (de)			; get KEY from old GET buffer pointer
                            152 
                            153 ;>>>	or	a
                            154 ;>>>	jr	z, KEYB_WAITFORCHAR	; test for ZERO (useful? buffer contains only NO-ZERO values) 
   0C8A C9            [10]  155 	ret
                            156 
                            157 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 55.
Hexadecimal [16-Bits]



                            175 .include "sc3k_bios_fdc.inc"
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 56.
Hexadecimal [16-Bits]



                              1 .include "sc3k_bios_fdc.HAL.inc"
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 57.
Hexadecimal [16-Bits]



                              1 .include "sc3k_bios_fdc.HAL.765.inc"
                              1 ;----------------------------------
   0C8B                       2 fdc_setup:
                              3 ;----------------------------------
   0C8B 21 94 0C      [10]    4 	ld     hl, #fdc_specification_data           ; Set up FDC parameters
   0C8E 3E 03         [ 7]    5 	ld     a, #fdc_specification_data_end-fdc_specification_data
   0C90 CD C8 0C      [17]    6 	call   write_to_fdc
   0C93 C9            [10]    7 	ret
                              8 
   0C94                       9 fdc_specification_data:
   0C94 03                   10 .db fdc_command_specify                          ; "specify"
   0C95 60                   11 .db (6<<4) | 0                                   ; Step Rate Time 6ms, Head Unload Time 0ms
   0C96 0B                   12 .db (5<<1) | 1                                   ; Head Load Time 5ms, Non-DMA mode true
   0C97                      13 fdc_specification_data_end:
                             14 
                             15 
                             16 ;----------------------------------
   0C97                      17 fill_fdc_command_data_buffer: 
                             18 ;----------------------------------
                             19 ; fills 9-byte fdc_command_data_buffer for command a, cylinder c, track b
                             20 ; and default the other 5 bytes to work with this drive
                             21 ; returns hl = fdc_command_data_buffer
                             22 
                             23 ; writes a, #0x0, c, 0x0, b, 0x1, 0x10, 0xe, 0xff to fdc_command_data_buffer
                             24 ;        |   |  |   |  |   |    |   |    `-- DTL = data length  = unused when N=0
                             25 ;        |   |  |   |  |   |    |   `------- GPL = gap 3 length = some low-level stuff
                             26 ;        |   |  |   |  |   |    `----------- EOT = end of track = highest possible sector number
                             27 ;        |   |  |   |  |   `---------------- N   = number       = number of bytes to transfer
                             28 ;        |   |  |   |  `-------------------- R   = record       = sector number
                             29 ;        |   |  |   `----------------------- H   = head         = head address
                             30 ;        |   |  `--------------------------- C   = cylinder     = track number
                             31 ;        |   `------------------------------ drive 0, side 0
                             32 ;        `---------------------------------- command + flags
   0C97 21 82 FA      [10]   33 	ld	hl, #fdc_command_data_buffer
   0C9A E5            [11]   34 	push	hl
   0C9B 77            [ 7]   35 	ld	(hl),a			; command + flags
   0C9C 23            [ 6]   36 	inc	hl
   0C9D 36 00         [10]   37 	ld	(hl),#0x00		; drive 0, side 0
   0C9F 23            [ 6]   38 	inc	hl
   0CA0 71            [ 7]   39 	ld	(hl),c			; track number
   0CA1 23            [ 6]   40 	inc	hl
   0CA2 36 00         [10]   41 	ld	(hl),#0x00		; head address always 0
   0CA4 23            [ 6]   42 	inc	hl
   0CA5 70            [ 7]   43 	ld	(hl),b			; sector number
   0CA6 23            [ 6]   44 	inc	hl
   0CA7 36 01         [10]   45 	ld	(hl),#1			; amount to read/write - 1 byte!
   0CA9 23            [ 6]   46 	inc	hl
   0CAA 36 10         [10]   47 	ld	(hl),#16		; highest sector number
   0CAC 23            [ 6]   48 	inc	hl
   0CAD 36 0E         [10]   49 	ld	(hl),#0x0e		; gap 3 stuff
   0CAF 23            [ 6]   50 	inc	hl
   0CB0 36 FF         [10]   51 	ld	(hl),#0xff		; ignored
   0CB2 E1            [10]   52 	pop	hl
   0CB3 C9            [10]   53 	ret
                             54 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 58.
Hexadecimal [16-Bits]



                             55 
                             56 
                             57 
                             58 
                             59 ;----------------------------------
   0CB4                      60 fill_fdc_wait_1:    
                             61 ;----------------------------------
   0CB4 DB E0         [11]   62 	in     a, (fdc_status)                      ; wait for status bit 7 = 1 
   0CB6 07            [ 4]   63 	rlca
   0CB7 30 FB         [12]   64 	jr     nc,fill_fdc_wait_1
   0CB9 C9            [10]   65 	ret
                             66 
                             67 ;----------------------------------
   0CBA                      68 fdc_wait_for_int_result:
                             69 ;----------------------------------
   0CBA DB E4         [11]   70 	in	a, (sf7_ppi_a)                       ; wait for SF7 PA0 (FDC INT)
   0CBC 0F            [ 4]   71 	rrca
   0CBD 30 FB         [12]   72 	jr	nc, fdc_wait_for_int_result
                             73 
   0CBF CD F0 0C      [17]   74 	call	fill_fdc_command_result_buffer
   0CC2 C9            [10]   75 	ret
                             76 
                             77 
                             78 
                             79 
                             80 ;--------------------------------
   0CC3                      81 fill_and_write_to_fdc_9bytes:
                             82 ;--------------------------------
   0CC3 CD 97 0C      [17]   83 	call	fill_fdc_command_data_buffer
                             84 
                             85 ;	FALL DOWN...
                             86 
                             87 ;--------------------------
   0CC6                      88 write_to_fdc_9bytes:
                             89 ;--------------------------
   0CC6 3E 09         [ 7]   90 	ld	a, #9
                             91 
                             92 ;	FALL DOWN...
                             93 
                             94 ;#######################################
                             95 ; Write a bytes from (hl) to FDC
                             96 ;#######################################
                             97 ; Parameters:
                             98 ; a = number of bytes to write
                             99 ; hl = where to write from
                            100 ; Returns:
                            101 ; carry set on error
                            102 ; zero set on success
                            103 ; Clobbers: af
                            104 ;--------------------------
   0CC8                     105 write_to_fdc:
                            106 ;--------------------------
   0CC8 C5            [11]  107 	push	bc
   0CC9 E5            [11]  108 	push	hl
   0CCA 47            [ 4]  109 	ld	b,a			; a = loop count
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 59.
Hexadecimal [16-Bits]



   0CCB 0E E1         [ 7]  110 	ld	c, #fdc_data		; c = fdc data port
   0CCD                     111 wait_bit_4:    
   0CCD DB E0         [11]  112 	in	a,(fdc_status)		; wait for fdc status bit 4 to be 0
   0CCF CB 67         [ 8]  113 	bit	4,a
   0CD1 20 FA         [12]  114 	jr	nz, wait_bit_4
                            115 	
   0CD3                     116 write_to_fdc_loop:
   0CD3 CD B4 0C      [17]  117 	call	fill_fdc_wait_1
                            118 					; wait for fdc status bit 7 to be 1
   0CD6 07            [ 4]  119 	rlca				; if fdc status bit 6 is 1, error
   0CD7 38 08         [12]  120 	jr	c, write_to_fdc_error
   0CD9 ED A3         [16]  121 	outi                            ; else, output a byte
   0CDB 20 F6         [12]  122 	jr	nz, write_to_fdc_loop
   0CDD E1            [10]  123 	pop	hl
   0CDE C1            [10]  124 	pop	bc
   0CDF AF            [ 4]  125 	xor	a
   0CE0 C9            [10]  126 	ret
                            127 	
   0CE1                     128 write_to_fdc_error:
   0CE1 CD F0 0C      [17]  129 	call   fill_fdc_command_result_buffer
   0CE4 E1            [10]  130 	pop    hl
   0CE5 C1            [10]  131 	pop    bc
   0CE6 C9            [10]  132 	ret
                            133 
                            134 
                            135 
                            136 ; while FDC INT is set, read in the FDC status registers
                            137 ;---------------------------------
   0CE7                     138 flush_fdc_status:
                            139 ;---------------------------------
   0CE7 DB E4         [11]  140 	in	a,(sf7_ppi_a)                         ; if SF7 PA0 (FDC INT) set, fill status buffer and repeat
   0CE9 0F            [ 4]  141 	rrca                                         ; else exit
   0CEA D0            [11]  142 	ret	nc
   0CEB CD F0 0C      [17]  143 	call	fill_fdc_command_result_buffer
   0CEE 18 F7         [12]  144 	jr	flush_fdc_status
                            145 
                            146 
                            147 
                            148 ; read the FDC status registers - however many it wants to return
                            149 ; returns the contents of SR0 in a, and z set for normal termination status value
                            150 ;---------------------------------
   0CF0                     151 fill_fdc_command_result_buffer:
                            152 ;---------------------------------
   0CF0 E5            [11]  153 	push	hl
   0CF1 21 8B FA      [10]  154 	ld	hl, #fdc_command_result_buffer
   0CF4 CD B4 0C      [17]  155 	call	fill_fdc_wait_1    
   0CF7 07            [ 4]  156 	rlca
   0CF8 38 0A         [12]  157 	jr	c,fill_fdc_read                     ; if status bit 6 = 1 
                            158 
   0CFA 3E 08         [ 7]  159 	ld	a,#8                                 ; else output 8
   0CFC D3 E1         [11]  160 	out	(fdc_data),a
                            161 
   0CFE                     162 fill_fdc_wait2:
   0CFE CD B4 0C      [17]  163 	call	fill_fdc_wait_1
   0D01 07            [ 4]  164 	rlca
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 60.
Hexadecimal [16-Bits]



   0D02 30 06         [12]  165 	jr	nc,fill_fdc_exit                    ; if status bit 6 = 0
                            166 
   0D04                     167 fill_fdc_read:    
   0D04 DB E1         [11]  168 	in     a,(fdc_data)                        ; else read byte to (hl++)
   0D06 77            [ 7]  169 	ld     (hl),a
   0D07 23            [ 6]  170 	inc    hl
   0D08 18 F4         [12]  171 	jr     fill_fdc_wait2
                            172 
   0D0A                     173 fill_fdc_exit:
   0D0A 3A 8B FA      [13]  174 	ld     a, (fdc_command_result_buffer)       ; return FDC SR0 contents in a <--+
   0D0D E6 C0         [ 7]  175 	and    #fdc_status_0_ok_mask                ; return z if FDC SR0 indicates normal termination
   0D0F E1            [10]  176 	pop    hl
   0D10 C9            [10]  177 	ret
                            178 
                            179 
                            180 	
                            181 
                            182 
                            183 
                            184 ; FDC stuff
                            185 ; FDC status byte meaning
                            186 ;   bit  meaning
                            187 ;    7   RQM = Request for Master = ready to send/recieve data
                            188 ;    6   DIO = Data Input/Output  = 1 when CPU should read, 0 when it should write
                            189 ;    5   EXM = Execution Mode     = 1 during "execution phase", 0 during "results phase"
                            190 ;    4   CB  = Controller Busy    = set when controller is busy and cant accept anything
                            191 ;   3-0  DnB = Drive n Busy       = set when a particular drive is busy
                            192 ;
                            193 ; FDC status registers
                            194 ;  These 4 bytes contain extended status info after an operation. Some are returned after some commands.
                            195 ;  bit  meaning
                            196 ;  ST0:
                            197 ;  7-6  Interrupt Code    00 = OK, 01 = abnormal termination, 10 = invalid command, 11 = FDD changed state and invalidated command
                            198 ;   5   Seek End          set after seek
                            199 ;   4   Equipment Check   FDD failure signal or recalibration failed
                            200 ;   3   Not Ready         FDD not ready, or side unavailable
                            201 ;   2   Head Address      Side of disk when interrupt happened
                            202 ;  1-0  Unit Select       Drive number when interrupt happened
                            203 
                     00C0   204 fdc_status_0_ok_mask 			= 0b11000000 ; mask for bits 7 and 6, zero if OK
                            205 ;--------------------------------------------------------------------
                            206 
                            207 ;  ST1:
                            208 ;   7   End of Cylinder   Sector number too large
                            209 ;   6                     Unused
                            210 ;   5   Data Error        CRC error reading disk
                            211 ;   4   Overrun           FDC not serviced fast enough
                            212 ;   3                     Unused
                            213 ;   2   No Data           Cant find sector (read/write data/deleted data), or error reading ID, or error finding start sector (read diagnostic)
                            214 ;   1   Not Writable      FDD says disk is write protected
                            215 ;   0   Missing Address Mark Low level format stuff
                            216 ;  ST2:
                            217 ;   7                     Unused
                            218 ;   6   Control Mark      Low level format stuff
                            219 ;   5   Data Error in Data Field CRC error in data section
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 61.
Hexadecimal [16-Bits]



                            220 ;   4   Wrong Cylinder    Low level format stuff
                            221 ;   3   Scan Equal Hit    During scan, equal condition satisfied
                            222 ;   2   Scan Not Satisfied During scan, condition not met
                            223 ;   1   Bad Cylinder      Low level format stuff
                            224 ;   0   Missing Address Mark in Data Field Low level format stuff?
                            225 ;  ST3:
                            226 ;   7   Fault             Copy of FDD signal
                            227 ;   6   Write Protected   Copy of FDD signal
                            228 ;   5   Ready             Copy of FDD signal
                            229 ;   4   Track 0           Copy of FDD signal
                            230 ;   3   Two Side          Copy of FDD signal
                            231 ;   2   Head Address      Copy of FDD signal
                            232 ;  1-0  Unit Select       Copy of FDD signal
                            233 ;
                            234 ; FDC commands:
                            235 ; Modifiers for multitrack, MFM, skip deleted - only apply to some commands (see xyz below, respectively)
                            236 
                     0080   237 fdc_command_modifier_multitrack   = 0b10000000
                     0040   238 fdc_command_modifier_mfm          = 0b01000000
                     0020   239 fdc_command_modifier_skip_deleted = 0b00100000
                            240 
                            241 ;--------------------------------------------------------------------
                     0002   242 fdc_command_read_diagnostic 	= 0x02
                            243 
                            244 ; 0x?2 = %0yz00010 %-----sdd 0xtt 0xhh 0xrr 0xnn 0xee 0xgg 0xll
                            245 ;     "read diagnostic"
                            246 
                            247 ;--------------------------------------------------------------------
                     0003   248 fdc_command_specify 					= 0x03
                            249 
                            250 ; 0x03 = %00000011 %ssssuuuu %llllllln
                            251 ;     "specify" - set up some parameters
                            252 ;     s = Step Rate Time (multiple of 16ms)
                            253 ;     u = Head Unload Time (multiple of 16ms)
                            254 ;     l = Head Load Time (multiple of 2ms)
                            255 ;     n = Non-DMA Mode flag
                            256 ;     Results: none
                            257 
                            258 ;--------------------------------------------------------------------
                     0004   259 fdc_command_sense 						= 0x04
                            260 
                            261 ; 0x04 = %00001000 %-----sdd
                            262 ;     "sense drive status"
                            263 ;     s = side
                            264 ;     d = drive
                            265 ;     Results: ST3
                            266 
                            267 ;--------------------------------------------------------------------
                     0005   268 fdc_command_write 						= 0x05
                            269 
                            270 ; 0x?5 = %xy000110 %-----sdd 0xtt 0xhh 0xrr 0xnn 0xee 0xgg 0xll
                            271 ;     write data:
                            272 ;       x  = multitrack mode
                            273 ;       y  = MFM mode
                            274 ;       dd = drive
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 62.
Hexadecimal [16-Bits]



                            275 ;       s  = side
                            276 ;       tt = track
                            277 ;       hh = head address
                            278 ;       rr = sector
                            279 ;       nn = byte count
                            280 ;       ee = final sector number
                            281 ;       gg = gap length
                            282 ;       ll = data length ll (if nn = 0)
                            283 ;     for SF-7000, xy = 01, dd = 0, s = 0, hh = 0, ee = 16, gg = 14, ll = dont care if nn > 0
                            284 ;     Results: ST0, ST1, ST2, ( 0xtt, 0xhh, 0xrr, 0xnn ) after operation
                            285 
                            286 ;--------------------------------------------------------------------
                     0006   287 fdc_command_read 							= 0x06
                            288 
                            289 ; 0x?6 = %xyz00110 %-----sdd 0xtt 0xhh 0xrr 0xnn 0xee 0xgg 0xll
                            290 ;     read data:
                            291 ;       x  = multitrack mode
                            292 ;       y  = MFM mode
                            293 ;       z  = skip deleted data address mark
                            294 ;       dd = drive
                            295 ;       s  = side
                            296 ;       tt = track
                            297 ;       hh = head address
                            298 ;       rr = sector
                            299 ;       nn = byte count
                            300 ;       ee = final sector number
                            301 ;       gg = gap length
                            302 ;       ll = data length ll (if nn = 0)
                            303 ;     for SF-7000, xyz = 010, dd = 0, s = 0, hh = 0, ee = 16, gg = 14, ll = dont care if nn > 0
                            304 ;     Results: ST0, ST1, ST2, ( 0xtt, 0xhh, 0xrr, 0xnn ) after operation
                            305 
                            306 ;--------------------------------------------------------------------
                     0007   307 fdc_command_recalibrate 			= 0x07
                            308 
                            309 ; 0x07 = %00000111 %------dd
                            310 ;     recalibrate drive dd, seek to track 0
                            311 
                            312 ;--------------------------------------------------------------------
                     0008   313 fdc_command_sense_interrupt 	= 0x08
                            314 
                            315 ; 0x08 = %00001000
                            316 ;     "sense interrupt status"
                            317 ;     Returns: ST0, 0xtt = current track number
                            318 
                            319 ;--------------------------------------------------------------------
                     0009   320 fdc_command_write_deleted 		= 0x09
                            321 ; 0x?9 0x?? 0x?? 0x?? 0x?? 0x?? 0x?? 0x?? 0x??
                            322 ;     "write deleted data"
                            323 
                            324 ;--------------------------------------------------------------------
                     000A   325 fdc_command_read_id 					= 0x0a
                            326 ; 0x?a = %0y001010 %-----sdd
                            327 ;     "read sector id"
                            328 ;     reads the first "correct ID information" on the current track
                            329 ;     Returns: ST0, ST1, ST2, tt, hh, rr, nn
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 63.
Hexadecimal [16-Bits]



                            330 
                            331 ;--------------------------------------------------------------------
                     000C   332 fdc_command_read_deleted 			= 0x0c
                            333 
                            334 ; 0x?c = %xyz01100 0x-----sdd 0xtt 0xhh 0xrr 0xnn 0xee 0xgg 0xll
                            335 ;     "read deleted data"
                            336 ;       x  = multitrack mode
                            337 ;       y  = MFM mode
                            338 ;       z  = skip deleted data address mark
                            339 ;       dd = drive
                            340 ;       s  = side
                            341 ;       tt = track
                            342 ;       hh = head address
                            343 ;       rr = sector
                            344 ;       nn = byte count
                            345 ;       ee = final sector number
                            346 ;       gg = gap length
                            347 ;       ll = data length ll (if nn = 0)
                            348 ;     for SF-7000, xyz = 010, dd = 0, s = 0, hh = 0, ee = 16, gg = 14, ll = dont care if nn > 0
                            349 ;     Results: ST0, ST1, ST2, ( 0xtt, 0xhh, 0xrr, 0xnn ) after operation
                            350 
                            351 ;--------------------------------------------------------------------
                     000D   352 fdc_command_format 						= 0x0D
                            353 
                            354 ; 0x?d = %0y001101 %-----sdd 0xnn 0xtt 0xgg 0xbb
                            355 ;     "format a track"
                            356 ;       y  = use MFM mode
                            357 ;       s  = side
                            358 ;       dd = drive
                            359 ;       nn = bytes per sector
                            360 ;       tt = sectors per track
                            361 ;       gg = gap 3 length
                            362 ;       bb = filler byte
                            363 
                            364 ;--------------------------------------------------------------------
                     000F   365 fdc_command_seek 							= 0x0f
                            366 ; 0x0f = %-----sdd 0xtt
                            367 ;     seek drive dd, side s, track tt
                            368 
                            369 ;--------------------------------------------------------------------
                     0011   370 fdc_command_scan_equal 				= 0x11
                            371 ; 0x11 = %xyz10001 0x-----sdd 0xtt 0xhh 0xrr 0xnn 0xee 0xgg 0xll
                            372 ;     "scan equal" - "data compared between the FDD and the host system"
                            373 
                            374 ;--------------------------------------------------------------------
                     0019   375 fdc_command_scan_low_equal 		= 0x19
                            376 ; 0x19 = %xyz11001 0x-----sdd 0xtt 0xhh 0xrr 0xnn 0xee 0xgg 0xll
                            377 ;     "scan low or equal"
                            378 
                            379 ;--------------------------------------------------------------------
                     001E   380 fdc_command_scan_high_equal 	= 0x1e
                            381 ; 0x1e = %xyz11101 0x-----sdd 0xtt 0xhh 0xrr 0xnn 0xee 0xgg 0xll
                            382 ;     "scan high or equal"
                            383 
                            384 ; PPI stuff
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 64.
Hexadecimal [16-Bits]



                            385 ; PPI control has 2 modes:
                            386 ;   if bit 7 is set, it controls input/output and overall mode
                            387 ;     bit  meaning (bit 7 set)
                            388 ;     6,5  port A+C(high) mode selection
                            389 ;      4   port A input if set
                            390 ;      3   port C upper nibble input if set
                            391 ;      2   port B+C(low) mode selection
                            392 ;      1   port B mode selection
                            393 ;      0   port C lower nibble input if set
                            394 ;   if bit 7 is reset, it sets or resets bits in port C - useful for some modes
                            395 ;     bit  meaning (bit 7 reset)
                            396 ;    6,5,4 ignored
                            397 ;    3,2,1 bit selection (0-7)
                            398 ;      0   bit value
                            399 ; SF-7000 PPI port A
                            400 ;   PA0 = FDC INT: in non-DMA mode, set when there is a byte to output
                            401 ;   PA1 = printer port BUSY
                            402 ;   PA2 = FDC INDEX: high when at the start of a track
                            403 ; SF-7000 PPI port B
                            404 ;   Printer port output - unused
                            405 ; SF-7000 PPI port C
                            406 ;   PC0 = FDD /INUSE
                            407 ;   PC1 = FDD /MOTOR ON
                            408 ;   PC2 = FDD TC = terminal count: terminates data transfers when set
                            409 ;   PC3 = FDC RESET
                            410 ;   PC4 = ?
                            411 ;   PC5 = ?
                            412 ;   PC6 = /ROM SEL = map ROM to lower 4KB when zero - note that writing to ROM will write to RAM.
                            413 ;   PC7 = /STROBE = printer output
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 65.
Hexadecimal [16-Bits]



                              2 
                              3 
                     00E0     4 fdc_status	= 0xe0
                     00E1     5 fdc_data	= 0xe1
                              6 
                     0100     7 SECTS_SIZE	= 256
                     0010     8 SECTS_PER_TRACK = 16
                              9 
   0D11                      10 FDC_WAIT1SEC:
   0D11 C5            [11]   11 	push	bc
   0D12 01 65 03      [10]   12 	ld	bc, #869                              ; wait for 3581154 cycles = 1.000s
   0D15 CD 1A 0D      [17]   13 	call	FDC_WAIT
   0D18 C1            [10]   14 	pop	bc
   0D19 C9            [10]   15 	ret
                             16 
   0D1A                      17 FDC_WAIT:   
   0D1A AF            [ 4]   18 	xor    a
   0D1B                      19 FDC_WAIT2:
   0D1B 3D            [ 4]   20 	dec    a
   0D1C 20 FD         [12]   21 	jr     nz, FDC_WAIT2
                             22 	
   0D1E 0B            [ 6]   23 	dec    bc
   0D1F 78            [ 4]   24 	ld     a,b
   0D20 B1            [ 4]   25 	or     c
   0D21 20 F7         [12]   26 	jr     nz, FDC_WAIT
   0D23 C9            [10]   27 	ret
                             28 
                             29 
                             30 ;-----------------------------------
   0D24                      31 sf7k_reset:
                             32 ;-----------------------------------
   0D24 F3            [ 4]   33 	di
   0D25                      34 sf7k_reset_loop:
   0D25 CD 6E 0E      [17]   35 	call	disk_initialise
   0D28 38 FB         [12]   36 	jr	c, sf7k_reset_loop
   0D2A FB            [ 4]   37 	ei
                             38 
                             39 
   0D2B C9            [10]   40 	ret
                             41 
                             42 
                             43 
                             44 ;-----------------------------------
   0D2C                      45 fdc_readsectors::
                             46 ;-----------------------------------
                             47 ;#######################################
                             48 ; READ A SET OF SECTORS TO HL
                             49 ; Parameters:
                             50 ; de = destination buffer
                             51 ;  b = start sector
                             52 ;  c = start track
                             53 ;  l = num sectors 
                             54 	
   0D2C CD 03 0E      [17]   55 	call	fdc_motor_req_on
                             56 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 66.
Hexadecimal [16-Bits]



   0D2F                      57 read_set_from_disk_loop_n:
   0D2F C5            [11]   58 	push	bc
   0D30 E5            [11]   59 	push	hl
   0D31 CD 52 0D      [17]   60 	call	fdc_readsector_inner
   0D34 E1            [10]   61 	pop	hl
   0D35 C1            [10]   62 	pop	bc
                             63 
   0D36 2D            [ 4]   64 	dec	l
   0D37 C8            [11]   65 	ret	z
                             66 	
   0D38 14            [ 4]   67 	inc	d					; next 256 bytes
   0D39 04            [ 4]   68 	inc	b					; next sector
   0D3A 78            [ 4]   69 	ld	a, b
   0D3B FE 11         [ 7]   70 	cp	#SECTS_PER_TRACK + 1			
   0D3D 20 F0         [12]   71 	jr	nz, read_set_from_disk_loop_n
                             72 
   0D3F 06 01         [ 7]   73 	ld	b, #1
   0D41 0C            [ 4]   74 	inc	c
   0D42 18 EB         [12]   75 	jr	read_set_from_disk_loop_n
                             76 
   0D44 CD F5 0D      [17]   77 	call	fdc_motor_req_off
                             78 
   0D47 C9            [10]   79 	ret
                             80 
                             81 
                             82 ;-----------------------------------
                             83 ;-----------------------------------
   0D48                      84 fdc_readsector::
                             85 ;-----------------------------------
                             86 ;-----------------------------------
   0D48 CD 03 0E      [17]   87 	call	fdc_motor_req_on
                             88 
   0D4B CD 52 0D      [17]   89 	call	fdc_readsector_inner
                             90 
   0D4E CD F5 0D      [17]   91 	call	fdc_motor_req_off
   0D51 C9            [10]   92 	ret
                             93 	
                             94 ;-----------------------------------
   0D52                      95 fdc_readsector_inner::
                             96 ;#######################################
                             97 ; 256 BYTES PHYSICAL SECTOR READ TO HL
                             98 ; Parameters:
                             99 ; de = destination buffer
                            100 ; b = sector number on disk + 1
                            101 ; c = track number on disk
                            102 ; Destroys af
                            103 ; returns carry on error
                            104 ; checks it can read back without error, does not verify data read back
                            105 
                            106 
   0D52 C5            [11]  107 	push	bc
   0D53 D5            [11]  108 	push	de
   0D54 E5            [11]  109 	push	hl
                            110 
                            111 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 67.
Hexadecimal [16-Bits]



   0D55 21 80 FA      [10]  112 	ld     hl, #fdc_command_loop_counter
   0D58 36 04         [10]  113 	ld     (hl), #4                              ; try 4 times
                            114 
   0D5A                     115 read_from_disk_outer_4:   
   0D5A CD AA 0D      [17]  116 	call   seek_track_c
                            117 	
   0D5D 38 1B         [12]  118 	jr     c,read_from_disk_error
   0D5F 21 81 FA      [10]  119 	ld     hl, #fdc_command_loop_counter_2
                            120 	
   0D62 36 0A         [10]  121 	ld     (hl),#10                             ; try 10 times
                            122 
   0D64                     123 read_from_disk_inner_10:    
   0D64 CD 81 0D      [17]  124 	call   read_track_c_sector_b_to_de
   0D67 28 13         [12]  125 	jr     z, read_from_disk_exit
                            126 	
   0D69 21 81 FA      [10]  127 	ld     hl, #fdc_command_loop_counter_2       ; failed: loop inner (reading)
   0D6C 35            [11]  128 	dec    (hl)
                            129 	
   0D6D 20 F5         [12]  130 	jr     nz, read_from_disk_inner_10
                            131 	
                            132 	
   0D6F 21 80 FA      [10]  133 	ld     hl, #fdc_command_loop_counter         ; failed a lot: loop outer (seeking)
   0D72 35            [11]  134 	dec    (hl)
   0D73 28 05         [12]  135 	jr     z, read_from_disk_error
                            136 	
   0D75 CD D0 0D      [17]  137 	call   calibrate_and_seek_to_track_0       ; so the seek will be recalibrated too
   0D78 30 E0         [12]  138 	jr     nc, read_from_disk_outer_4
                            139 
   0D7A                     140 read_from_disk_error:    
   0D7A 37            [ 4]  141 	scf
   0D7B 06                  142 	.db 0x06		; will merge with next opcode to make "ld b, 0xb7" and thus not affect flags
                            143 
   0D7C                     144 read_from_disk_exit:
   0D7C B7            [ 4]  145 	or	a               ; reset carry flag
                            146 
   0D7D E1            [10]  147 	pop	hl
   0D7E D1            [10]  148 	pop	de
   0D7F C1            [10]  149 	pop	bc
   0D80 C9            [10]  150 	ret
                            151 		
                            152 
   0D81                     153 read_track_c_sector_b_to_de:
   0D81 3E 46         [ 7]  154 	ld	a, #fdc_command_read | fdc_command_modifier_mfm
   0D83 CD C3 0C      [17]  155 	call	fill_and_write_to_fdc_9bytes
   0D86 C0            [11]  156 	ret	nz                               ; return if
   0D87 C5            [11]  157 	push	bc
   0D88 D5            [11]  158 	push	de
   0D89 EB            [ 4]  159 	ex	de,hl                            ; hl = dest address
   0D8A CD 93 0D      [17]  160 	call	try_raw_read_sector_from_disk
   0D8D D1            [10]  161 	pop	de
   0D8E C1            [10]  162 	pop	bc
                            163 	
   0D8F CD BA 0C      [17]  164 	call	 fdc_wait_for_int_result	; wait for SF7 PA0 (FDC INT)
   0D92 C9            [10]  165 	ret
                            166 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 68.
Hexadecimal [16-Bits]



                            167 
                            168 
   0D93                     169 try_raw_read_sector_from_disk:
                            170 	;di					; DII
   0D93 06 00         [ 7]  171 	ld     b, #0x00                         ; counter: read 256 bytes
   0D95 0E E1         [ 7]  172 	ld     c, #fdc_data
   0D97 1E 40         [ 7]  173 	ld     e, #0b01000000                   ; used for a mask in a moment
                            174 
   0D99                     175 try_raw_read_sector_loop:  
   0D99 CD B4 0C      [17]  176 	call	fill_fdc_wait_1		; wait for FDC status bit 7 (RQM)
   0D9C A3            [ 4]  177 	and    	e                               ; return if FDC status bit 5 (EXM) is not set (?)
   0D9D C8            [11]  178 	ret    	z
                            179 	
   0D9E ED A2         [16]  180 	ini                                     ; read a byte from fdc_data to hl
   0DA0 20 F7         [12]  181 	jr     nz, try_raw_read_sector_loop     ; loop until b = 0, ie. 256 times
                            182 	
   0DA2 3E 05         [ 7]  183 	ld     a, #0b00000101                   ; set SF7 PC2 (FDD TC - transaction complete?) to 1
   0DA4 D3 E7         [11]  184 	out    (sf7_ppi_control),a
   0DA6 3D            [ 4]  185 	dec    a                                ; then set it to 0, ie. just strobe it
   0DA7 D3 E7         [11]  186 	out    (sf7_ppi_control),a
                            187 	;ei					; EII
   0DA9 C9            [10]  188 	ret
                            189 
                            190 
                            191 
   0DAA                     192 seek_track_c:
   0DAA C5            [11]  193 	push   bc
   0DAB E5            [11]  194 	push   hl
   0DAC CD E7 0C      [17]  195 	call   flush_fdc_status
   0DAF 21 82 FA      [10]  196 	ld     hl, #fdc_command_data_buffer
   0DB2 36 0F         [10]  197 	ld     (hl), #fdc_command_seek
   0DB4 23            [ 6]  198 	inc    hl
   0DB5 36 00         [10]  199 	ld     (hl), #0x00                            ; drive 0 side 0
   0DB7 23            [ 6]  200 	inc    hl
   0DB8 71            [ 7]  201 	ld     (hl),c                              ; track c
   0DB9 3E 03         [ 7]  202 	ld     a, #3                                 ; 3 byte command
                            203 	
   0DBB                     204 output_no_data_fdc_command_and_get_result:
   0DBB 21 82 FA      [10]  205 	ld     hl, #fdc_command_data_buffer
   0DBE CD C8 0C      [17]  206 	call   write_to_fdc
   0DC1 20 09         [12]  207 	jr     nz,return_carry_set
                            208 	
   0DC3 CD BA 0C      [17]  209 	call	 fdc_wait_for_int_result
                            210 	
   0DC6 E1            [10]  211 	pop    hl
   0DC7 C1            [10]  212 	pop    bc
   0DC8 37            [ 4]  213 	scf                                          ; return carry set if z flag not set, ie. FDC status indicates an error
   0DC9 C0            [11]  214 	ret    nz
   0DCA 3F            [ 4]  215 	ccf
   0DCB C9            [10]  216 	ret
                            217 
   0DCC                     218 return_carry_set:
   0DCC E1            [10]  219 	pop    hl
   0DCD C1            [10]  220 	pop    bc
   0DCE 37            [ 4]  221 	scf
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 69.
Hexadecimal [16-Bits]



   0DCF C9            [10]  222 	ret
                            223 
   0DD0                     224 calibrate_and_seek_to_track_0:
   0DD0 C5            [11]  225 	push   bc
   0DD1 E5            [11]  226 	push   hl
   0DD2 CD E7 0C      [17]  227 	call   flush_fdc_status
   0DD5 21 82 FA      [10]  228 	ld     hl, #fdc_command_data_buffer
   0DD8 36 07         [10]  229 	ld     (hl), #fdc_command_recalibrate
   0DDA 23            [ 6]  230 	inc    hl
   0DDB 36 00         [10]  231 	ld     (hl), #0x00                            ; drive 0, side 0
   0DDD 3E 02         [ 7]  232 	ld     a,#2                                 ; 2 byte command
   0DDF 18 DA         [12]  233 	jr     output_no_data_fdc_command_and_get_result
                            234 
                            235 
                            236 
                            237 
                            238 
                            239 
                            240 
                            241 
                            242 ;###################################
   0DE1                     243 fdc_stop_disk::
                            244 ;###################################
   0DE1 CD FE 0D      [17]  245 	call	fdc_motor_off
   0DE4 3E 01         [ 7]  246 	ld	a, #0b00000001                         ; set SF7 PC0 (FDD /INUSE) to 1 = set FDD off
   0DE6 D3 E7         [11]  247 	out	(sf7_ppi_control),a
   0DE8 3E 0A         [ 7]  248 	ld	a, #0b00001010                         ; set SF7 PC5 (???) to 0
   0DEA D3 E7         [11]  249 	out	(sf7_ppi_control),a
   0DEC C9            [10]  250 	ret
                            251 
                            252 ;====================================================
   0DED                     253 fdc_motor_on:
                            254 ;====================================================
   0DED 3E 02         [ 7]  255 	ld	a, #0b00000010                         ; set SF7 PC1 (FDD /MOTOR ON) to 0 = turn motor on
   0DEF D3 E7         [11]  256 	out	(sf7_ppi_control),a
   0DF1 32 D2 FA      [13]  257 	ld	(FDC_MOTOR_ACT), a
   0DF4 C9            [10]  258 	ret
                            259 
                            260 ;====================================================
   0DF5                     261 fdc_motor_req_off:
                            262 ;====================================================
   0DF5 AF            [ 4]  263 	xor	a
   0DF6 32 D2 FA      [13]  264 	ld	(FDC_MOTOR_ACT), a
   0DF9 3D            [ 4]  265 	dec	a
u  0DFA 32 00 00      [13]  266 	ld	(FDC_MOTOR_cnt), a
   0DFD C9            [10]  267 	ret
                            268 	
                            269 ;====================================================
   0DFE                     270 fdc_motor_off:
                            271 ;====================================================
   0DFE 3E 03         [ 7]  272 	ld	a, #0b00000011                         ; set SF7 PC1 (FDD /MOTOR ON) to 1 = turn FDD motor off
   0E00 D3 E7         [11]  273 	out	(sf7_ppi_control),a
   0E02 C9            [10]  274 	ret
                            275 
                            276 ;====================================================
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 70.
Hexadecimal [16-Bits]



   0E03                     277 fdc_motor_req_on:
                            278 ;====================================================
   0E03 DB E6         [11]  279 	in	a,(sf7_ppi_c)                       	; reset FDD /INUSE (ie. FDD on)
   0E05 CB 4F         [ 8]  280 	bit	1,a                                 	; check FDD /MOTOR ON
   0E07 C8            [11]  281 	ret	z					; if already on, return
   0E08 CD ED 0D      [17]  282 	call	fdc_motor_on
   0E0B CD 11 0D      [17]  283 	call	FDC_WAIT1SEC
   0E0E C9            [10]  284 	ret
                            285 
                            286 
                            287 
                            288 ;-----------------------------------
   0E0F                     289 fdc_writesector::
                            290 ;-----------------------------------
   0E0F CD 03 0E      [17]  291 	call	fdc_motor_req_on
                            292 
   0E12 CD 19 0E      [17]  293 	call	fdc_writesector_inner
                            294 
   0E15 CD F5 0D      [17]  295 	call	fdc_motor_req_off
   0E18 C9            [10]  296 	ret
                            297 
                            298 ;-----------------------------------
   0E19                     299 fdc_writesector_inner::
                            300 ;-----------------------------------
                            301 ;#######################################
                            302 ; 256 BYTES PHYSICAL SECTOR READ TO HL
                            303 ; Parameters:
                            304 ; de = source buffer
                            305 ; b = sector number on disk + 1
                            306 ; c = track number on disk
                            307 ; Destroys af
                            308 ; returns carry on error
                            309 ; checks it can read back without error, does not verify data read back
   0E19 C5            [11]  310 	push	bc
   0E1A D5            [11]  311 	push	de
   0E1B E5            [11]  312 	push	hl
                            313 
   0E1C CD AA 0D      [17]  314 	call   seek_track_c
   0E1F 38 17         [12]  315 	jr     c,write_to_disk_error
   0E21 21 80 FA      [10]  316 	ld     hl, #fdc_command_loop_counter
   0E24 36 00         [10]  317 	ld     (hl), #0x00                            		; counter: 256 tries
                            318 	
   0E26                     319 write_to_disk_loop:   
   0E26 CD 3F 0E      [17]  320 	call   write_sector_from_de_to_fdc_track_c_sector_b
   0E29 20 07         [12]  321 	jr     nz,write_to_disk_continue
                            322 	
                            323 	
   0E2B 3E E0         [ 7]  324 	ld     a, #0xe0                               		; pause
   0E2D                     325 write_to_disk_pause:    
   0E2D 3D            [ 4]  326 	dec    a
   0E2E 00            [ 4]  327 	nop
   0E2F 00            [ 4]  328 	nop
   0E30 20 FB         [12]  329 	jr     nz,write_to_disk_pause
                            330 	
                            331 	
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 71.
Hexadecimal [16-Bits]



                            332 ;	call   test_read_sector_from_fdc_track_c_sector_b 	; try to read it back (slow!)
                            333 ;	jr     z,write_to_disk_exit				; exit if no error
                            334 
                            335 	
   0E32                     336 write_to_disk_continue:    
   0E32 21 80 FA      [10]  337 	ld     hl, #fdc_command_loop_counter			; else decrement counter and loop
   0E35 35            [11]  338 	dec    (hl)
   0E36 20 EE         [12]  339 	jr     nz, write_to_disk_loop
                            340 	
   0E38                     341 write_to_disk_error:
   0E38 37            [ 4]  342 	scf
   0E39 06                  343 	.db 0x06						; "or a" eater
                            344 	
   0E3A                     345 write_to_disk_exit:  
   0E3A B7            [ 4]  346 	or     a
                            347 	
   0E3B E1            [10]  348 	pop	hl
   0E3C D1            [10]  349 	pop	de
   0E3D C1            [10]  350 	pop	bc
   0E3E C9            [10]  351 	ret
                            352 
                            353 
                            354 
                            355 
                            356 
   0E3F                     357 write_sector_from_de_to_fdc_track_c_sector_b:
   0E3F 3E 45         [ 7]  358 	ld	a, #fdc_command_write | fdc_command_modifier_mfm; FDC Read mode; b and c set to sector, track already
   0E41 CD C3 0C      [17]  359 	call	fill_and_write_to_fdc_9bytes
   0E44 C0            [11]  360 	ret	nz
   0E45 C5            [11]  361 	push	bc
   0E46 D5            [11]  362 	push	de
   0E47 EB            [ 4]  363 	ex	de,hl
   0E48 CD 51 0E      [17]  364 	call	write_256_bytes_from_hl_to_fdc_when_ready
   0E4B D1            [10]  365 	pop	de
   0E4C C1            [10]  366 	pop	bc
                            367 	
   0E4D CD BA 0C      [17]  368 	call	 fdc_wait_for_int_result		; wait for SF7 PA0 (FDC INT)
   0E50 C9            [10]  369 	ret
                            370 
                            371 
                            372 
   0E51                     373 write_256_bytes_from_hl_to_fdc_when_ready:
                            374 	;di						; DII
   0E51 06 00         [ 7]  375 	ld     b, #0x00                               	; counter for 256 bytes
   0E53 0E E1         [ 7]  376 	ld     c, #fdc_data
   0E55 1E 40         [ 7]  377 	ld     e, #0b01000000
                            378 
   0E57                     379 write_256_loop:    
   0E57 CD B4 0C      [17]  380 	call	fill_fdc_wait_1				; loop until FDC status bit 7 (RQM) is set
   0E5A A3            [ 4]  381 	and    e
   0E5B C8            [11]  382 	ret    z                                   	; return if FDC status bit 5 (EQM) not set (?)
                            383 	
   0E5C ED A3         [16]  384 	outi                                       	; output a byte
   0E5E 20 F7         [12]  385 	jr     nz, write_256_loop
                            386 	
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 72.
Hexadecimal [16-Bits]



   0E60 3E 05         [ 7]  387 	ld     a, #0b00000101                         	; strobe SF7 PC2 (FDD TC) ->1->0 = terminate any data transfers
   0E62 D3 E7         [11]  388 	out    (sf7_ppi_control),a
   0E64 3D            [ 4]  389 	dec    a
   0E65 D3 E7         [11]  390 	out    (sf7_ppi_control),a
                            391 	;ei						; EII
   0E67 C9            [10]  392 	ret
                            393 
                            394 
                            395 
                            396 
                            397 
                            398 
                            399 
                            400 
                            401 
                            402 
                            403 
                            404 
                            405 
                            406 
                            407 
                            408 ;#######################################
                            409 ; disk_reset
                            410 ;#######################################
   0E68                     411 disk_reset::
   0E68 CD F0 0C      [17]  412 	call   fill_fdc_command_result_buffer        ; doing this twice will blank it and make the FDC get on with things
   0E6B CD F0 0C      [17]  413 	call   fill_fdc_command_result_buffer
                            414 ; ... fall down...
                            415 
                            416 ;#######################################
                            417 ; disk_initialise
                            418 ; API 0x08
                            419 ;#######################################
                            420 ; Initialises FDC and FDD
                            421 ; returns carry on error, including disk not present
   0E6E                     422 disk_initialise::
   0E6E C5            [11]  423 	push   bc
   0E6F D5            [11]  424 	push   de
   0E70 E5            [11]  425 	push   hl
   0E71 DB E6         [11]  426 	in     a,(sf7_ppi_c)                       ; reset FDD /INUSE (ie. FDD on)
   0E73 E6 F2         [ 7]  427 	and    #0b11110010                         ; reset FDD TC
   0E75 F6 20         [ 7]  428 	or     #0b00100000                         ; reset FDC RESET (ie. FDC on)
   0E77 D3 E6         [11]  429 	out    (sf7_ppi_c),a                       ; set SF7 PC5 = ???
   0E79 CB 4F         [ 8]  430 	bit    1,a                                 ; check FDD /MOTOR ON
   0E7B 28 07         [12]  431 	jr     z, disk_init_detect_spin            ; if already on, go detect rotation speed
                            432 
                            433 
                            434 	; TURN MOTOR ON
   0E7D 3E 02         [ 7]  435 	ld     a, #0b00000010                         ; set SF7 PC1 (FDD /MOTOR ON) to 0 = turn motor on
   0E7F D3 E7         [11]  436 	out    (sf7_ppi_control),a
                            437 
   0E81 CD 11 0D      [17]  438 	call	FDC_WAIT1SEC
                            439 
                            440 
                            441 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 73.
Hexadecimal [16-Bits]



                            442 
   0E84                     443 disk_init_detect_spin:    
   0E84 16 FA         [ 7]  444 	ld     d, #250                               ; outer loop 250 times - how may times to try to time a fast disk spin before failing
   0E86 1E 07         [ 7]  445 	ld     e, #7                                 ; inner loop 7 times - how many times to try to detect a spin before failing
                            446 
   0E88                     447 disk_initialise_loop:
   0E88 01 00 00      [10]  448 	ld     bc, #0x0000                            ; wait for FDC INDEX (PA2) to be set
   0E8B                     449 disk_init_check_high:    
   0E8B DB E4         [11]  450 	in     a,(sf7_ppi_a)
   0E8D E6 04         [ 7]  451 	and    #0b00000100
   0E8F 20 07         [12]  452 	jr     nz, disk_init_high_ok                  ; passed check (nz), carry on
   0E91 0B            [ 6]  453 	dec    bc
   0E92 78            [ 4]  454 	ld     a,b
   0E93 B1            [ 4]  455 	or     c
   0E94 20 F5         [12]  456 	jr     nz,disk_init_check_high
   0E96 18 3E         [12]  457 	jr     disk_initialise_error                  	; flag was never set
                            458 
                            459 
   0E98                     460 disk_init_high_ok:    
   0E98 21 00 00      [10]  461 	ld     hl, #0x0000                            	; wait for FDC INDEX (PA2) to be reset
                            462 			
   0E9B                     463 disk_init_check_low:    
   0E9B DB E4         [11]  464 	in     a,(sf7_ppi_a)				; 11 cycles
   0E9D E6 04         [ 7]  465 	and    #0b00000100													;  4 cycles
   0E9F 28 07         [12]  466 	jr     z, disk_init_low_ok                 	;  7 passed check (z), carry on
   0EA1 2B            [ 6]  467 	dec    hl					;  6
   0EA2 7C            [ 4]  468 	ld     a,h					;  4
   0EA3 B5            [ 4]  469 	or     l					;  4
   0EA4 20 F5         [12]  470 	jr     nz, disk_init_check_low			; 12
                            471 																									; tot = 48 cycles
                            472 	
   0EA6 18 2E         [12]  473 	jr     disk_initialise_error
                            474 
   0EA8                     475 disk_init_low_ok:    
                            476 
   0EA8 01 51 3C      [10]  477 	ld     bc, #15441                            ; 20 wait (~207ms) for FDC INDEX (PA2) to be set
   0EAB                     478 disk_init_wait_high2:    
   0EAB DB E4         [11]  479 	in     a,(sf7_ppi_a)				; 11
   0EAD E6 04         [ 7]  480 	and    #0b00000100                           ;  4
   0EAF 20 0A         [12]  481 	jr     nz, disk_init_high2_end             ;  7 (+5 on exit) passed check (nz), carry on
   0EB1 0B            [ 6]  482 	dec    bc                                  ;  6
   0EB2 78            [ 4]  483 	ld     a,b                                 ;  4
   0EB3 B1            [ 4]  484 	or     c                                   ;  4
   0EB4 20 F5         [12]  485 	jr     nz, disk_init_wait_high2            ; 12 (always pass)
                            486 	
                            487 	; loop is 48 cycles + 31 since last port read, + 27 reaching successful exit
                            488 	
                            489 	; ran out of time waiting
   0EB6 1D            [ 4]  490 	dec    e
   0EB7 20 CF         [12]  491 	jr     nz,disk_initialise_loop             ; repeat disk_initialise_loop while e-- > 0 (inner loop)
   0EB9 18 1B         [12]  492 	jr     disk_initialise_error
                            493 	
                            494 	; disk spin fully detected
                            495 	; see how fast its spinning - if bs was decremented to 2806 or less, it was too slow
                            496 	; reaching 2807 is equivalent to 12634 loops and 1 successful exit
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 74.
Hexadecimal [16-Bits]



                            497 	; which makes 606490 cycles between INDEX off and INDEX on
                            498 	; = 169ms = 354RPM
                            499 
   0EBB                     500 disk_init_high2_end:    
   0EBB 21 F7 0A      [10]  501 	ld     hl, #2807                             ; compare bc to 2807
   0EBE B7            [ 4]  502 	or     a
   0EBF ED 42         [15]  503 	sbc    hl,bc
   0EC1 30 05         [12]  504 	jr     nc, disk_init_spin_ok               ; if less, its good - disk is spinning fast
   0EC3 15            [ 4]  505 	dec    d                                   ; else, try again, looping on d (outer loop)
   0EC4 20 C2         [12]  506 	jr     nz,disk_initialise_loop
   0EC6 18 0E         [12]  507 	jr     disk_initialise_error
                            508 
   0EC8                     509 disk_init_spin_ok:
   0EC8 CD 8B 0C      [17]  510 	call	fdc_setup
   0ECB 20 09         [12]  511 	jr	nz,disk_initialise_error
                            512 
   0ECD CD D0 0D      [17]  513 	call	calibrate_and_seek_to_track_0
   0ED0 38 04         [12]  514 	jr	c,disk_initialise_error
                            515 
   0ED2                     516 disk_initialise_exit:  
   0ED2 E1            [10]  517 	pop	hl
   0ED3 D1            [10]  518 	pop	de
   0ED4 C1            [10]  519 	pop	bc
   0ED5 C9            [10]  520 	ret
                            521 
   0ED6                     522 disk_initialise_error:
   0ED6 37            [ 4]  523 	scf                                          ; set carry = 1
   0ED7 18 F9         [12]  524 	jr	disk_initialise_exit                      ; return
                            525 
                            526 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 75.
Hexadecimal [16-Bits]



                              2 
                              3 ;--------------------------------------------------------------
                              4 ;--------------------------------------------------------------
   0ED9                       5 FDC_INTERRUPT:
                              6 ;--------------------------------------------------------------
                              7 ;--------------------------------------------------------------
                              8 ;       if the drive is active, then skip the motor timing routine
                              9 
   0ED9 3A D2 FA      [13]   10 	LD	A,(FDC_MOTOR_ACT)       ;drive activity flag
   0EDC B7            [ 4]   11         OR	A               	;is any drive active?
   0EDD C0            [11]   12         RET	NZ
                             13 
   0EDE 3A D3 FA      [13]   14         LD      A,(FDC_MOTOR_CNT)	;get count to turn drive off
   0EE1 B7            [ 4]   15         OR      A               	;is it zero?
   0EE2 C8            [11]   16         RET	Z
                             17 
   0EE3 3D            [ 4]   18         DEC     A               	;dec counter
   0EE4 20 04         [12]   19         JR      NZ, FDC_INT_X        	;jump if not zero
   0EE6 CD E1 0D      [17]   20 	call	fdc_stop_disk
   0EE9 AF            [ 4]   21         XOR     A               	;A=0
   0EEA                      22 FDC_INT_X:  
   0EEA 32 D3 FA      [13]   23 	LD      (FDC_MOTOR_CNT),A       ;store in variable
   0EED C9            [10]   24 	RET
                             25 
                             26 
   0EEE                      27 FDC_RESET_AND_SPIN:
   0EEE CD 03 0E      [17]   28 	call	fdc_motor_req_on	; FORCE MOTOR TO STAY ON
   0EF1 18 06         [12]   29 	jr	FDC_RESET2
                             30 	
                             31 ;-----------------------------------
   0EF3                      32 FDC_RESET::
                             33 ;-----------------------------------
   0EF3 CD E1 0D      [17]   34 	call	fdc_stop_disk
   0EF6 CD 24 0D      [17]   35 	call	sf7k_reset
                             36 
   0EF9                      37 FDC_RESET2::
   0EF9 AF            [ 4]   38 	xor	a
   0EFA 32 D3 FA      [13]   39 	ld	(FDC_MOTOR_CNT), a
   0EFD 32 D2 FA      [13]   40 	ld	(FDC_MOTOR_ACT), a
                             41 
   0F00 6F            [ 4]   42 	ld	l, a
   0F01 67            [ 4]   43 	ld	h, a
   0F02 22 D6 FA      [16]   44 	ld	(FDC_TRK), hl
   0F05 22 D8 FA      [16]   45 	ld	(FDC_SEC), hl
   0F08 2B            [ 6]   46 	dec	hl
   0F09 22 DA FA      [16]   47 	ld	(FDC_CACHE_TAG), hl				; DEFAULT CACHE TAG = 0xFFFF
                             48 	
   0F0C 21 00 FF      [10]   49 	ld	hl, #FDC_BUF_0
   0F0F 22 DC FA      [16]   50 	ld	(FDC_BUFPTR), hl
                             51 
   0F12 21 80 00      [10]   52 	ld	hl, #0x0080
   0F15 22 DE FA      [16]   53 	ld	(FDC_DMAPTR), hl
   0F18 C9            [10]   54 	ret
                             55 
                             56 ;-----------------------------------
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 76.
Hexadecimal [16-Bits]



   0F19                      57 FDC_HOME::	
                             58 ;-----------------------------------
   0F19 01 00 00      [10]   59 	LD	bc, #0				; Select track zero
                             60 ;-----------------------------------
   0F1C                      61 FDC_SETTRK::
                             62 ;-----------------------------------
   0F1C ED 43 D6 FA   [20]   63 	ld	(FDC_TRK), bc			; Store track
   0F20 C9            [10]   64 	ret
                             65 ;-----------------------------------
   0F21                      66 FDC_SETSEC::
                             67 ;-----------------------------------
   0F21 ED 43 D8 FA   [20]   68 	ld	(FDC_SEC), bc			; Store sector
   0F25 C9            [10]   69 	ret
                             70 ;-----------------------------------
   0F26                      71 FDC_SETDMA::
                             72 ;-----------------------------------
   0F26 ED 43 DE FA   [20]   73 	ld	(FDC_DMAPTR),bc			; Set DMA address
   0F2A C9            [10]   74 	ret
                             75 
                             76 		
                             77 
                             78 ; ================================================
   0F2B                      79 FDC_READ::	
                             80 ; ================================================
   0F2B CD 5F 0F      [17]   81 	call	FDC_TRY_READ_CACHE
   0F2E CD 49 0F      [17]   82 	call	FDC_COPY_TO_DMA
   0F31 AF            [ 4]   83 	xor	a						; No checking for errors!
   0F32 C9            [10]   84 	ret
                             85 
                             86 ; ================================================
   0F33                      87 FDC_WRITE::	
                             88 ; ================================================
   0F33 CD 5F 0F      [17]   89 	call	FDC_TRY_READ_CACHE
   0F36 CD 52 0F      [17]   90 	call	FDC_COPY_FROM_DMA				; update data to buffer
                             91 		
   0F39 ED 4B DA FA   [20]   92 	ld	bc, (FDC_CACHE_TAG)	
   0F3D 04            [ 4]   93 	inc	b						; BC  = SEC|TRK	(SEC: 0-15 => 1-16)
   0F3E ED 5B DC FA   [20]   94 	ld	de, (FDC_BUFPTR)
                             95 	
   0F42 F3            [ 4]   96 	di
   0F43 CD 0F 0E      [17]   97 	call	fdc_writesector					; write it to floppy!
   0F46 FB            [ 4]   98 	ei
                             99 
   0F47 AF            [ 4]  100 	xor	a						; No checking for errors!
   0F48 C9            [10]  101 	ret
                            102 
                            103 
                            104 
                            105 
                            106 ;-----------------------------------
   0F49                     107 FDC_COPY_TO_DMA:
                            108 ;-----------------------------------
   0F49 2A DE FA      [16]  109 	ld	hl,(FDC_DMAPTR)					; LOAD HL WITH DMA ADDRESS
   0F4C EB            [ 4]  110 	ex	de, hl
   0F4D 2A DC FA      [16]  111 	ld	hl,(FDC_BUFPTR)					; GET RAM ADDRESS TO COPY
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 77.
Hexadecimal [16-Bits]



   0F50 18 07         [12]  112 	jr	copy_128_bytes
                            113 ;-----------------------------------
   0F52                     114 FDC_COPY_FROM_DMA:
                            115 ;-----------------------------------
   0F52 2A DC FA      [16]  116 	ld	hl,(FDC_BUFPTR)					; LOAD HL WITH DMA ADDRESS
   0F55 EB            [ 4]  117 	ex	de, hl
   0F56 2A DE FA      [16]  118 	ld	hl,(FDC_DMAPTR)					; GET RAM ADDRESS TO COPY
   0F59                     119 copy_128_bytes:
   0F59 01 80 00      [10]  120 	ld	BC,#128						; BC IS COUNTER FOR FIXED SIZE TRANSFER (128 BYTES)
   0F5C ED B0         [21]  121 	ldir
   0F5E C9            [10]  122 	ret
                            123 
                            124 
                            125 
                            126 ; 1 2 3 4 5 6 7 8 9 A B C D E F G
                            127 ; 0 1 2 3 4 5 6 7 8 9 A B C D E F
                            128 ; 0 0 1 1 2 2 3 3 4 4 5 5 6 6 7 7 
                            129 ; 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 
                            130 		
                            131 		
                            132 ; ================================================
   0F5F                     133 FDC_TRY_READ_CACHE:
                            134 ; ================================================
                            135 	; *** build tag
   0F5F 3A D6 FA      [13]  136 	ld	a,(FDC_TRK)
   0F62 4F            [ 4]  137 	ld	c, a				; c = TRACK
                            138 
   0F63 11 00 FF      [10]  139 	ld	de, #FDC_BUF_0
   0F66 3A D8 FA      [13]  140 	ld	a,(FDC_SEC)			; CPM SECTOR (1-16)
   0F69 3D            [ 4]  141 	dec	a				; TRANSFORM 1-16 => 0-15
   0F6A CB 3F         [ 8]  142 	srl	a				; sec >>= 1, CF = sec & 1
   0F6C 30 03         [12]  143 	jr	nc, IDE_SEL_BLOCK_0
                            144 
   0F6E 11 80 FF      [10]  145 	ld	de, #FDC_BUF_1			; if (CF) PHYBUFFER = PHYBUF_1;
                            146 
   0F71                     147 IDE_SEL_BLOCK_0: 
   0F71 ED 53 DC FA   [20]  148 	ld	(FDC_BUFPTR),de			; BUFFER ADDRESS
   0F75 47            [ 4]  149 	ld	b, a				; b = SECTOR - 1 (0-15)
                            150 	
                            151 	; *** compare tags
   0F76 2A DA FA      [16]  152 	ld	hl, (FDC_CACHE_TAG)		; get old tag
   0F79 ED 43 DA FA   [20]  153 	ld	(FDC_CACHE_TAG),bc		; store new tag
   0F7D B7            [ 4]  154 	or	a				; clear CF
   0F7E ED 42         [15]  155 	sbc	hl,bc
   0F80 C8            [11]  156 	ret	z				; IS ALREADY IN CACHE, DO NOTHING
                            157 	
                            158 	; *** read from floppy
   0F81 04            [ 4]  159 	inc	b				; BC  = SEC|TRK	(SEC: 0-15 => 1-16)
   0F82 11 00 FF      [10]  160 	ld	de, #FDC_BUF_0			; DST = read 256 bytes from disk
                            161 
   0F85 F3            [ 4]  162 	di
   0F86 CD 48 0D      [17]  163 	call	fdc_readsector
   0F89 FB            [ 4]  164 	ei
                            165 
   0F8A C9            [10]  166 	ret
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 78.
Hexadecimal [16-Bits]



                            167 
                            168 		
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 79.
Hexadecimal [16-Bits]



                            176 
                            177 
                            178 ;BIOS_END_S:	.ascii "END."
   0F8B                     179 BIOS_END:
                            180 
                            181 
                            182 ;-------------------------------------------
                            183 ; SCB AREA
                            184 ;-------------------------------------------
                            185 ;.area HEADER (ABS)
                            186 .area	_SCB	(ABS)									; 0xFC00 - 0xFFFF
                            187 	
                            188 ; ==================================================
                            189 
                            190 ;* FDC
                            191 ;.org	0xFA00
                            192 
                            193 
                            194 ; * KEYBOARD
   FA80                     195 .org	0xFA80
                            196 ; --- 92 bytes
   FA80                     197 fdc_command_loop_counter::	.ds 1    ; 0xfc00 ; used for counting retries on fdc comands
   FA81                     198 fdc_command_loop_counter_2::	.ds 1    ; 0xfc01 ; used for counting inner loops on fdc comands
   FA82                     199 fdc_command_data_buffer::	.ds 9  	; 0xfc02 ; 9 bytes .. 0xfc0a
   FA8B                     200 fdc_command_result_buffer::	.ds 7	; 0xfc0b ; 0-7 bytes .. 0xfc11 depending on command
   FA92                     201 fdc_format_buffer::		.ds 64	; 0xfc12 ; 64 bytes .. 0xfc51
                            202 
   FAD2                     203 FDC_MOTOR_ACT:			.ds 1
   FAD3                     204 FDC_MOTOR_CNT:			.ds 1
   FAD4                     205 FDC_TIME:			.ds 2
   FAD6                     206 FDC_TRK:			.ds 2
   FAD8                     207 FDC_SEC:			.ds 2
   FADA                     208 FDC_CACHE_TAG:			.ds 2
   FADC                     209 FDC_BUFPTR:			.ds 2
   FADE                     210 FDC_DMAPTR:			.ds 2
                            211 
                            212 
                            213 
                            214 ; * KEYB & CURSOR
   FB00                     215 .org	0xFB00
                            216 ; --- 53 bytes
   FB00                     217 KEYBD_BUFFER:			.ds 32		; <<< 256 BYTES ALIGNED!!!
   FB20                     218 KEYBD_PUTPNT:			.ds 2
   FB22                     219 KEYBD_GETPNT:			.ds 2
   FB24                     220 keyboard_input_buffer::        	.ds 12		; 9 bytes .. 0xfc5e - first 7 bytes are low bytes of rasters, 8th is high bits, 9th is remaining control keys
   FB30                     221 keyboard_last_char::		.ds 2
   FB32                     222 keyboard_typematic_cnt::	.ds 2
   FB34                     223 keyboard_diff_char::		.ds 1
   FB35                     224 keyboard_int_counter::		.ds 1
                            225 
                            226 ; --- 17 bytes
   FB36                     227 cursor_insert_mode::		.ds 1
   FB37                     228 cursor_enabled::		.ds 1
   FB38                     229 cursor_visible_ff::		.ds 1
   FB39                     230 cursor_char_saved::		.ds 1
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 80.
Hexadecimal [16-Bits]



   FB3A                     231 cursor_char_data_saved::	.ds 8
   FB42                     232 write_char_value::		.ds 1		; char being written to the screen
   FB43                     233 cursor_visible_cnt::		.ds 2
   FB45                     234 cursor_x::                     	.ds 1		; cursor x position (0-39)
   FB46                     235 cursor_y::                     	.ds 1		; cursor y position (0-23)
                            236 
                            237 
   FC00                     238 .org	0xFC00
   FC00                     239 vram_copy_buffer::             	.ds 256		; <<< 256 BYTES ALIGNED!!!
                            240 
                            241 
                            242 ; * STACK2 (256 bytes)
   FD00                     243 .org	0xFD00
   FD00                     244 DIRBF:				.ds	128	; 128-byte buffer
   FD80                     245 B_CSV:				.ds	16	; CKS bytes...
   FD90                     246 B_ALV:				.ds	40	; Allocation vector = 2 * ((DSM / 8) + 1) 
                            247 ;saved_stack_ptr::		.ds 2
                            248 ;temp_stack::                   	.ds 253	; 0xFD00-0xFEFF
                            249 ;temp_top_of_stack::            	.ds 1
                            250 
                            251 ; * STACK1 (256 bytes)
   FE00                     252 .org	0xFE00
   FE00                     253 bios_stack::                    .ds 239	; 0xFD00-0xFFEF
   FEEF                     254 top_of_stack::                 	.ds 1
                            255 
   FEF0                     256 FRAMES1:			.ds 2	; 0xFEF0
   FEF2                     257 FRAMES3:			.ds 1	; 0xFEF2
   FEF3                     258 bios_vars:			.ds 13	
                            259 
   FF00                     260 .org	0xFF00
   FF00                     261 FDC_BUF_0::			.ds 128			; 128-byte buffer
   FF80                     262 FDC_BUF_1::			.ds 128			; 128-byte buffer
                            263 
                            264 
                            265 ;BIOS_END:			.ascii "END]"
                            266 
                            267 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 81.
Hexadecimal [16-Bits]



                            237 
                            238 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 82.
Hexadecimal [16-Bits]

Symbol Table

    .__.$$$.=  2710 L   |     .__.ABS.=  0000 G   |     .__.CPU.=  0000 L
    .__.H$L.=  0000 L   |     ASC_BS  =  0008     |     ASC_CLS =  000C 
    ASC_CR  =  000D     |     ASC_FF  =  000C     |     ASC_HOME=  000B 
    ASC_LF  =  000A     |     ASC_SP  =  0020     |   0 BASE       0033 R
    BDOS    =  0005     |     BDOS0   =  DC00     |   0 BDOS_LOA   0084 R
    BIOS    =  EA00     |   0 BIOS_BOO   0154 R   |   0 BIOS_END   0F8B R
  0 BIOS_INI   017D GR  |   0 BOOT       0000 R   |     BS      =  0008 
  5 B_ALV      FD90 R   |   5 B_CSV      FD80 R   |   0 B_DPB      0145 R
    CCP     =  D300     |   0 CCP_LOAD   0092 R   |   0 COLDBOOT   0154 R
  0 CONIN      0009 R   |   0 CONOUT     000C R   |   0 CONST      0006 R
    CONTROL =  0000     |   0 CP_HLDE    0C1D R   |     CR      =  000D 
    CURSOR_A=  0090     |     DATA    =  0001     |   5 DIRBF      FD00 R
  0 DPH        0135 R   |     FCB     =  005C     |   2 FDC_BUFP   FADC R
  7 FDC_BUF_   FF00 GR  |   7 FDC_BUF_   FF80 GR  |   2 FDC_CACH   FADA R
  0 FDC_COPY   0F52 R   |   0 FDC_COPY   0F49 R   |   2 FDC_DMAP   FADE R
  0 FDC_HOME   0F19 GR  |   0 FDC_INTE   0ED9 R   |   0 FDC_INT_   0EEA R
  2 FDC_MOTO   FAD2 R   |   2 FDC_MOTO   FAD3 R   |     FDC_MOTO   **** X
  0 FDC_READ   0F2B GR  |   0 FDC_RESE   0EF3 GR  |   0 FDC_RESE   0EF9 GR
  0 FDC_RESE   0EEE R   |   2 FDC_SEC    FAD8 R   |   0 FDC_SETD   0F26 GR
  0 FDC_SETS   0F21 GR  |   0 FDC_SETT   0F1C GR  |   2 FDC_TIME   FAD4 R
  2 FDC_TRK    FAD6 R   |   0 FDC_TRY_   0F5F R   |   0 FDC_WAIT   0D1A R
  0 FDC_WAIT   0D11 R   |   0 FDC_WAIT   0D1B R   |   0 FDC_WRIT   0F33 GR
    FF      =  000C     |   6 FRAMES1    FEF0 R   |   6 FRAMES3    FEF2 R
  0 IDE_SEL_   0F71 R   |     IOBYTE  =  0003     |   0 Int38h     01B4 R
  0 JBOOT      00A5 R   |   0 JCONIN     011C R   |   0 JCONOUT    0120 R
  0 JCONST     0113 R   |   0 JLST       012C R   |   0 JPRSTAT    012C R
  0 JPUNCH     012C R   |   0 JREADER    0126 R   |   0 JSECTRN    0129 R
  0 JSELDSK    012E R   |   0 JWBOOT     00EC R   |   3 KEYBD_BU   FB00 R
  3 KEYBD_GE   FB22 R   |   3 KEYBD_PU   FB20 R   |   0 KEYB_BUF   0C5E GR
  0 KEYB_BUF   0C16 R   |   0 KEYB_REA   0AF5 GR  |   0 KEYB_REA   0AB2 GR
  0 KEYB_REA   0ABC R   |   0 KEYB_REA   0AE4 R   |   0 KEYB_WAI   0C74 GR
  0 KEYB_WRA   0C23 R   |     LF      =  000A     |   0 LIST       000F R
  0 NOINC3     01D8 R   |   0 OS_INFO    003B R   |   0 PPI_LONG   0A75 R
  0 PPI_PAUS   0A6D R   |   0 PRSTAT     002D R   |   0 PUNCH      0012 R
  0 READ       0027 R   |   0 READER     0015 R   |     RESET   =  0000 
  0 SECTRN     0030 R   |     SECTS_PE=  0010     |     SECTS_SI=  0100 
  0 SELDSK     001B R   |   0 SETDMA     0024 R   |   0 SETSEC     0021 R
  0 SETTRK     001E R   |     SP      =  0020     |     STACK   =  8FFF 
    STATUS  =  0000     |   0 TEXT_CLE   09CB R   |   0 TEXT_COO   09EE R
  0 TEXT_CUR   09BF GR  |   0 TEXT_CUR   09AE GR  |   0 TEXT_CUR   09B0 R
  0 TEXT_CUR   095A GR  |   0 TEXT_CUR   09EB R   |   0 TEXT_CUR   099B R
  0 TEXT_INS   094A GR  |   0 TEXT_INS   0949 GR  |   0 TEXT_INS   0945 GR
  0 TEXT_PUT   094E GR  |   0 TRACK0     0018 R   |   0 VALID_CH   084E R
  0 WBOOT      0003 R   |   0 WRITE      002A R   |   6 bios_sta   FE00 GR
  6 bios_var   FEF3 R   |   0 calc_coo   0A07 R   |   0 calc_coo   0A01 R
  0 calc_cur   093E R   |   0 calibrat   0DD0 R   |   0 clear_li   092B R
  0 clear_sc   09D4 R   |   0 clr_line   092F R   |   0 conio_re   078F GR
  0 conio_wr   07AA GR  |   0 conio_wr   0806 GR  |   0 conio_wr   0793 GR
  0 copy_128   0F59 R   |   0 cpSB1      03C5 R   |   0 cpSB2      037D R
  0 cpSX1      03DB R   |   0 cpSX2      03A5 R   |   0 cpSXX1     03DE R
  0 cpSXX2     03B5 R   |   3 cursor_c   FB3A GR  |   3 cursor_c   FB39 GR
  0 cursor_d   07D4 R   |   0 cursor_d   07CA R   |   0 cursor_d   07FC R
  0 cursor_d   07F2 R   |   3 cursor_e   FB37 GR  |   0 cursor_i   07C0 R
  0 cursor_i   07B6 R   |   0 cursor_i   07E8 R   |   0 cursor_i   07DE R
  3 cursor_i   FB36 GR  |   3 cursor_v   FB43 GR  |   3 cursor_v   FB38 GR
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 83.
Hexadecimal [16-Bits]

Symbol Table

  3 cursor_x   FB45 GR  |     cursor_x=  0000     |   3 cursor_y   FB46 GR
    cursor_y=  0000     |   0 delete_c   08CC R   |   0 disk_ini   0E8B R
  0 disk_ini   0E9B R   |   0 disk_ini   0E84 R   |   0 disk_ini   0EBB R
  0 disk_ini   0E98 R   |   0 disk_ini   0EA8 R   |   0 disk_ini   0EC8 R
  0 disk_ini   0EAB R   |   0 disk_ini   0E6E GR  |   0 disk_ini   0ED6 R
  0 disk_ini   0ED2 R   |   0 disk_ini   0E88 R   |   0 disk_res   0E68 GR
  0 el         0175 R   |   2 fdc_comm   FA82 GR  |     fdc_comm=  000D 
  2 fdc_comm   FA80 GR  |   2 fdc_comm   FA81 GR  |     fdc_comm=  0040 
    fdc_comm=  0080     |     fdc_comm=  0020     |     fdc_comm=  0006 
    fdc_comm=  000C     |     fdc_comm=  0002     |     fdc_comm=  000A 
    fdc_comm=  0007     |   2 fdc_comm   FA8B GR  |     fdc_comm=  0011 
    fdc_comm=  001E     |     fdc_comm=  0019     |     fdc_comm=  000F 
    fdc_comm=  0004     |     fdc_comm=  0008     |     fdc_comm=  0003 
    fdc_comm=  0005     |     fdc_comm=  0009     |     fdc_data=  00E1 
  2 fdc_form   FA92 GR  |   0 fdc_moto   0DFE R   |   0 fdc_moto   0DED R
  0 fdc_moto   0DF5 R   |   0 fdc_moto   0E03 R   |   0 fdc_read   0D48 GR
  0 fdc_read   0D52 GR  |   0 fdc_read   0D2C GR  |     fdc_rese   **** X
  0 fdc_setu   0C8B R   |   0 fdc_spec   0C94 R   |   0 fdc_spec   0C97 R
    fdc_stat=  00E0     |     fdc_stat=  00C0     |   0 fdc_stop   0DE1 GR
  0 fdc_wait   0CBA R   |   0 fdc_writ   0E0F GR  |   0 fdc_writ   0E19 GR
  0 fill_and   0CC3 R   |   0 fill_fdc   0C97 R   |   0 fill_fdc   0CF0 R
  0 fill_fdc   0D0A R   |   0 fill_fdc   0D04 R   |   0 fill_fdc   0CFE R
  0 fill_fdc   0CB4 R   |   0 fill_mem   01A0 R   |   0 flush_fd   0CE7 R
  0 font_dat   0420 GR  |   0 font_dat   078F GR  |     font_tem=  1000 
    fore_bac=  001E     |   0 getBit_1   0249 R   |   0 getGamma   0256 R
  0 getGamma   0255 R   |   0 getGamma   0263 R   |   0 getGamma   026A R
  0 getGamma   0268 R   |   0 getGamma   025B R   |   0 insert_a   08DE R
  0 int_end    01DE R   |   0 invert_l   0987 R   |   0 j_nokey    011B R
  0 kbd_rese   0BFC GR  |   3 keyboard   FB34 GR  |   3 keyboard   FB24 GR
  3 keyboard   FB35 GR  |   0 keyboard   0C2B GR  |   3 keyboard   FB30 GR
  3 keyboard   FB32 GR  |   0 newKeyIn   0C7D R   |   0 noAddRow   0911 R
  0 noResetT   0C3C R   |   0 no_inser   0863 R   |   0 notypema   0C43 R
  0 output_n   0DBB R   |   0 pause_1m   0A1D R   |   0 pause_fo   0AF2 R
  0 ppi_init   0A68 R   |   0 ppi_p1_l   0A6E R   |   0 psg_beep   0A41 R
  0 psg_beep   0A37 R   |   0 psg_beep   0A3B R   |   0 psg_beep   0A3F R
  0 psg_beep   0A42 R   |   0 psg_beep   0A62 R   |     psg_port=  007F 
  0 psg_rese   0A18 GR  |   0 psg_rese   0A1B R   |   0 r_key_ad   0B16 R
  0 r_key_ad   0B2D R   |   0 r_key_en   0B2F R   |   0 r_key_fo   0B06 R
  0 r_key_lo   0AFB R   |   0 r_key_lo   0B0F R   |   0 read_fro   0D7A R
  0 read_fro   0D7C R   |   0 read_fro   0D64 R   |   0 read_fro   0D5A R
  0 read_set   0D2F R   |   0 read_tra   0D81 R   |   0 read_vdp   02E7 GR
  0 return_c   0DCC R   |   0 sc3000_p   0A80 R   |     sc_ppi_a=  00DC 
    sc_ppi_b=  00DD     |     sc_ppi_c=  00DE     |     sc_ppi_c=  00DF 
    screen_c=  0028     |     screen_r=  0018     |   0 screen_s   091D R
  0 seek_tra   0DAA R   |   0 set_vram   02F4 GR  |   0 set_vram   030A GR
  0 set_vram   0307 GR  |   0 setup_vd   026F R   |   0 setup_vd   02C0 R
  0 setup_vd   02D3 R   |   0 setup_vd   02AC R   |   0 sf7000_p   0AA1 R
    sf7_ppi_=  00E4     |     sf7_ppi_=  00E5     |     sf7_ppi_=  00E6 
    sf7_ppi_=  00E7     |   0 sf7k_res   0D24 R   |   0 sf7k_res   0D25 R
  0 table_ct   0B3C R   |   0 table_sh   0B7C R   |   0 table_un   0BBC R
  0 tm_samec   0C59 R   |   6 top_of_s   FEEF GR  |   0 try_raw_   0D93 R
  0 try_raw_   0D99 R   |   0 unPack_1   01F3 GR  |   0 unPack_l   01F8 R
  0 unPack_o   0203 R   |   0 unPack_o   01FF R   |   0 unPack_o   0224 R
  0 unPack_o   0208 R   |   0 unPack_o   0238 R   |   0 v2v_loop   03FA R
  0 v2v_loop   0410 R   |     vdp_cont=  00BF     |     vdp_data=  00BE 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 84.
Hexadecimal [16-Bits]

Symbol Table

  0 vdp_fill   0356 R   |   0 vdp_fill   0361 R   |   0 vdp_int_   02E7 GR
  0 vdp_ram2   033A R   |   0 vdp_ram2   0345 R   |   0 vdp_set_   02EA GR
    vdp_tile=  1800     |     vdp_tile=  0800     |     vdp_tile=  0800 
    vdp_tile=  03C0     |   0 vdp_vide   026D GR  |   0 vdp_vram   031E GR
  0 vdp_vram   0329 R   |   0 vdp_vram   03E5 GR  |   0 vdp_vram   03BC GR
  0 vdp_vram   036C R   |   4 vram_cop   FC00 GR  |   0 wait_and   0317 GR
  0 wait_and   02FF GR  |   0 wait_bit   0CCD R   |   0 write_25   0E51 R
  0 write_25   0E57 R   |   0 write_CR   086F R   |   0 write_LF   087C R
  0 write_ba   08B2 R   |   0 write_ba   08C7 R   |   0 write_ba   08B7 R
  0 write_ch   08D7 R   |   3 write_ch   FB42 GR  |   0 write_cu   08A6 R
  0 write_cu   0896 R   |   0 write_cu   08A0 R   |   0 write_cu   089B R
  0 write_fo   088D R   |   0 write_ne   0877 R   |   0 write_ne   0882 R
  0 write_se   0E3F R   |   0 write_te   0798 R   |   0 write_te   07A4 R
  0 write_to   0E32 R   |   0 write_to   0E38 R   |   0 write_to   0E3A R
  0 write_to   0E26 R   |   0 write_to   0E2D R   |   0 write_to   0CC8 R
  0 write_to   0CC6 R   |   0 write_to   0CE1 R   |   0 write_to   0CD3 R

ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 85.
Hexadecimal [16-Bits]

Area Table

   0 _CODE      size  F8B   flags    0
   1 _SCB       size    0   flags    8
   2 _SCB0      size   60   flags    8
   3 _SCB1      size   47   flags    8
   4 _SCB2      size  100   flags    8
   5 _SCB3      size   B8   flags    8
   6 _SCB4      size  100   flags    8
   7 _SCB5      size  100   flags    8

